<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-02-27 Tue 12:24 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>stormrider.io</title>
<meta name="author" content="bill" />
<meta name="generator" content="Org Mode" />
</head>
<body>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgabdabc6">Who am I?</a>
<ul>
<li><a href="#org9963fc9">A geek</a></li>
<li><a href="#org45e4a7d">A principled person</a></li>
<li><a href="#org7e50a1a">A lifelong UNIX nerd</a></li>
<li><a href="#orgcd8a260">A lifelong EMACS nerd</a></li>
<li><a href="#orgc208055">A former white-hat phreaker</a>
<ul>
<li><a href="#orga3fe4f2">Intercept numbers</a></li>
<li><a href="#org21ae93f">Fun lines</a></li>
</ul>
</li>
<li><a href="#orgd539a87">A very early IRC user</a></li>
<li><a href="#org9a79816">A .org domain archaeologist</a></li>
</ul>
</li>
<li><a href="#orgf7df181">What do I do?</a>
<ul>
<li><a href="#org71791ee">I explain hard things</a>
<ul>
<li><a href="#orgbc6d0a4">MAAS deployment process</a></li>
<li><a href="#org4bb4afd">MAAS image anatomy</a>
<ul>
<li><a href="#orge661dcc"><i>What's in a stream?</i></a></li>
<li><a href="#org1cee166"><i>What else do we need?</i></a></li>
<li><a href="#orgfe43a29"><i>What an image contains</i></a></li>
<li><a href="#org7e55faa"><i>How the rack controller lays it down on disk</i></a></li>
<li><a href="#org4afa877"><i>Image directory</i></a>
<ul>
<li><a href="#orge3955c1">The bootloader</a></li>
<li><a href="#org4efb938">open-firmware/ppc64el/bootppc64.bin</a></li>
<li><a href="#org6b30187">pxe/i386</a></li>
<li><a href="#org666c123">uefi</a></li>
</ul>
</li>
<li><a href="#orgd51c724"><i>centos</i></a></li>
<li><a href="#orgdd9e1dd"><i>Links to commonly used files</i></a></li>
</ul>
</li>
<li><a href="#org7d6fb50">Linux kernel block diagrams</a>
<ul>
<li><a href="#orgbeb83ac"><i>User space</i></a></li>
<li><a href="#orgb260799"><i>Kernel space</i></a></li>
<li><a href="#orge332b28"><i>File system management</i></a></li>
<li><a href="#org0e1160d"><i>inodes</i></a></li>
<li><a href="#orgc6c924d"><i>Process control and scheduling</i></a></li>
<li><a href="#org06d3fee"><i>Process management</i></a></li>
</ul>
</li>
<li><a href="#org9d7a505">MAAS CLI</a>
<ul>
<li><a href="#orga14f2c8">Installing MAAS</a>
<ul>
<li><a href="#orge5b7456">Production postgres</a></li>
<li><a href="#org2aa8f60">Initialising MAAS</a></li>
</ul>
</li>
<li><a href="#orgbc8b727">Configuring MAAS</a>
<ul>
<li><a href="#org29ec9ac">Logging in</a></li>
<li><a href="#orgf52d93a">Getting real help</a></li>
<li><a href="#org1115e40">Setting dns</a></li>
<li><a href="#orgeca211a">Importing images</a></li>
<li><a href="#orga37f54d">Enter jq</a></li>
</ul>
</li>
<li><a href="#org967e01d">Enabling DHCP</a></li>
<li><a href="#orgda81b96">Commissioning machines</a></li>
<li><a href="#org83197a3">Deploying machines</a>
<ul>
<li><a href="#orgfc45915">Acquiring a machine using the CLI</a></li>
<li><a href="#org660f49c">Deploying a machine with the CLI</a></li>
</ul>
</li>
<li><a href="#org22568fd">jq tricks</a>
<ul>
<li><a href="#orge988ccc">Basic jq usage</a></li>
<li><a href="#org9f41cf0">Improved formatting</a></li>
<li><a href="#org680ae36">Making real tables</a></li>
<li><a href="#orga5c07f9">Extending the list</a></li>
<li><a href="#org21cea15">Nested arrays</a></li>
<li><a href="#org9c791bf">Nested keys</a></li>
<li><a href="#org2279378">Chaining Ubuntu CLI commands</a></li>
</ul>
</li>
<li><a href="#org8b93ab2">SSH/SCP with MAAS machines</a>
<ul>
<li><a href="#org755f3ce">Create a KVM</a></li>
<li><a href="#org1c5696f">Composing a machine</a></li>
<li><a href="#orgc92ca72">Getting the machine to a login state</a></li>
<li><a href="#orgadc3948">Logging into a commissioned machine</a></li>
<li><a href="#orgcf9fa0b">Using SCP</a></li>
<li><a href="#org388258d">Copying files to a deployed machine</a></li>
<li><a href="#orgb9fa887">Copying a script over there and running it</a></li>
</ul>
</li>
<li><a href="#org03b8a0b">More neat jq things</a>
<ul>
<li><a href="#org7fe435c">Sorting natively with jq</a></li>
<li><a href="#org82167c3">jq is not UNIX (jqNU?)</a></li>
<li><a href="#org4265b09">So how does "sortby()" work?</a></li>
<li><a href="#org61af7c5">Checking our work</a></li>
<li><a href="#orgb67a162">Sorting by more than one parameter</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org68934e6">Networking tutorial</a>
<ul>
<li><a href="#orgdb25c19">About networking</a></li>
<li><a href="#org4b88ad1">Channels of sharing are complicated</a></li>
<li><a href="#orgc54223c">Adversarial beginnings</a></li>
<li><a href="#org28db3cc">Focusing on architecture</a>
<ul>
<li><a href="#orga2845d4">Network architecture</a></li>
<li><a href="#org25f7f0f">The AAC network model</a></li>
<li><a href="#orgd006907">Yesterday’s phone network is today’s Internet</a></li>
<li><a href="#org1328a08">The Internet infrastructure</a></li>
<li><a href="#org15688a0">About Internet network traffic</a></li>
</ul>
</li>
<li><a href="#org3a29fe1">The OSI model</a>
<ul>
<li><a href="#org073cf04">The physical layer (L1)</a></li>
<li><a href="#org1c9cd66">The datalink layer (L2)</a></li>
<li><a href="#org4d422c0">Interlayer addressing: ARP</a></li>
<li><a href="#orgcbe22b1">The network layer</a></li>
<li><a href="#orga2172b7">The transport layer</a></li>
<li><a href="#orgc612ba2">TCP: Transmission Control Protocol</a></li>
<li><a href="#org0e23dc2">The session layer</a></li>
<li><a href="#org0fed121">The presentation layer</a></li>
<li><a href="#org77b04b6">The application layer</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8e002bb">I build my own electronics</a>
<ul>
<li><a href="#org6f44cf8">Altair 8800</a>
<ul>
<li><a href="#orgd7cf4f9">The first attempt</a></li>
<li><a href="#orgffd73b9">Lessons learned</a></li>
<li><a href="#org1c3aa57">Early building steps</a></li>
</ul>
</li>
<li><a href="#org08d4119">rPi4</a>
<ul>
<li><a href="#org36902b0">The rPi4 and a HackRF One SDR receiver</a></li>
<li><a href="#orgcc6845d">Breakout board and ribbon cable</a></li>
<li><a href="#org7ca19f5">Companion SDR kit</a></li>
<li><a href="#org2335a73">Other useful project parts</a>
<ul>
<li><a href="#org03d2eb2">Boot media for the rPi:</a></li>
<li><a href="#orgd088ddc">Jumper wires for the rPi4:</a></li>
<li><a href="#org1825cf3">An on-off switch for the rPi4</a></li>
<li><a href="#orgef11f0e">A small set of electronic components</a></li>
</ul>
</li>
<li><a href="#org1033bd4">Extra components</a>
<ul>
<li><a href="#orgbae3bc8">Some small circuit boards</a></li>
<li><a href="#orgacf70ec">Some assorted standard capacitors</a></li>
<li><a href="#org3cc5240">Some assorted diodes</a></li>
<li><a href="#org793722a">A whole bunch of assorted LED in various sizes</a></li>
<li><a href="#org3655b9b">Assorted rheostats</a></li>
<li><a href="#orgb194ad8">A ton of assorted resistors</a></li>
<li><a href="#org259173e">Various assorted transistors</a></li>
<li><a href="#org49f9545">And lastly, a metric ton of variable length wires</a></li>
</ul>
</li>
<li><a href="#org1c32aec">A lot can be had for a little</a></li>
<li><a href="#orgd34c535">How I put the Pi together initially</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
My name is Bill Wear. I go by the handle <a href="mailto:stormrider.io@proton.me">stormrider</a>. This is my personal website.
</p>

<p>
<i>Note: TOC items at left expand on click, when there are subheads</i>
</p>

<div id="outline-container-orgabdabc6" class="outline-2">
<h2 id="orgabdabc6">Who am I?</h2>
<div class="outline-text-2" id="text-orgabdabc6">
<p>
I am stormrider. I am a geek; a principled person; a lifelong UNIX and EMACS nerd; a former white-hat phreaker; a very early IRC user; and a .org domain archaeologist. 
</p>
</div>

<div id="outline-container-org9963fc9" class="outline-3">
<h3 id="org9963fc9">A geek</h3>
<div class="outline-text-3" id="text-org9963fc9">
<p>
My geek code serves as a short (and usually sufficient) introduction.
</p>

<p>
GE d- s:++ a+++ C++++ UL+++ P+ L+++ E+++ W+++ N+++ o+ K+ w&#x2014; V PS+ PE f&#x2014; c+++ Y+ PGP++ t+++ 5- X- R+++ tv++ b++ D-&#x2014; xkcd G e++++ h&#x2013; r+++
</p>

<p>
Translation: 
</p>

<ul class="org-ul">
<li><b>GE</b> Geek of Engineering.</li>
<li><b>d-</b> I'm usually in jeans and a t-shirt.</li>
<li><b>s:++</b> I'm of average height, I'm a linebacker candidate.</li>
<li><b>a+++</b> 60 and up.</li>
<li><b>C++++</b> I'll be first in line to get the new cybernetic interface installed into my skull.</li>
<li><b>UL50</b> I've been using Unix for 50 years.</li>
<li><b>P+++</b> I've earned a living with Perl.</li>
<li><b>L(U)+++</b> I use Ubuntu Linux exclusively, mostly command line.</li>
<li><b>E+++</b> Emacs is my login shell!! M-x doctor is my psychologist! I use emacs to control my TV and toaster oven! All you vi people don't know what you're missing! I read alt.religion.emacs, alt.sex.emacs, and comp.os.emacs.</li>
<li><b>W1.0+++</b> I am an original Netizen.</li>
<li><b>N+++</b> I read so many newsgroups that the next batch of news comes in before I finish reading the last batch, and I have to read for about 2 hours straight before I'm caught up on the morning's news. Then there's the afternoon.</li>
<li><b>K+</b> I like Kibo. If you know, you know.</li>
<li><b>w---</b> Windows is bloatware.</li>
<li><b>V</b> I've used VMS. Meh.</li>
<li><b>PS+</b> My whole concept of politics? Nobody has the right to legislate morality.</li>
<li><b>PE</b> Distrust both government and business.</li>
<li><b>f---</b> In matters of religion, I distrust all human claims for the one true way.</li>
<li><b>c+++</b> I am a cyberpunk all the way, including music.</li>
<li><b>Y+</b> I have an interest and concern in privacy issues, but in reality I am not really all that active or vocal.</li>
<li><b>PGP++</b> I have the most recent version and use it regularly.</li>
<li><b>t+++</b> Star Trek inspires me. I wonder about about warp field dynamics and the principles behind the transporter. I have owned the TECH manual and the LP record. I speak some Klingon. I wear an IDIC. I still hate the LCARS interface, though, it really sucks.</li>
<li><b>5</b> Babylon 6 is sub-par.</li>
<li><b>X-</b> It's ok if you like paranoia and conspiracy stories.</li>
<li><b>R+++</b> I've built and run my own dungeons for money. Lots of money. At comic-cons. With 100 little envelopes of dice I brought with me.</li>
<li><b>tv---</b> Not much on TV anymore, though I sometimes watch it when I'm petting the cat.</li>
<li><b>b++</b> I find the time to get through at least one new book a month.</li>
<li><b>D---</b> Dilbert doesn't speak to me; I've tried to stay out of those type situations.</li>
<li><b>xkcd</b> I check out xkcd from time to time; sometimes it's really funny.</li>
<li><b>G</b> I know what the geek code is and even did up this code.</li>
<li><b>e++++</b> I am well-educated, mostly by myself, but I did get more than one college degree.</li>
<li><b>h+++</b> I live in the swampy woods, on land I own, in a house I own outright, and try to live as self-sufficiently as possible.</li>
<li><b>r+++</b> I found my angel, and we've been married for decades now.</li>
</ul>
</div>
</div>

<div id="outline-container-org45e4a7d" class="outline-3">
<h3 id="org45e4a7d">A principled person</h3>
<div class="outline-text-3" id="text-org45e4a7d">
<p>
When I consider the universe as a sealed container which I cannot view from the outside, and take into account the fundamental laws of nature, I can hypothesize that the meaning of life, the universe, and everything is <i>growth</i>:
</p>

<ol class="org-ol">
<li><b><b>Start small and build a little at a time:</b></b> Growth is about beginning with manageable steps and gradually expanding, just as the universe and life have evolved from simplicity to complexity.</li>

<li><b><b>Say what you mean:</b></b> Growth in communication and relationships occurs through clear and honest expressions, enhancing understanding and connections.</li>

<li><b><b>Network:</b></b> Growth is not just individual but also communal. Networking is about expanding one's understanding, influence, and support system, reflecting the interconnected growth of the universe.</li>

<li><b><b>Divide and conquer:</b></b> Just as complex systems in the universe are formed from simpler elements, tackling large challenges by breaking them down into smaller, manageable tasks fosters effective growth and progress.</li>

<li><b><b>Keep it simple:</b></b> Simplicity is essential for sustainable growth. Avoiding overcomplication allows for a clear focus and steady development, reflecting the natural progression of the universe.</li>

<li><b><b>Do one thing well:</b></b> Specializing and excelling in one area can lead to significant growth, much like how specific elements in the universe have unique roles contributing to the overall harmony.</li>

<li><b><b>Be who you are:</b></b> Personal growth is about embracing and developing your unique qualities, much like how diversity in the universe contributes to its richness and complexity.</li>

<li><b><b>Build for strength, not just speed:</b></b> Sustainable growth is more valuable than rapid, short-lived progress, mirroring the long-term development seen in cosmic and evolutionary scales.</li>

<li><b><b>Speak clearly, listen carefully, pay close attention:</b></b> Effective communication and attention are crucial for learning and growing, akin to how careful observation of the universe leads to deeper understanding.</li>

<li><b><b>Underpromise and overdeliver:</b></b> Exceeding expectations fosters growth in reputation and skills, reflecting the universe's tendency to reveal more than what is initially perceived.</li>

<li><b><b>Practice the Prime Directive:</b></b> Respecting the natural course of development promotes harmonious growth, similar to how ecosystems or celestial bodies follow their intrinsic paths of evolution.</li>

<li><b><b>Hack:</b></b> Experimentation and trying new things are at the heart of growth and learning, paralleling the universe's continuous exploration of possibilities.</li>

<li><b><b>Use what you have:</b></b> Resourcefulness and adaptability are key to growth, reflecting how the universe makes use of available resources and conditions to evolve.</li>

<li><b><b>Use levers, not people:</b></b> Finding efficient solutions that respect individuals' roles and contributions promotes balanced growth, akin to the synergistic workings of the universe.</li>

<li><b><b>Release early, release often:</b></b> This iterative process is essential to growth in projects and skills, mirroring the evolutionary process where continuous adaptation leads to advancement.</li>

<li><b><b>Distrust all claims for the one true way:</b></b> Open-mindedness to multiple approaches is vital for growth and innovation, reflecting the universe's diverse and multifaceted nature.</li>

<li><b><b>Think ahead, but don’t worship your plans:</b></b> Flexibility and adaptability are crucial for navigating and growing through life’s unpredictability, much like how the universe evolves through a mix of deterministic laws and random events.</li>
</ol>
</div>
</div>

<div id="outline-container-org7e50a1a" class="outline-3">
<h3 id="org7e50a1a">A lifelong UNIX nerd</h3>
<div class="outline-text-3" id="text-org7e50a1a">
<p>
There's a story that's gone around MIT forever. In case you didn't know, a lot of the computer revolution began with the Tech Model Railroad Club in the late 50's. Yeah, there were people that liked to build scenery, and others that craved fancier trains and accessories. But the folks I'm mentioning worked on the switchgear.
</p>

<p>
I think they were a committee dedicated to programming the greasy little analog computers that animated the whole assembly. When the "hulking giant" came to town &#x2013; a giant mainframe that took paper-tape programs &#x2013; they began to take the overnight slots in the computer room, building programs, trying to cut instructions down to the very minimum. It became an obsession.
</p>

<p>
<b>GROCERIES AND A VOLKSWAGEN</b>
In fact, it was such an obsession that one of the guys there started trying to adapt his thinking (and his casual language) to the sequential logic of computer programs. This didn't serve him well, as the story goes: For three Saturdays on end, his wife went to the local grocery to get provisions. When she got home, she'd always ask, "You want to help me bring in the groceries?" He would simply reply, "No." And then he'd go on working on whatever he was doing at the moment.
</p>

<p>
On the fourth Saturday (again, according to legend), she came home, after packing a considerable load of supplies in their tiny Volkswagen, and asked again. Again he declined; but this time, she blew up.
</p>

<p>
"What's wrong with you? Why won't you help me with the groceries?"
</p>

<p>
"You asked me if I wanted to help you bring in the groceries. You didn't ask me if I would."
</p>

<p>
You can see where this probably went, although legends can get hazy after the punch line. Still, it illustrates a point about the way frequent computer users have their logic and language influenced by the machines they address. It's the old proverb all over again: you become like your friends, even if they're made of silicon and plastic.
</p>

<p>
<b>I ONLY TOURED MIT</b>
I only toured MIT when I was in the seventh grade, part of a some science prize I won that year. Since our family was very middle-middle-class, my dad asked me not to consider going to any school that was too far from home. As incentive, he pulled some strings with his faculty colleagues to get me into computer classes at the local community college (when I was 14) and arranged for me to take college classes at the local university as part of my regular high-school schedule.
</p>

<p>
So it was that I logged into UNIX for the first time at Calhoun Community College, in Decatur, Alabama, during the summer of 1974. Having been an avid reader since the age of 6, text and text-processing were very much on my mind. When I encountered a system where plain text is the raw material flowing through the pipes, I was hooked.
</p>

<p>
The story about the groceries and the Volkswagen gave me a bigger clue: Computers and humans both depend on language, but unlike computers, human speech conveys an exact meaning even using apparently <i>imprecise</i> language. Could the informal programming rules that I learned from UNIX be adapted to life?
</p>

<p>
<b>UNIX RULES FOR LIFE</b>
After about 30 years as a tech writer and developer, I finally settled on a set that works for me. Little did I know that these very principles would lead me to org-mode, which would later lead me to find my people:
</p>

<ol class="org-ol">
<li>Keep it simple. It's cheaper and easier to carry around.</li>
<li>Do one thing well (at a time), because multitasking is a lie.</li>
<li>Network: You were born to connect.</li>
<li>Say what you mean; nothing is truer than the truth.</li>
<li>Hack, because someone's trial and error is the only way to learn anything, but keep a voltmeter handy, so you don't become a memorable lesson in failure.</li>
<li>Be who you are: Even a bent wire can carry a great light.</li>
<li>Use leverage &#x2013; a bigger hammer isn't always the best answer.</li>
<li>Use what you have. Never dig for diamonds with a gold brick.</li>
<li>Have faith; all things are possible, except maybe skiing through a revolving door.</li>
<li>Think ahead, but don't worship your plans. Remember, today is the first day of the rest of your learning experience.</li>
</ol>

<p>
<b>ed &gt;&gt; vi &gt;&gt; emacs</b> I didn't start with org-mode, actually. I remember
my first foo, created with the ed line editor. It was September, 1974,
on a PDP-11/40, in the second-floor lab at the local community
college. Bill Joy hadn't even written vi yet &#x2013; that watershed weekend
was still three years in the future. It was an amazing experience for
a fifteen-year-old, admitted early to audit night classes because his
dad was a part-time instructor and full-time polymath.
</p>

<p>
I should warn you, I’m not the genius in the room. I maintained a B average in math and electrical engineering, but A+ averages in English, languages, programming, and organic chemistry (who knew?). The genius was my Dad, the math wizard, the US Navy CIC Officer. I’m more of a language (and logic) guy. But isn’t code where math meets language and logic?
</p>

<p>
<b>RESEARCH UNIX</b>
v5 had just been licensed to educational institutions at no cost, and since this college was situated squarely in the middle of the military-industrial complex, scoring a Hulking Giant was easy. Finding good code to run it? No problem, since Bell Labs offered up a freebie.
</p>

<p>
It was amazing! Getting the computer to do things on its own — via ASM and FORTRAN — was not new to me. What <i>was</i> new was the <i>simplicity</i> of the whole thing. Mathematically, UNIX and C were incredibly complex, incorporating all kinds of network theory and topology and numerical methods that (frankly) haven’t always been my cuppa. And I’m not even sure if Computer Science was a thing yet.
</p>

<p>
But the amazing part? Here was an OS which took all that complexity and translated it to simple logic: everything is a file; small is beautiful; do one thing well. Didn’t matter that it was cranky and buggy and sometimes dumped your perfectly-okay shell-script in the bit bucket. It was a thrill to be able to do something without having to obsess over the math underneath.
</p>

<p>
<b>LAYERS OF ABSTRACTION</b>
In short, what made UNIX and C usable and beautiful to mid-brainers like me was <i>abstraction</i>. You didn’t have to worry (much) about the low-level details if you didn’t feel like it. You could focus on pure logic and abstract entities without having to “break the fourth wall,” as actors say. You could take little pieces — like <code>ls</code> and <code>cat</code> and <code>awk</code> and <code>sed</code> — and you could assemble a script or a C program that would grant your wish. And that was exhilarating and exciting and fabulous for me.
</p>

<p>
At some point, I caught onto the idea of abstracting my day, with plain journal files named <code>&lt;YYYYMMDD&gt;</code>, in a special directory in <code>/var/log</code>. I still have those going back to sometime in the 90's. The format was simple, but using the files soon became complex:
</p>

<pre class="example">
***personal journal of stormrider
tue, aug 04, 1992 / 712904400
sweetmorn, confusion 70, 3158 YOLD

***fortune -s
Cold hands, no gloves.

***appts
09:00 staff meeting, conf rm
18:30 dinner with amit &amp; bonnie

***to do
finish revisions on x-windows book
do syllabus for advanced C class
read some in Stevens &amp; Rago
shower
shave
dress
take out the trash otw to work
.
.
.

***daily journal
06:43 - man, didn't sleep well
last night; i think i'm overdoing
it on the coffee at work; maybe i
should cut back some?
.
.
.

</pre>

<p>
The unwieldy part came with all the repeated tasks, and tasks that got carried over from one day to the next (or didn't get finished). I had to copy yesterday's file, change all the key info, sort out the todo list, erase yesterday's journal entries from the new file, and generally do far too much work to keep my journal up.
</p>

<p>
I did it, but intermittently, supplanting it with post-it notes, pads, planners galore, palm pilots, palmtop computers, etc. It seemed like every day I was badly copying tasks from one day to the next. And all that organizational time became a major chunk of my day. Meanwhile, my unwillingness to use Windows didn't give the the luxury of Outlook, when it came along.
</p>

<p>
I got turned onto <code>emacs</code> sometime in the mid-nineties, when I moved to Atlanta to work for HP. A fellow writer there used it, and suggested it might help me write and code up examples more effectively. He was right, and it stuck as my editing platform of choice. But I hadn't discovered <code>org-mode</code> yet. Either nobody I knew used it, or it hadn't been invented yet. And to be honest, I kinda went back and forth between <code>vi</code> and <code>emacs</code>, depending on my "mood of the month."
</p>

<p>
<b>A MODEM IN THE WOODS</b>
Eventually, my HP job became a telecommuting-type arrangment, and I moved to my wife's ancestral farm, about an hour outside New Orleans, in the woods. At that time, Internet was still modem-driven out here, so having command-line Linux with <code>emacs</code> on my laptop was a real lifesaver.
</p>

<p>
Sometime not long before Katrina hit, I stumbled across <code>org-mode</code>. I'd already used <code>outline.el</code> for some period of time (can't remember how long), and <code>org-mode</code> seemed like a logical follow-on from there.
</p>

<p>
From there, <code>org-mode</code> just grew, and I grew with it. All the features made it easy for me to work naturally, and do things in a way that felt right to me. Gradually, my other methods of keeping track of things faded away, except for my alarm clock.
</p>

<p>
Even when smart-phones took off, I was always trying to find some way to send org files over to my phone and use them there. I think I even wrote some lua code in an iPhone wiki app to emulate org-mode with my files, though it was not fully satisfactory.
</p>

<p>
<b>AN ORG-MODE RESUME</b>
Fast-forward to mid-2019. I'd been wanting to get on with Canonical for a long time, but hadn't found the right position, one that really matched my skills. Then one Saturday, while I was waiting for my wife to meet me for some community event we were hosting, I saw a position that virtually described me. I started to write a resume, but then decided that I would just take the job description elements, one-by-one, put them in an org file, and send them to the hiring manager.
</p>

<p>
Long-story short, almost everyone on this team used <code>emacs</code>, and <code>org-mode</code>, and lots of other <code>.el</code> packages that I also used every day. I got the job, and so far, I'm very happy and feel like I fit in very well. I no longer mark my workday tasks as "work" &#x2013; I mark them as "foss" (free and open-source software), and I'd like to keep that designation for my paying work from now on.
</p>

<p>
<b>NOW YOU'RE CAUGHT UP</b>
At least, now you're caught up on what matters. There's a lot more backstory there, but it's kinda personal, y'know?
</p>
</div>
</div>

<div id="outline-container-orgcd8a260" class="outline-3">
<h3 id="orgcd8a260">A lifelong EMACS nerd</h3>
<div class="outline-text-3" id="text-orgcd8a260">
<p>
As an engineer and technical author, I am a creator and a knowledge worker.  I strive to do rare and valuable work &#x2013; what Dartmouth professor Cal Newport calls <i>deep work</i>.  Deep work is hard and difficult.  I try my best to choose things that are hard and difficult, choose them often, and sustain that effort over long periods of time.
</p>

<p>
As a right-brained person in a left-brained world, I use tools to help me transform creativity into engineering results.  I use intuition more than logic, but I don't subscribe to dichotomies (because logical fallacy).  I think in words, pictures, animations, and scenarios.  I am a technical communicator because that's where I can most easily do hard and difficult work and produce rare and valuable results.
</p>

<p>
Because of the way my mind works, I choose to use <code>emacs org-mode</code> as my center of gravity, but I can successfully do the same thing with paper and pencil, if required.
</p>

<p>
<b>I USE ORG-MODE</b>
Org-mode is a smart outline with folding.  You can easily rearrange the outline with a single key combination.  This helps me capture my mental chaos and organize it into coherent thoughts and plans.
</p>

<p>
Org-mode is also a personal organizer.  I use many of its features, many times every day:
</p>

<ul class="org-ul">
<li>to-do items with user-definable states,</li>
<li>user-assigned priorities,</li>
<li>user-assigned tags,</li>
<li>scheduled dates (with clock time, if desired),</li>
<li>deadlines,</li>
<li>very flexible, user-defined repeat intervals,</li>
<li>and tables that can also function as spreadsheets.</li>
</ul>

<p>
<b>LOVE THE ORG-MODE AGENDA</b>
Org-mode also has an agenda with a flexible viewing interval. From the agenda, I can:
</p>

<ul class="org-ul">
<li>estimate task effort,</li>
<li>easily change priorities and tags,</li>
<li>move tasks between to-do states,</li>
<li>filter tasks on tags and other attributes,</li>
<li>graphically track my habits,</li>
<li>clock my work,</li>
</ul>

<p>
and do a lot more things, with minimal time spend <i>managing</i> time.
</p>

<p>
<b>EVERYTHING'S IN MY JOURNAL</b>
I overlay <code>org-journal</code> on top of org-mode, logging events and recording to-do items as they come up, pinned to date and time.  It automatically carries over undone items to today, so the agenda doesn't get bogged down with hundreds of files to scan.  And I wrote an <code>emacs lisp</code> function to move repetitive to-do items to a static file that's <i>also</i> visible to the agenda.  
</p>

<p>
<b>THIS WEBSITE IS EVEN BUILT WITH ORG-MODE</b>
Yep, even <a href="http://stormrider.io/">stormrider.io</a> is entirely written in org-mode and exported to my server as HTML, on-demand.
</p>
</div>
</div>

<div id="outline-container-orgc208055" class="outline-3">
<h3 id="orgc208055">A former white-hat phreaker</h3>
<div class="outline-text-3" id="text-orgc208055">
<p>
I used to work extensively with the landline telephone system, both for money (as a "phone man") and for fun. I did <i>not</i> do illegal things with phones, because that would disturb people and interrupt their service, which goes against my doctrine of non-interference. Still, over the years, I have kept a list of US telephone numbers that still play recordings.
</p>
</div>

<div id="outline-container-orga3fe4f2" class="outline-4">
<h4 id="orga3fe4f2">Intercept numbers</h4>
<div class="outline-text-4" id="text-orga3fe4f2">
<p>
Some of these recordings are intercept messages.  In Bell System terminology, an <i>intercept message</i> is provided when the number isn't available (e.g., "this number is no longer in service"), when the caller needs to perform an action to complete a call (such as depositing money in a pay phone), or when the caller performs an action that needs confirmation (such as deactivating call forwarding).
</p>

<p>
Rather than using special circuits for these intercept messages, the Bell System just has reserved phone numbers in each area that play the message.  That way, intercepting an errant call is as easy as forwarding the call to another phone number, which picks up seamlessly.
</p>

<p>
While there are a <i>lot</i> of intercept numbers (usually at least one in each area code), there's no reason to list all of them here.  Instead, I've provided a sampling of intercept numbers (the ones with the best call quality) that can be dialed directly.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">number</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">(202) 965-9970</td>
<td class="org-left">you have just deactivated this feature.</td>
</tr>

<tr>
<td class="org-left">(205) 867-5309</td>
<td class="org-left">Jenny is <i>not</i> in service in Birmingham.</td>
</tr>

<tr>
<td class="org-left">(206) 343-0011</td>
<td class="org-left">this call requires a coin deposit.  no, really.</td>
</tr>

<tr>
<td class="org-left">(213) 621-0001</td>
<td class="org-left">the good, old-fashioned, "We're sorry&#x2026;" recording (not Jane Barbe, sadly)</td>
</tr>

<tr>
<td class="org-left">(213) 621-0002</td>
<td class="org-left">1000Hz @ 0dB (this only makes sense if you're a phone person)</td>
</tr>

<tr>
<td class="org-left">(313) 849-9906</td>
<td class="org-left">calling is too heavy to answer this number.</td>
</tr>

<tr>
<td class="org-left">(412) 885-0075</td>
<td class="org-left">"All test positions are unmanned at this time, please try your call again later."</td>
</tr>

<tr>
<td class="org-left">(202) 762-1401</td>
<td class="org-left">USNO master clock!</td>
</tr>

<tr>
<td class="org-left">(509) 457-0044</td>
<td class="org-left">This call requires a coin deposit&#x2026;</td>
</tr>

<tr>
<td class="org-left">(509) 457-0045</td>
<td class="org-left">Your call cannot be completed as dialed&#x2026;</td>
</tr>

<tr>
<td class="org-left">(203) 777-4647</td>
<td class="org-left">Pat Fleet time &amp; temp in New Haven, CT</td>
</tr>

<tr>
<td class="org-left">(509) 457-0051</td>
<td class="org-left">All circuits are busy now&#x2026;</td>
</tr>

<tr>
<td class="org-left">(540) 829-9910</td>
<td class="org-left"><b>genuine Pat Fleet intercept message</b></td>
</tr>

<tr>
<td class="org-left">(570) 387-0000</td>
<td class="org-left">"due to an emergency condition&#x2026;."</td>
</tr>

<tr>
<td class="org-left">(573) 996-000x</td>
<td class="org-left">Doniphan, MO, CO intercept lines (autoforwards)</td>
</tr>

<tr>
<td class="org-left">(573) 996-0002</td>
<td class="org-left">they still have party lines?</td>
</tr>

<tr>
<td class="org-left">(573) 996-0003</td>
<td class="org-left">"your call cannot be completed as dialed" (remote intercept)</td>
</tr>

<tr>
<td class="org-left">(573) 996-0005</td>
<td class="org-left">"your call did not go through&#x2026;" (remote intercept)</td>
</tr>

<tr>
<td class="org-left">(573) 996-0006</td>
<td class="org-left">"the number you have reached&#x2026;is not in service"</td>
</tr>

<tr>
<td class="org-left">(609) 729-9928</td>
<td class="org-left">&#x2026;the long distance company you have selected is unable to complete your call&#x2026;</td>
</tr>

<tr>
<td class="org-left">(610) 797-0014</td>
<td class="org-left">Excuse me, please deposit five cents for the next 3 minutes &#x2026;</td>
</tr>

<tr>
<td class="org-left">(718) 816-9901</td>
<td class="org-left">North Staten Island DMS-100 ident message &amp; area code list</td>
</tr>

<tr>
<td class="org-left">(800) 444-4444</td>
<td class="org-left">automated number announcement circuit</td>
</tr>

<tr>
<td class="org-left">(800) 437-9606</td>
<td class="org-left">"your international call can not be completed as dialled"</td>
</tr>

<tr>
<td class="org-left">(845) 354-9912</td>
<td class="org-left">callcannotbecompletedasdialed&#x2026;.."</td>
</tr>

<tr>
<td class="org-left">(877) 763-2435</td>
<td class="org-left">odd squad HQ</td>
</tr>

<tr>
<td class="org-left">(914) 232-9901</td>
<td class="org-left">pleasant hills DMS 100</td>
</tr>

<tr>
<td class="org-left">(914) 737-9938</td>
<td class="org-left">somebody said put an outgoing message here</td>
</tr>

<tr>
<td class="org-left">(916) 440-0031</td>
<td class="org-left">"due to facility trouble&#x2026;."</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org21ae93f" class="outline-4">
<h4 id="org21ae93f">Fun lines</h4>
<div class="outline-text-4" id="text-org21ae93f">
<p>
Some people pay to maintain phone lines which provide useful information (like time and temp) or provide a humorous message.  Here are some of the best of those:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">number</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">(204) 867-5309</td>
<td class="org-left"><b>The Jenny Song!</b></td>
</tr>

<tr>
<td class="org-left">(213) 223-6101</td>
<td class="org-left">RING A BELL</td>
</tr>

<tr>
<td class="org-left">(216) 931-1212</td>
<td class="org-left">WKYC Time and Weather</td>
</tr>

<tr>
<td class="org-left">(270) 301-5797</td>
<td class="org-left">a maze of twisty little touch tones, all different.</td>
</tr>

<tr>
<td class="org-left">(303) 337-2500</td>
<td class="org-left">Denver Post Weather</td>
</tr>

<tr>
<td class="org-left">(406) 442-1730</td>
<td class="org-left">Helena, MT, time &amp; temp</td>
</tr>

<tr>
<td class="org-left">(415) 767-2676</td>
<td class="org-left">"Popcorn" time &amp; temp, preceded by a religious message</td>
</tr>

<tr>
<td class="org-left">(505) 503-4455</td>
<td class="org-left">Better Call Saul</td>
</tr>

<tr>
<td class="org-left">(719) 266-2837</td>
<td class="org-left">hall and oates emergency song line</td>
</tr>

<tr>
<td class="org-left">(888) 447-5594</td>
<td class="org-left">congratulations, you found your way here</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orgd539a87" class="outline-3">
<h3 id="orgd539a87">A very early IRC user</h3>
<div class="outline-text-3" id="text-orgd539a87">
<p>
I've been on IRC shortly after it became a thing.  What most people
don't know is that a <i>lot</i> of the modern textspeak ("where r u atm?") is
just carried over from IRC "chatronyms".  Here's a large sampling of
them, although I can't guarantee that this is all of them &#x2013; just all
the ones I could think of when writing this post.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">nym</th>
<th scope="col" class="org-left">expansion</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&lt;3</td>
<td class="org-left">i like that comment</td>
</tr>

<tr>
<td class="org-left">&lt;g&gt;</td>
<td class="org-left">grin</td>
</tr>

<tr>
<td class="org-left">3bs</td>
<td class="org-left">three beers short</td>
</tr>

<tr>
<td class="org-left">aamof</td>
<td class="org-left">as a matter of fact</td>
</tr>

<tr>
<td class="org-left">adn</td>
<td class="org-left">any day now</td>
</tr>

<tr>
<td class="org-left">afaiac</td>
<td class="org-left">as far as i am concerned</td>
</tr>

<tr>
<td class="org-left">afaict</td>
<td class="org-left">as far as i can tell</td>
</tr>

<tr>
<td class="org-left">afaik</td>
<td class="org-left">as far as i know</td>
</tr>

<tr>
<td class="org-left">afair</td>
<td class="org-left">as far as i remember</td>
</tr>

<tr>
<td class="org-left">afk</td>
<td class="org-left">away from the keyboard</td>
</tr>

<tr>
<td class="org-left">afpsoagf</td>
<td class="org-left">a few punches short of a good fight</td>
</tr>

<tr>
<td class="org-left">afssoap</td>
<td class="org-left">a few sandwiches short of a picnic</td>
</tr>

<tr>
<td class="org-left">aopc</td>
<td class="org-left">reciting local national motto</td>
</tr>

<tr>
<td class="org-left">asap</td>
<td class="org-left">as soon as possible</td>
</tr>

<tr>
<td class="org-left">asl pls</td>
<td class="org-left">age sex location please</td>
</tr>

<tr>
<td class="org-left">athyrio</td>
<td class="org-left">and the horse you rode in on</td>
</tr>

<tr>
<td class="org-left">atm</td>
<td class="org-left">at the moment</td>
</tr>

<tr>
<td class="org-left">atp</td>
<td class="org-left">at this point</td>
</tr>

<tr>
<td class="org-left">aybabtu</td>
<td class="org-left">all your base are belong to us</td>
</tr>

<tr>
<td class="org-left">b4n</td>
<td class="org-left">bye for now</td>
</tr>

<tr>
<td class="org-left">bak</td>
<td class="org-left">back at (my) keyboard</td>
</tr>

<tr>
<td class="org-left">bbfn</td>
<td class="org-left">bye bye for now</td>
</tr>

<tr>
<td class="org-left">bbiab</td>
<td class="org-left">be back in a bit</td>
</tr>

<tr>
<td class="org-left">bbiaf</td>
<td class="org-left">be back in a few</td>
</tr>

<tr>
<td class="org-left">bbl</td>
<td class="org-left">be back later</td>
</tr>

<tr>
<td class="org-left">bbs</td>
<td class="org-left">be back shortly</td>
</tr>

<tr>
<td class="org-left">bbs</td>
<td class="org-left">be back soon</td>
</tr>

<tr>
<td class="org-left">beg</td>
<td class="org-left">big evil grin</td>
</tr>

<tr>
<td class="org-left">brb</td>
<td class="org-left">be right back/bathroom break</td>
</tr>

<tr>
<td class="org-left">bta</td>
<td class="org-left">but then again</td>
</tr>

<tr>
<td class="org-left">btw</td>
<td class="org-left">by the way</td>
</tr>

<tr>
<td class="org-left">c-c-c-combo breaker</td>
<td class="org-left">call a halt to repeated posts</td>
</tr>

<tr>
<td class="org-left">cp</td>
<td class="org-left">coder pig</td>
</tr>

<tr>
<td class="org-left">cq&#x2026;</td>
<td class="org-left">looking for&#x2026;</td>
</tr>

<tr>
<td class="org-left">ctc</td>
<td class="org-left">care to chat?</td>
</tr>

<tr>
<td class="org-left">cya</td>
<td class="org-left">see ya</td>
</tr>

<tr>
<td class="org-left">d/c</td>
<td class="org-left">disconnected</td>
</tr>

<tr>
<td class="org-left">djiad</td>
<td class="org-left">darnit jim, i'm a doctor</td>
</tr>

<tr>
<td class="org-left">djiad</td>
<td class="org-left">not my area of expertise</td>
</tr>

<tr>
<td class="org-left">e.g.</td>
<td class="org-left">exempli gratia</td>
</tr>

<tr>
<td class="org-left">faq</td>
<td class="org-left">frequently asked questions</td>
</tr>

<tr>
<td class="org-left">fb</td>
<td class="org-left">fine business</td>
</tr>

<tr>
<td class="org-left">focl</td>
<td class="org-left">falling off chair laughing</td>
</tr>

<tr>
<td class="org-left">ftw</td>
<td class="org-left">for the win</td>
</tr>

<tr>
<td class="org-left">fwiw</td>
<td class="org-left">for what it's worth</td>
</tr>

<tr>
<td class="org-left">fyi</td>
<td class="org-left">for your information</td>
</tr>

<tr>
<td class="org-left">ga</td>
<td class="org-left">good afternoon</td>
</tr>

<tr>
<td class="org-left">gm</td>
<td class="org-left">good morning</td>
</tr>

<tr>
<td class="org-left">gmta</td>
<td class="org-left">great minds think alike</td>
</tr>

<tr>
<td class="org-left">gmtaasdo</td>
<td class="org-left">great minds think alike, and so do ours</td>
</tr>

<tr>
<td class="org-left">goybwaroc</td>
<td class="org-left">get on your big wheel and ride on, cowboy</td>
</tr>

<tr>
<td class="org-left">gtg</td>
<td class="org-left">got to go</td>
</tr>

<tr>
<td class="org-left">hdj</td>
<td class="org-left">irretrievably broken (he's dead, jim)</td>
</tr>

<tr>
<td class="org-left">hth</td>
<td class="org-left">hope that helps</td>
</tr>

<tr>
<td class="org-left">hybs</td>
<td class="org-left">christian greeting</td>
</tr>

<tr>
<td class="org-left">hyfj</td>
<td class="org-left">another christian greeting</td>
</tr>

<tr>
<td class="org-left">iaadbnyd</td>
<td class="org-left">i am a doctor, but not your doctor</td>
</tr>

<tr>
<td class="org-left">iaalbnyl</td>
<td class="org-left">i am a lawyer, but not your lawyer</td>
</tr>

<tr>
<td class="org-left">ianad</td>
<td class="org-left">i am not a doctor</td>
</tr>

<tr>
<td class="org-left">ianaitp</td>
<td class="org-left">i am not an IT person</td>
</tr>

<tr>
<td class="org-left">ianal</td>
<td class="org-left">i am not a lawyer</td>
</tr>

<tr>
<td class="org-left">ianyg</td>
<td class="org-left">i am not your guru (don't ask me)</td>
</tr>

<tr>
<td class="org-left">iapnad</td>
<td class="org-left">i'm a programmer, not a doctor</td>
</tr>

<tr>
<td class="org-left">inyitp</td>
<td class="org-left">i'm not your IT person</td>
</tr>

<tr>
<td class="org-left">ic</td>
<td class="org-left">i see</td>
</tr>

<tr>
<td class="org-left">ifypfy</td>
<td class="org-left">i fixed your post for you</td>
</tr>

<tr>
<td class="org-left">iha</td>
<td class="org-left">i hate acronyms</td>
</tr>

<tr>
<td class="org-left">iirc</td>
<td class="org-left">if i recall correctly</td>
</tr>

<tr>
<td class="org-left">imho</td>
<td class="org-left">in my humble opinion</td>
</tr>

<tr>
<td class="org-left">imnsho</td>
<td class="org-left">in my not so humble opinion</td>
</tr>

<tr>
<td class="org-left">imo</td>
<td class="org-left">in my opinion</td>
</tr>

<tr>
<td class="org-left">iow</td>
<td class="org-left">in other words</td>
</tr>

<tr>
<td class="org-left">irl</td>
<td class="org-left">in real life</td>
</tr>

<tr>
<td class="org-left">isagn</td>
<td class="org-left">i see a great need</td>
</tr>

<tr>
<td class="org-left">istr</td>
<td class="org-left">i seem to recall</td>
</tr>

<tr>
<td class="org-left">ito</td>
<td class="org-left">in terms of</td>
</tr>

<tr>
<td class="org-left">itt</td>
<td class="org-left">i think that</td>
</tr>

<tr>
<td class="org-left">j/k</td>
<td class="org-left">just kidding</td>
</tr>

<tr>
<td class="org-left">jk</td>
<td class="org-left">just kidding</td>
</tr>

<tr>
<td class="org-left">jsia</td>
<td class="org-left">just say it already</td>
</tr>

<tr>
<td class="org-left">kbn</td>
<td class="org-left">gimme a minute to break it</td>
</tr>

<tr>
<td class="org-left">kbn</td>
<td class="org-left">klaatu barada nikto</td>
</tr>

<tr>
<td class="org-left">kbn</td>
<td class="org-left">stand down, cowboy ^^</td>
</tr>

<tr>
<td class="org-left">kwh</td>
<td class="org-left">kilroy was here</td>
</tr>

<tr>
<td class="org-left">l8r</td>
<td class="org-left">later</td>
</tr>

<tr>
<td class="org-left">lahith</td>
<td class="org-left">(i need that) like a hole in the head</td>
</tr>

<tr>
<td class="org-left">le</td>
<td class="org-left">later edit</td>
</tr>

<tr>
<td class="org-left">llap</td>
<td class="org-left">live long and prosper</td>
</tr>

<tr>
<td class="org-left">lmao</td>
<td class="org-left">laughing my <b>*</b> off</td>
</tr>

<tr>
<td class="org-left">lol</td>
<td class="org-left">laughing out loud</td>
</tr>

<tr>
<td class="org-left">ltns</td>
<td class="org-left">long time no see</td>
</tr>

<tr>
<td class="org-left">lts</td>
<td class="org-left">laughing to self</td>
</tr>

<tr>
<td class="org-left">ly</td>
<td class="org-left">love you</td>
</tr>

<tr>
<td class="org-left">mil</td>
<td class="org-left">mother-in-law</td>
</tr>

<tr>
<td class="org-left">motd</td>
<td class="org-left">message of the day</td>
</tr>

<tr>
<td class="org-left">n/a</td>
<td class="org-left">no attachment</td>
</tr>

<tr>
<td class="org-left">n/m</td>
<td class="org-left">nevermind</td>
</tr>

<tr>
<td class="org-left">n/p</td>
<td class="org-left">no problem - np also used</td>
</tr>

<tr>
<td class="org-left">n/t</td>
<td class="org-left">no text</td>
</tr>

<tr>
<td class="org-left">nhdbof</td>
<td class="org-left">observing a religious holiday/ritual</td>
</tr>

<tr>
<td class="org-left">nmcnmm</td>
<td class="org-left">not my circus, not my monkeys</td>
</tr>

<tr>
<td class="org-left">np</td>
<td class="org-left">no problem</td>
</tr>

<tr>
<td class="org-left">oic</td>
<td class="org-left">oh, I see</td>
</tr>

<tr>
<td class="org-left">omg</td>
<td class="org-left">oh, my god</td>
</tr>

<tr>
<td class="org-left">op</td>
<td class="org-left">original poster</td>
</tr>

<tr>
<td class="org-left">opiahh</td>
<td class="org-left">op is a hose head</td>
</tr>

<tr>
<td class="org-left">otoh</td>
<td class="org-left">on the other hand</td>
</tr>

<tr>
<td class="org-left">pal2</td>
<td class="org-left">peace and long life</td>
</tr>

<tr>
<td class="org-left">ppl</td>
<td class="org-left">people</td>
</tr>

<tr>
<td class="org-left">re</td>
<td class="org-left">re hi or re hello</td>
</tr>

<tr>
<td class="org-left">rofl</td>
<td class="org-left">rolling on floor laughing</td>
</tr>

<tr>
<td class="org-left">roflmao</td>
<td class="org-left">rolling on floor laughing my arse off</td>
</tr>

<tr>
<td class="org-left">rotfl</td>
<td class="org-left">rolling on the floor laughing</td>
</tr>

<tr>
<td class="org-left">rtfm</td>
<td class="org-left">read the <b><b><b>*</b></b></b> manual</td>
</tr>

<tr>
<td class="org-left">rtfm</td>
<td class="org-left">read the full manual</td>
</tr>

<tr>
<td class="org-left">sahm</td>
<td class="org-left">stay at home mom</td>
</tr>

<tr>
<td class="org-left">sio</td>
<td class="org-left">spit it out</td>
</tr>

<tr>
<td class="org-left">shlm</td>
<td class="org-left">jewish greeting</td>
</tr>

<tr>
<td class="org-left">slm</td>
<td class="org-left">muslim greeting</td>
</tr>

<tr>
<td class="org-left">smmas</td>
<td class="org-left">sudo make me a sandwich</td>
</tr>

<tr>
<td class="org-left">st</td>
<td class="org-left">spell that</td>
</tr>

<tr>
<td class="org-left">ta</td>
<td class="org-left">thanks/again</td>
</tr>

<tr>
<td class="org-left">tafn</td>
<td class="org-left">that's all for now</td>
</tr>

<tr>
<td class="org-left">tam</td>
<td class="org-left">thanks a million</td>
</tr>

<tr>
<td class="org-left">tmi</td>
<td class="org-left">too much information</td>
</tr>

<tr>
<td class="org-left">tsta</td>
<td class="org-left">try spelling that again</td>
</tr>

<tr>
<td class="org-left">ttyl</td>
<td class="org-left">talk (type) to you later</td>
</tr>

<tr>
<td class="org-left">ttys</td>
<td class="org-left">talk (type) to you soon</td>
</tr>

<tr>
<td class="org-left">ty</td>
<td class="org-left">thank you thx thanks</td>
</tr>

<tr>
<td class="org-left">w8</td>
<td class="org-left">wait</td>
</tr>

<tr>
<td class="org-left">wb</td>
<td class="org-left">welcome back</td>
</tr>

<tr>
<td class="org-left">wc?</td>
<td class="org-left">are you hungry? (want chinese?)</td>
</tr>

<tr>
<td class="org-left">we</td>
<td class="org-left">whatever</td>
</tr>

<tr>
<td class="org-left">w/e</td>
<td class="org-left">whatever</td>
</tr>

<tr>
<td class="org-left">wfm</td>
<td class="org-left">works for me</td>
</tr>

<tr>
<td class="org-left">wsof</td>
<td class="org-left">way short of fudge (to give)</td>
</tr>

<tr>
<td class="org-left">wtf</td>
<td class="org-left">what, the fudge?</td>
</tr>

<tr>
<td class="org-left">wtf</td>
<td class="org-left">why the face?</td>
</tr>

<tr>
<td class="org-left">wtg</td>
<td class="org-left">way to go</td>
</tr>

<tr>
<td class="org-left">ww</td>
<td class="org-left">wire weenie (hardware person)</td>
</tr>

<tr>
<td class="org-left">wx</td>
<td class="org-left">weather</td>
</tr>

<tr>
<td class="org-left">wysineutwyg</td>
<td class="org-left">what you see is not entirely unrelated to what you get</td>
</tr>

<tr>
<td class="org-left">wysiwyg</td>
<td class="org-left">what you see is what you get</td>
</tr>

<tr>
<td class="org-left">wywtci</td>
<td class="org-left">whatever (you want to call it) [origin of "whatever"]</td>
</tr>

<tr>
<td class="org-left">ygbkm</td>
<td class="org-left">you gotta be kidding me</td>
</tr>

<tr>
<td class="org-left">ymmv</td>
<td class="org-left">your milage may vary</td>
</tr>

<tr>
<td class="org-left">yold</td>
<td class="org-left">year of our lady of discord</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org9a79816" class="outline-3">
<h3 id="org9a79816">A .org domain archaeologist</h3>
<div class="outline-text-3" id="text-org9a79816">
<p>
There are weird, boring, and historial sites in the "short .org" group of domain names.  By "short", I mean one-to-three letters that aren't obviously decoded by reading.  This is a WIP list of some of those ".org" domains.
</p>

<p>
For sanity's sake, I've skipped combinations either yield nothing, a parking page, or that weird religious site that crops up at a lot of short .org domains.
</p>

<ul class="org-ul">
<li><a href="https://a.org/">a.org</a> - social venture capital (??)</li>
<li><a href="https://c.org">c.org</a> - shortcut to change.org</li>
<li><a href="https://e.org/">e.org</a> - British-owned energy supplier</li>
<li><a href="https://f.org/">f.org</a> - some sort of bitcoin clearinghouse</li>
<li><a href="https://g.org/">g.org</a> - allrighty, then</li>
<li><a href="https://i.org/">i.org</a> - weird Facebook error page</li>
<li><a href="https://q.org/">q.org</a> - yet more blockchain weirdness</li>
<li><a href="https://u.org">u.org</a> - shortcut to understood.org, a neurodivergent support page</li>
<li><a href="https://www.v.org/">v.org</a> - victory over cancer</li>
<li><a href="https://w.org">w.org</a> - shortcut to wordpress.org</li>
<li><a href="https://www.x.org/wiki/">x.org</a> - the X-windows wiki</li>
<li><a href="https://www.z.org/">z.org</a> - DNS malfunction page from cloudflare</li>
<li><a href="https://at.org/">at.org</a> - strange manifesto written on an oscillating rainbow</li>
<li><a href="https://bl.org/">bl.org</a> - somebody was bored</li>
<li><a href="https://br.org/">br.org</a> - black rose; "adult education"</li>
<li><a href="https://bw.org/">bw.org</a> - international geek of mystery</li>
<li><a href="http://cg.org/">cg.org</a> - common ground; sort of an in-between thing</li>
<li><a href="http://cm.org/">cm.org</a> - cancelmoose is obsolete but still there</li>
<li><a href="http://cq.org/">cq.org</a> - at least they have a phone number</li>
<li><a href="https://www.da.org/">da.org</a> - durham academy: a moral compass, and all that&#x2026;.</li>
<li><a href="http://dc.org/">dc.org</a> - department c: a "net witness" company</li>
<li><a href="http://dd.org/">dd.org</a> - personal site; cryptic but interesting</li>
<li><a href="https://dh.org">dh.org</a> - doylestown health - not sure where this is</li>
<li><a href="https://di.org/">di.org</a> - the dorsai irregulars: security for your comic-con</li>
<li><a href="https://dj.org">dj.org</a> - redirect to some sound mixing twitter account</li>
<li><a href="http://dl.org/">dl.org</a> - a weird site that redirects to microsoft</li>
<li><a href="https://www.dm.org/">dm.org</a> - a Christian campus ministry in Pennsylvania</li>
<li><a href="http://eh.org/">eh.org</a> - i have <i>no</i> idea, but it looks like an old BBS, sort of</li>
<li><a href="https://www.elsevier.com/solutions/engineering-village?utm_source=eiorg&amp;utm_medium=redirect&amp;utm_campaign=301&amp;utm_content=/%3f">ei.org</a> - some subsite(?) of Elsevier</li>
<li><a href="http://el.org/">el.org</a> - realnames: a more meaningful email address</li>
<li><a href="https://www.eo.nl/">eo.org</a> - a dutch site of some kind; i don't read dutch</li>
<li><a href="https://www.ep.org/">ep.org</a> - evergreen building</li>
<li><a href="https://eq.org/">eq.org</a> - emotional intelligence network</li>
<li><a href="https://www.bcgsearch.com/">er.org</a> - an attorney placement firm</li>
<li><a href="https://nic.eu.org/">eu.org</a> - possibly the longest-service free domain-name service</li>
<li><a href="https://ev.org/">ev.org</a> - some sort of charitable funding org, i <i>think</i></li>
<li><a href="https://www.ey.com/en_us">ey.org</a> - a shareholder services company</li>
<li><a href="https://ez.canardaircraft.com/">ez.org</a> - former home of canard aircraft, with a forwarding link</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orgf7df181" class="outline-2">
<h2 id="orgf7df181">What do I do?</h2>
<div class="outline-text-2" id="text-orgf7df181">
<p>
I explain hard things. I build my own electronics. 
</p>
</div>

<div id="outline-container-org71791ee" class="outline-3">
<h3 id="org71791ee">I explain hard things</h3>
<div class="outline-text-3" id="text-org71791ee">
<p>
I always like to create text, charts, diagrams, flowcharts, and exploded views that explain things that are hard to understand.  ATM, I'm making a good living doing this, and I'd like to keep on doing that until I'm not able any more.
</p>

<p>
Here are some explanations that others have found useful.
</p>
</div>

<div id="outline-container-orgbc6d0a4" class="outline-4">
<h4 id="orgbc6d0a4">MAAS deployment process</h4>
<div class="outline-text-4" id="text-orgbc6d0a4">
<p>
Here's a flowchart of how MAAS deploys an image:
</p>


<div id="org669aee3" class="figure">
<p><img src="images/machine-booting.jpg" alt="machine-booting.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org4bb4afd" class="outline-4">
<h4 id="org4bb4afd">MAAS image anatomy</h4>
<div class="outline-text-4" id="text-org4bb4afd">
<p>
Here's a description of how MAAS images are structured.
</p>

<p>
Standard MAAS images are downloaded from <a href="https://images.maas.io">images.maas.io</a> into the MAAS region controller's cache, the layout of which is shown below.  To see what goes into a MAAS image, we can snapshot <a href="https://images.maas.io">images.maas.io</a> like this:
</p>

<pre class="example" id="org8ec4e55">
Index of /
[ICO]	Name            Last modified	       Size
[DIR]	ephemeral-v2/	2016-05-17 18:17 	-
[DIR]	ephemeral-v3/	2020-10-14 14:35 	-
[DIR]	ephemeral/	2013-09-13 18:23 	-
[DIR]	query/	2017-05-02 18:38 	-
[DIR]	streams/	2013-08-22 05:04 	-
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
We'll ignore everything but the <code>ephemeral-v3</code> directory for this discussion; it contains the following:
</p>

<pre class="example" id="org3c2d5b2">
Index of /ephemeral-v3
[ICO]	     Name	       Last modified	 Size
[PARENTDIR]  Parent Directory	 	           -
[DIR]	     candidate/	       2022-05-15 21:40    -
[DIR]	     daily/	       2020-06-17 13:05    -
[DIR]	     stable/	       2022-08-11 20:04    -
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
As of this writing, the <a href="https://maas.io/docs">MAAS documentation</a> tell us that the <a href="https://maas.io/docs/how-to-import-images#heading--candidate-stream">candidate stream</a> "contains images and bootloaders which have not been explicitly tested with MAAS."  These images may be more up-to-date than others in the repository.
</p>

<p>
Similarly, the <a href="https://maas.io/docs/how-to-import-images#heading--stable-stream">stable stream</a> "contains images and bootloaders which have been tested with the latest version of MAAS", so these images are more likely to be reliable and error-free than the candidate stream.  This stream is intended for production use.
</p>

<p>
The <a href="https://maas.io/docs/how-to-import-images#heading--daily-stream">daily stream</a> has been retired, even though it retains a subdirectory.  Any attempts to pull from the daily stream are automatically redirected to the stable stream.
</p>
</div>

<div id="outline-container-orge661dcc" class="outline-5">
<h5 id="orge661dcc"><i>What's in a stream?</i></h5>
<div class="outline-text-5" id="text-orge661dcc">
<p>
Delving into the stable stream gives us this listing:
</p>

<pre class="example" id="orgfdd78e5">
Index of /ephemeral-v3/stable
[ICO]	 Name	           Last modified     Size
[PARENTDIR]	 Parent Directory	 	      -
[DIR]	 bionic/	   2020-10-07 21:13   -
[DIR]	 bootloaders/	   2020-10-07 21:13   -
[DIR]	 centos/	   2020-11-19 19:05   -
[DIR]	 focal/	           2020-10-07 21:13   -
[DIR]	 groovy/	   2020-10-07 21:13   -
[DIR]	 hirsute/	   2020-11-03 23:03   -
[DIR]	 impish/	   2021-05-17 21:04   -
[DIR]	 jammy/	           2022-04-20 16:06   -
[DIR]	 kinetic/	   2022-08-11 20:04   -
[DIR]	 precise/	   2020-10-07 21:13   -
[DIR]	 streams/	   2020-10-22 15:49   -
[DIR]	 trusty/	   2020-10-07 21:13   -
[DIR]	 xenial/	   2020-10-07 21:13   -
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
You can see that there are stable Ubuntu images for a number of different Unbuntu releases, dating back several years.  <i>Not all of these images will work on all versions of MAAS, BTW.</i>  Just looking at the latest stable release (<code>jammy</code>), we can get a picture of what's included with the image stream:
</p>

<pre class="example" id="org5134576">
Index of /ephemeral-v3/stable/jammy
[ICO]	 Name	           Last modified     Size
[PARENTDIR]	 Parent Directory	 	      -
[DIR]	 amd64/	           2022-08-11 20:05   -
[DIR]	 arm64/	           2022-08-11 20:05   -
[DIR]	 armhf/	           2022-08-11 20:05   -
[DIR]	 ppc64el/	   2022-08-11 20:05   -
[DIR]	 s390x/	           2022-08-11 20:05   -
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
The stream is sorted by architecture, so let's examine the <code>amd64</code> architecture, one of the most common instances used for MAAS:
</p>

<pre class="example" id="org2dc50da">
Index of /ephemeral-v3/stable/jammy/amd64
[ICO]	 Name	           Last modified     Size
[PARENTDIR]	 Parent Directory	 	      -
[DIR]	 20220616/	   2022-06-24 15:04   -
[DIR]	 20220712.1/	   2022-07-14 21:05   -
[DIR]	 20220718/	   2022-07-21 19:01   -
[DIR]	 20220808/	   2022-08-11 20:03   -
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
Here, we see that there are several different versions, roughly one per month.  If we choose the latest (<code>20220808</code>), we begin to see the anatomy of an image:
</p>

<pre class="example" id="org487eae2">
Index of /ephemeral-v3/stable/jammy/amd64/20220808
[ICO]	 Name	           Last modified     Size
[PARENTDIR]	 Parent Directory	 	      -
[DIR]	 ga-22.04/	   2022-08-11 20:04   -
[ ]	         squashfs	   2022-08-08 14:26  404M
[ ]	         squashfs.manifest 2022-08-08 14:26   16K
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
So we've picked up one component of the image, the <a href="https://en.wikipedia.org/wiki/SquashFS">SquashFS</a>, a compressed, read-only filesystem that can be loaded into RAMdisk for the ephemeral image to use (e.g., when commissioning a MAAS machine).  You can get an idea of what's in this SquashFS by looking at the <code>squashfs.manifest</code>. The first part of this particular manifest file looks like this:
</p>

<pre class="example" id="orgc81631c">
adduser	3.118ubuntu5
apparmor	3.0.4-2ubuntu2.1
apport	2.20.11-0ubuntu82.1
apport-symptoms	0.24
apt	2.4.5
apt-utils	2.4.5
base-files	12ubuntu4.1
base-passwd	3.5.52build1
bash	5.1-6ubuntu1
bash-completion	1:2.11-5ubuntu1
bc	1.07.1-3build1
bcache-tools	1.0.8-4ubuntu3
bind9-dnsutils	1:9.18.1-1ubuntu1.1
bind9-host	1:9.18.1-1ubuntu1.1
</pre>

<p>
It's obvious that this is (mostly) just a list of packages to be included with the running system.  If you want to peruse the whole thing, you can go to <a href="https://images.maas.io">images.maas.io</a> and download the manifest file, which is plain text.
</p>

<p>
To round out this part of the image, we can double-jump straight to <code>ga-22.04/generic</code> to find:
</p>

<pre class="example" id="org3ae2452">
[ICO]	 Name	           Last modified     Size
[PARENTDIR]	 Parent Directory	 	      -
[ ]	         boot-initrd	   2022-08-08 14:26  106M
[ ]	         boot-kernel	   2022-08-08 14:26   11M
</pre>

<p>
Here we see an <a href="https://en.wikipedia.org/wiki/Initial_ramdisk">initial ramdisk</a> (<code>boot-initrd</code>), which loads a temporary, in-memory <code>root</code> filesystem for use by a booting ephemeral kernel on startup.  You'll also notice that the ephemeral kernel is located in this directory, as well.
</p>
</div>
</div>

<div id="outline-container-org1cee166" class="outline-5">
<h5 id="org1cee166"><i>What else do we need?</i></h5>
<div class="outline-text-5" id="text-org1cee166">
<p>
This <i>almost</i> completes the picture of the MAAS image.  We have a kernel, a temporary root filesystem, and an extended filesystem in compressed form.  What's missing?  Well, the bootloader, which is back at the top level of our streams directory:
</p>

<pre class="example" id="orgc7b7825">
Index of /ephemeral-v3/stable
[ICO]	 Name	           Last modified     Size
[PARENTDIR]	 Parent Directory	 	      -
[DIR]	 bionic/	   2020-10-07 21:13   -
[DIR]	 bootloaders/	   2020-10-07 21:13   -
[DIR]	 centos/	   2020-11-19 19:05   -
[DIR]	 focal/	           2020-10-07 21:13   -
[DIR]	 groovy/	   2020-10-07 21:13   -
[DIR]	 hirsute/	   2020-11-03 23:03   -
[DIR]	 impish/	   2021-05-17 21:04   -
[DIR]	 jammy/	           2022-04-20 16:06   -
[DIR]	 kinetic/	   2022-08-11 20:04   -
[DIR]	 precise/	   2020-10-07 21:13   -
[DIR]	 streams/	   2020-10-22 15:49   -
[DIR]	 trusty/	   2020-10-07 21:13   -
[DIR]	 xenial/	   2020-10-07 21:13   -
Apache/2.4.29 (Ubuntu) Server at images.maas.io Port 443
</pre>

<p>
Without walking all the directories under bootloaders, we can summarize the contents like this:
</p>

<ul class="org-ul">
<li>the <code>open-firmware</code> directory contains some number of compressed <a href="https://en.wikipedia.org/wiki/GNU_GRUB"><code>grub</code></a> archives for various architectures, updated with a new version every time a new MAAS image set is pushed.</li>

<li>the <code>pxe</code> directory contains compressed <a href="https://en.wikipedia.org/wiki/SYSLINUX"><code>syslinux</code></a> archives, sorted by architecture and release date.</li>

<li>the <code>uefi</code> directory contains compressed <code>grub</code> and <a href="https://wiki.debian.org/SecureBoot"><code>shim</code></a> (secure boot) archives, again sorted by architecture and release date.</li>
</ul>

<p>
This set of files covers all the possible boot configurations that this ephemeral image can support.
</p>
</div>
</div>
<div id="outline-container-orgfe43a29" class="outline-5">
<h5 id="orgfe43a29"><i>What an image contains</i></h5>
<div class="outline-text-5" id="text-orgfe43a29">
<p>
A MAAS simplestreams image, then, contains the following four things:
</p>

<ol class="org-ol">
<li>A kernel.</li>
<li>A bootloader.</li>
<li>An initial RAMdisk (temporary root filesystem).</li>
<li>A SquashFS compressed ("complete") filesystem.</li>
</ol>

<p>
As you can see from the foregoing discussion, there are many different architectures and update versions for each of these.
</p>
</div>
</div>

<div id="outline-container-org7e55faa" class="outline-5">
<h5 id="org7e55faa"><i>How the rack controller lays it down on disk</i></h5>
<div class="outline-text-5" id="text-org7e55faa">
<p>
When you downloaded MAAS images from the simplestreams, you're actually just downloading them to the rack controller. In fact, until they <i>are</i> downloaded to the rack controller, they can't be deployed.
</p>
</div>
</div>

<div id="outline-container-org4afa877" class="outline-5">
<h5 id="org4afa877"><i>Image directory</i></h5>
<div class="outline-text-5" id="text-org4afa877">
<p>
For the MAAS snap, the rack controller stores its images in <code>/var/snap/maas/common/maas/boot-resources/current</code>.  A typical image layout might look like this:
</p>

<pre class="example" id="orga24c966">
 4 drwxr-xr-x 5 root root  4096 Aug 11 15:38 bootloader
 4 drwxr-xr-x 3 root root  4096 Aug 11 15:38 centos
 4 drwxr-xr-x 3 root root  4096 Aug 11 15:38 custom
 4 drwxr-xr-x 2 root root  4096 Aug 11 15:39 grub
 4 -rw-r--r-- 1 root root   238 Aug 11 15:39 ipxe.cfg
92 -rw-r--r-- 1 root root 92070 Aug 16 15:36 maas.meta
 4 drwxr-xr-x 3 root root  4096 Aug 11 15:38 rhel
 4 drwxr-xr-x 3 root root  4096 Aug 11 15:38 ubuntu
</pre>
</div>

<div id="outline-container-orge3955c1" class="outline-6">
<h6 id="orge3955c1">The bootloader</h6>
<div class="outline-text-6" id="text-orge3955c1">
<p>
The typical <code>bootloader</code> directory might look like this:
</p>

<pre class="example" id="org205ca9d">
total 20
4 drwxr-xr-x 5 root root 4096 Aug 11 15:38 .
4 drwxr-xr-x 8 root root 4096 Aug 11 15:39 ..
4 drwxr-xr-x 3 root root 4096 Aug 11 15:38 open-firmware
4 drwxr-xr-x 3 root root 4096 Aug 11 15:38 pxe
4 drwxr-xr-x 4 root root 4096 Aug 11 15:38 uefi
</pre>
</div>
</div>

<div id="outline-container-org4efb938" class="outline-6">
<h6 id="org4efb938">open-firmware/ppc64el/bootppc64.bin</h6>
<div class="outline-text-6" id="text-org4efb938">
<p>
This example directory contains the <code>bootppc64.bin</code> open firmware bootloader for <a href="https://en.wikipedia.org/wiki/Ppc64">PowerPC</a> processors.
</p>
</div>
</div>

<div id="outline-container-org6b30187" class="outline-6">
<h6 id="org6b30187">pxe/i386</h6>
<div class="outline-text-6" id="text-org6b30187">
<p>
This example directory contains various bootloaders and associated <code>syslinux</code> programs for the SYSLINUX PXE bootloader.  The bootloaders typically found in this directory include <code>lpxelinux.0</code> and <code>pxelinux.0</code>.
</p>
</div>
</div>

<div id="outline-container-org666c123" class="outline-6">
<h6 id="org666c123">uefi</h6>
<div class="outline-text-6" id="text-org666c123">
<p>
The files in this example directory would typically include various extensible firmware interface (EFI) bootloaders for booting systems under various conditions.  Typical files might include:
</p>

<ul class="org-ul">
<li>arm64/bootaa64.efi</li>
<li>amd64/bootx64.efi</li>
<li>arm64/grubaa64.efi</li>
<li>amd64/grubx64.efi</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd51c724" class="outline-5">
<h5 id="orgd51c724"><i>centos</i></h5>
<div class="outline-text-5" id="text-orgd51c724">
<p>
This directory typically contains various CentOS images supported by MAAS.  These images are sorted by directory (e.g., <code>centos/amd64/generic/8/stable</code>), since they are typically all named <code>root-tgz</code>.
</p>
</div>
</div>

<div id="outline-container-orgdd9e1dd" class="outline-5">
<h5 id="orgdd9e1dd"><i>Links to commonly used files</i></h5>
<div class="outline-text-5" id="text-orgdd9e1dd">
<p>
For convenience, a number of symbolic links to common files are kept in the <code>current</code> directory:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">link</th>
<th scope="col" class="org-left">points to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">bootaa64.efi</td>
<td class="org-left">bootloader/uefi/arm64/bootaa64.efi</td>
</tr>

<tr>
<td class="org-left">bootppc64.bin</td>
<td class="org-left">bootloader/open-firmware/ppc64el/bootppc64.bin</td>
</tr>

<tr>
<td class="org-left">bootx64.efi</td>
<td class="org-left">bootloader/uefi/amd64/bootx64.efi</td>
</tr>

<tr>
<td class="org-left">chain.c32</td>
<td class="org-left">bootloader/pxe/i386/chain.c32</td>
</tr>

<tr>
<td class="org-left">grubaa64.efi</td>
<td class="org-left">bootloader/uefi/arm64/grubaa64.efi</td>
</tr>

<tr>
<td class="org-left">grubx64.efi</td>
<td class="org-left">bootloader/uefi/amd64/grubx64.efi</td>
</tr>

<tr>
<td class="org-left">ifcpu64.c32</td>
<td class="org-left">bootloader/pxe/i386/ifcpu64.c32</td>
</tr>

<tr>
<td class="org-left">ldlinux.c32</td>
<td class="org-left">bootloader/pxe/i386/ldlinux.c32</td>
</tr>

<tr>
<td class="org-left">libcom32.c32</td>
<td class="org-left">bootloader/pxe/i386/libcom32.c32</td>
</tr>

<tr>
<td class="org-left">libutil.c32</td>
<td class="org-left">bootloader/pxe/i386/libutil.c32</td>
</tr>

<tr>
<td class="org-left">lpxelinux.0</td>
<td class="org-left">bootloader/pxe/i386/lpxelinux.0</td>
</tr>

<tr>
<td class="org-left">pxelinux.0</td>
<td class="org-left">lpxelinux.0</td>
</tr>

<tr>
<td class="org-left">syslinux</td>
<td class="org-left">bootloader/pxe/i386</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org7d6fb50" class="outline-4">
<h4 id="org7d6fb50">Linux kernel block diagrams</h4>
<div class="outline-text-4" id="text-org7d6fb50">
<p>
Here are some block diagrams of the Linux OS that I've been created.
</p>

<p>
<i>Note: a reference example of the FreeBSD kernel is already available in great detail <a href="https://docs.freebsd.org/en/books/design-44bsd/">elsewhere</a>.</i>
</p>
</div>

<div id="outline-container-orgbeb83ac" class="outline-5">
<h5 id="orgbeb83ac"><i>User space</i></h5>
<div class="outline-text-5" id="text-orgbeb83ac">
<pre class="example" id="org03f6241">
    User Space        
┌─────────────────┐   
│ Applications    │ User-level programs run here, user apps &amp; tools	 
│ (User Programs) │ like web browsers, text editors, &amp; media players.
├─────────────────┤ 
│ Libraries       │ Precompiled functions &amp; code that apps use.
├─────────────────┤ 
│ Utilities       │ Command-line user utilities like ls &amp; cat. These
│ (Commands)      │ tools are used for scripting and automation.	      
└─────────────────┘
</pre>
</div>
</div>

<div id="outline-container-orgb260799" class="outline-5">
<h5 id="orgb260799"><i>Kernel space</i></h5>
<div class="outline-text-5" id="text-orgb260799">
<pre class="example" id="org152efc6">
    Kernel Space     
┌─────────────────┐
│                 │ The heart of the OS. It manages hardware &amp; offers 
│ Kernel          │ services to apps, like time-sharing CPU bandwidth,
│                 │ managing memory, and talking to devices.	  
├─────────────────┤
│ File System     │ This module manages files &amp; directories, reading
│ Management      │ and writing data, and managing metadata (inodes).
├─────────────────┤
│ Process Control │ This module manages processes (running programs).
│ and Scheduling  │ It ensures fair CPU sharing, based on nice-ing.  
├─────────────────┤
│ Memory Mgmt     │ This module keeps process data isolated &amp; current.
├─────────────────┤
│ Device Drivers  │ Drivers operate devices, usually in standard ways.
├─────────────────┤
│ Networking      │ Manages network communication. Includes protocols 
│ Stack           │ for data transmission, handling sockets, managing 
│                 │ connections, and routing data.		      
├─────────────────┤ 						      
│                 │ The interface between user space and kernel space.
│ System Calls    │ Allows user programs to access kernel services,   
│                 │ like file operations or memory allocation.	      
├─────────────────┤ 						      
│ Security        │ Security mechanisms include access control,       
│ Mechanisms      │ authentication, and authorization features that   
│                 │ protect the system's resources and data.          
├─────────────────┤ 						      
│ Interrupt       │ The interrupt handler catches hardware interrupts 
│ Handling        │ generated by devices. It manages their arrival    
│                 │ prioritization, &amp; handling.			      
├─────────────────┤ 						      
│                 │ Handles strategies to optimize power usage,       
│ Power Mgmt      │ including sleep states, CPU frequency scaling,    
│                 │ and device power management.		      
└─────────────────┘ 						      
</pre>
</div>
</div>

<div id="outline-container-orge332b28" class="outline-5">
<h5 id="orge332b28"><i>File system management</i></h5>
<div class="outline-text-5" id="text-orge332b28">
<pre class="example" id="org7ddf28a">
     File System Management
┌──────────────────────────────┐
│ File System                  │ Organizes and manages files and directories
│                              │ on storage devices, providing a structured
│                              │ way to store, retrieve, and organize data.
├──────────────────────────────┤
│ Directory Structure          │ Represents the hierarchy of directories and
│                              │ subdirectories, enabling efficient navigation
│                              │ and organization of files.
├──────────────────────────────┤
│ File Operations              │ Encompasses operations such as opening,
│                              │ reading, writing, closing, &amp; deleting files,
│                              │ ensuring data integrity.
├──────────────────────────────┤
│ Metadata Management          │ Manages metadata associated with files,
│ (Inodes, Permissions, etc.)  │ including information like ownership,
│                              │ permissions, timestamps, and file size.
├──────────────────────────────┤
│ File System Journaling and   │ Maintains a journal or log of changes to the
│ Transactional Support        │ file system to ensure consistency and
│                              │ recoverability in case of failures.
├──────────────────────────────┤
│ Disk Space Allocation        │ Handles the allocation and management of
│                              │ physical storage space on storage devices,
│                              │ preventing fragmentation and optimizing use.
├──────────────────────────────┤
│ Caching and Buffers          │ Implements caching mechanisms to improve
│                              │ file read and write performance, using
│                              │ buffers to temporarily store data.
└──────────────────────────────┘
</pre>
</div>
</div>

<div id="outline-container-org0e1160d" class="outline-5">
<h5 id="org0e1160d"><i>inodes</i></h5>
<div class="outline-text-5" id="text-org0e1160d">
<pre class="example" id="orgcf6b838">
       Inode Structure
┌───────────────────────────────┐
│          Inode                │ Inodes are essential data structures in
│                               │ Unix-like file systems (such as ext4).
│                               │ They store metadata about files and
│                               │ directories, as well as pointers to the
│                               │ actual data blocks that contain the
│                               │ file's content.
│ ┌───────────────────────────┐ │
│ │      File Metadata        │ │ Inodes store information like file
│ ├───────────────────────────┤ │ permissions, ownership (user and group),
│ │ File Permissions: Owner,  │ │ creation/modification/access timestamps, 
│ │ Group, Timestamps, Size   │ │ and the size of the file.
│ ├───────────────────────────┤ │
│ │ Block Pointers            │ │ Inodes have pointers to data blocks where
│ │ (Direct, Indirect,        │ │ the actual content of the file is stored. 
│ │ Double Indirect, etc.)    │ │ These pointers can be direct (pointing to
│ │                           │ │ data blocks directly), indirect (pointing
│ │                           │ │ to blocks that contain more pointers), 
│ │                           │ │ double indirect (pointing to blocks that
│ │                           │ │ contain indirect pointers), and so on,
│ │                           │ │ enabling efficient storage of large files.
│ ├───────────────────────────┤ │
│ │ Other Metadata            │ │ Inodes can also store extended attributes
│ │ (Extended Attributes,     │ │ (extra metadata not covered by the
│ │ ACLs, etc.)               │ │ traditional attributes) and Access Control
│ │                           │ │ Lists (ACLs) for advanced perms management.
│ └───────────────────────────┘ │
└───────────────────────────────┘
               │
               │
               │
               ▼
     ┌────────────────────┐
     │    Data Blocks     │ The actual content of a file is stored in data
     │   (File Content)   │ blocks. These blocks are pointed to by the block
     │                    │ pointers in the inode. Data blocks can be of
     │                    │ varying sizes and are organized in a way that
     │                    │ optimizes storage efficiency.
     └────────────────────┘
</pre>
</div>
</div>

<div id="outline-container-orgc6c924d" class="outline-5">
<h5 id="orgc6c924d"><i>Process control and scheduling</i></h5>
<div class="outline-text-5" id="text-orgc6c924d">
<pre class="example" id="orge24a810">
    Process Control
    and Scheduling
┌───────────────────┐
│ Process Control   │
│ and Management    │ Manages processes' creation, termination,
│                   │ synchronization, and communication.
├───────────────────┤
│ Process States    │ Tracks the various states a process can be in,
│                   │ including Running, Ready, Blocked, etc.
├───────────────────┤
│ CPU Scheduling    │ Selects processes for execution, optimizing
│                   │ CPU utilization, response time, and fairness.
├───────────────────┤
│ Context Switching │ Involves saving and restoring the state of
│                   │ processes when switching between them.
├───────────────────┤
│ Inter-Process     │ Facilitates data sharing and communication
│ Communication     │ between processes, using mechanisms like
│                   │ message passing and shared memory.
├───────────────────┤
│ Process Creation  │ Handles the creation of new processes,
│ and Termination   │ including resource allocation and cleanup.
└───────────────────┘
</pre>
</div>
</div>

<div id="outline-container-org06d3fee" class="outline-5">
<h5 id="org06d3fee"><i>Process management</i></h5>
<div class="outline-text-5" id="text-org06d3fee">
<pre class="example" id="orge394a6b">
      Process Management
          in Linux
┌───────────────────────────┐
│        User Space         │
│ ┌───────────────────────┐ │
│ │ User Programs         │ │
│ │ (Applications,        │ │
│ │ Utilities, etc.)      │ │
│ └───────────────────────┘ │
│             │             │
│             ▼             │
│ ┌───────────────────────┐ │
│ │ System Calls,         │ │
│ │ Libraries, etc.       │ │
│ └───────────────────────┘ │
│              │            │
│              ▼            │
│ ┌───────────────────────┐ │
│ │     Kernel Space      │ │
│ │ ┌───────────────────┐ │ │
│ │ │ Process Scheduler │ │ │ Manages task exec, optimizes CPU utilization.
│ │ ├───────────────────┤ │ │
│ │ │ Scheduler Queue   │ │ │ Holds tasks awaiting CPU allocation.
│ │ ├───────────────────┤ │ │
│ │ │ Time Management   │ │ │ Ensures fair and efficient task scheduling.
│ │ ├───────────────────┤ │ │
│ │ │ CPU Affinity      │ │ │ Binds process to specific CPUs.
│ │ ├───────────────────┤ │ │
│ │ │ Preemption &amp;      │ │ │ Pauses executing process, switches to another,
│ │ │ Context Switching │ │ │ resumes when needed.
│ │ ├───────────────────┤ │ │
│ │ │ Priority Inversion│ │ │ Prevents low-priority task blocking
│ │ │ Avoidance         │ │ │ high-priority task.
│ │ ├───────────────────┤ │ │
│ │ │ Load Balancing    │ │ │ Distributes tasks for resource optimization.
│ │ ├───────────────────┤ │ │
│ │ │ Real-time Sched   │ │ │ Enforces timing constraints, ensures critical
│ │ │ and Policies      │ │ │ task completion.
│ │ └───────────────────┘ │ │
│ └───────────────────────┘ │
└───────────────────────────┘
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d7a505" class="outline-4">
<h4 id="org9d7a505">MAAS CLI</h4>
<div class="outline-text-4" id="text-org9d7a505">
<p>
Here I configure MAAS via the command-line only and write about it.
</p>

<p>
MAAS has a really nice UI that's super-easy to use, and a CLI backed by a REST API. I'd really like to try to see how much I can do, and how far I can get, using just the CLI.
So my goals for this project are simple: run MAAS through its paces using only the CLI and take good notes.
</p>
</div>

<div id="outline-container-orga14f2c8" class="outline-5">
<h5 id="orga14f2c8">Installing MAAS</h5>
<div class="outline-text-5" id="text-orga14f2c8">
<p>
It starts with installation. I'm doing this experiment on my largest laptop, wintermute (named after the character in Neuromancer).  I mention that only because you'll sometimes see that hostname behind the prompt in the examples below.
</p>

<p>
Let's be naive and start from first installation. I've cleared MAAS off wintermute, as well as PostgreSQL, so I can try a true, out of box experience. I haven't cleaned off libvirt or any of my KVMs I've got on here, nor the bridge I created to network them, because I use those for other things &#x2013; and because it's reasonable to expect that someone who's looking at MAAS would have some kind of virtual machine capability around already.
</p>

<p>
So starting at the top of the MAAS 2.8 install instructions, I'm going to first "install (but not initialize) the MAAS snap":
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$ sudo snap install maas --channel=2.8
maas (2.8/stable) 2.8.1-8567-g.c4825ca06 from Canonical installed</textarea>
</p>

<p>
Looking over my MAAS initialisation modes, I see that region+rack mode will do fine for this install, as I don't have to add the complexity of separate rack controllers just yet. I can do that later, if I get that far. But it's not quite time to initialise, though; I need to make a decision whether I want a production install or just a proof-of-concept setup. I've already removed PostgreSQL so that I can choose either one.
</p>
</div>

<div id="outline-container-orge5b7456" class="outline-6">
<h6 id="orge5b7456">Production postgres</h6>
<div class="outline-text-6" id="text-orge5b7456">
<p>
For now, I think I'm going with the production configuration (more to see and do), and that starts with a local PostgreSQL install, from packages. And, like most Debian installs, that starts with an update, to grab any packages that might need to be available for the install to succeed:
</p>

<p>
<textarea cols="80" rows="24">
stormrider@wintermute:~$ sudo apt update -y

[sudo] password for stormrider: 
Hit:1 http://dl.google.com/linux/chrome/deb stable InRelease
Hit:2 http://us.archive.ubuntu.com/ubuntu focal InRelease                                      
Get:3 http://security.ubuntu.com/ubuntu focal-security InRelease [107 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu focal-updates InRelease [111 kB]
Get:5 http://us.archive.ubuntu.com/ubuntu focal-backports InRelease [98.3 kB]
Get:6 http://us.archive.ubuntu.com/ubuntu focal-updates/main amd64 Packages [310 kB]
Get:7 http://security.ubuntu.com/ubuntu focal-security/main amd64 DEP-11 Metadata [21.2 kB]
Get:8 http://us.archive.ubuntu.com/ubuntu focal-updates/main i386 Packages [187 kB]     
Get:9 http://us.archive.ubuntu.com/ubuntu focal-updates/main amd64 DEP-11 Metadata [196 kB]
Get:10 http://us.archive.ubuntu.com/ubuntu focal-updates/universe amd64 Packages [142 kB]
Get:11 http://us.archive.ubuntu.com/ubuntu focal-updates/universe i386 Packages [77.6 kB]
Get:12 http://security.ubuntu.com/ubuntu focal-security/universe amd64 DEP-11 Metadata [35.8 kB]
Get:13 http://us.archive.ubuntu.com/ubuntu focal-updates/universe Translation-en [71.7 kB]
Get:14 http://us.archive.ubuntu.com/ubuntu focal-updates/universe amd64 DEP-11 Metadata [176 kB]
Get:15 http://us.archive.ubuntu.com/ubuntu focal-updates/multiverse amd64 DEP-11 Metadata [2,468 B]
Get:16 http://us.archive.ubuntu.com/ubuntu focal-backports/universe amd64 DEP-11 Metadata [1,972 B]
Fetched 1,538 kB in 2s (827 kB/s)                                             
Reading package lists... Done
Building dependency tree       
Reading state information... Done
325 packages can be upgraded. Run 'apt list --upgradable' to see them.</textarea>
</p>

<p>
Then I can install PostgreSQL, probably version 12 or something like that:
</p>

<p>
<textarea cols="80" rows="27">
stormrider@wintermute:~$ sudo apt install -y postgresql</strong>

Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following packages were automatically installed and are no longer required:
enchant geoip-database gir1.2-mutter-5 gsfonts libbind9-161 libcroco3 libdns-export1107
libdns1107 libdns1109 libenchant1c2a libfprint0 libgeoip1 libgnome-desktop-3-18 libirs161
libisc-export1104 libisc1104 libisc1105 libisccc161 libisccfg163 liblwres161 libmicrodns0
libmutter-5-0 liboauth0 libpoppler90 libpython3.7 libpython3.7-minimal libpython3.7-stdlib
linux-image-5.3.0-40-generic linux-modules-5.3.0-40-generic
linux-modules-extra-5.3.0-40-generic ubuntu-software ubuntu-system-service
Use 'sudo apt autoremove' to remove them.
Suggested packages:
postgresql-doc
The following NEW packages will be installed:
postgresql
0 upgraded, 1 newly installed, 0 to remove and 325 not upgraded.
Need to get 4,004 B of archives.
After this operation, 67.6 kB of additional disk space will be used.
Get:1 http://us.archive.ubuntu.com/ubuntu focal/main amd64 postgresql all 12+214 [4,004 B]
Fetched 4,004 B in 0s (13.2 kB/s)     
Selecting previously unselected package postgresql.
(Reading database ... 227326 files and directories currently installed.)
Preparing to unpack .../postgresql_12+214_all.deb ...
Unpacking postgresql (12+214) ...
Setting up postgresql (12+214) ...</textarea>
</p>

<p>
Yep, version 12. I like keeping up. Anyway, now I need to set up a PostgreSQL user:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$<strong>sudo -u postgres psql -c "CREATE USER \"maascli\" WITH ENCRYPTED PASSWORD 'maascli'"
CREATE ROLE</textarea>
</p>

<p>
And create a suitable MAAS database:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$<strong>sudo -u postgres createdb -O "maascli" "maasclidb"</textarea>
</p>

<p>
Note that there's no system response (the old UNIX rule of "no news is good news"). Next, I need to add the database to the PostgreSQL HBA configuration, by editing `/etc/postgres/12/main/pghba.conf', adding a line to the bottom of the file:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$<strong>sudo vi /etc/postgresql/12/main/pg_hba.conf</strong>
host    maasclidb       maascli         0/0                     md5</textarea>
</p>
</div>
</div>

<div id="outline-container-org2aa8f60" class="outline-6">
<h6 id="org2aa8f60">Initialising MAAS</h6>
<div class="outline-text-6" id="text-org2aa8f60">
<p>
Finally, I can initialise MAAS, like this:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$<strong>sudo maas init region+rack --database-uri "postgres://maascli:maascli@localhost/maasclidb"
MAAS URL [default=http://192.168.43.251:5240/MAAS]: </textarea>
</p>

<p>
This command offers me a bit of important feedback, the MAAS URL, which will be needed for the CLI login. That's followed by a running commentary on the steps MAAS is taking to start up. It all ends with the following admonition:
</p>

<p>
<textarea cols="80" rows="10">
MAAS has been set up.

If you want to configure external authentication or use
MAAS with Canonical RBAC, please run

sudo maas configauth

To create admins when not using external authentication, run

sudo maas createadmin</textarea>
</p>

<p>
Well, that's an easy call. Let me just run &lt;code&gt;createadmin&lt;/code&gt; real quick:
</p>

<p>
<textarea cols="80" rows="7">
stormrider@wintermute:~$<strong>sudo maas createadmin
[sudo] password for stormrider: 
Username: admin
Password: 
Again: 
Email: admin@admin.com
Import SSH keys [] (lp:user-id or gh:user-id): xxxxxxxxxxx</textarea>
</p>
</div>
</div>
</div>

<div id="outline-container-orgbc8b727" class="outline-5">
<h5 id="orgbc8b727">Configuring MAAS</h5>
<div class="outline-text-5" id="text-orgbc8b727">
<p>
Now that <a href="https://stormrider.io/maas-cli-1.html">MAAS is up and running</a>, it's time to configure it. Normally, this would be accomplished through the MAAS configuration journey, but since I'm using the CLI for this, I want to avoid the UI as much as possible.
</p>
</div>

<div id="outline-container-org29ec9ac" class="outline-6">
<h6 id="org29ec9ac">Logging in</h6>
<div class="outline-text-6" id="text-org29ec9ac">
<p>
The first step in the config journey is logging in. In the CLI, that's a two-stepper:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$  sudo maas apikey --username=admin > api-key-file 
sudo maas apikey --username=admin > api-key-file</textarea>
</p>

<p>
You can make sure you got a valid API key by displaying the contents of api-key-file:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$  cat api-key-file 
XXEjkeeqM:zXb7LkuPY7VxShFNhCFDaD8WnP8gLVL8V64GbSn:tTKdwWV64GbSn:tTKdwW</textarea>
</p>

<p>
Note that string isn't an actual API key, just characters I made up.
Anyway, I can now login to MAAS &#x2013; but first, let's try maas &#x2013;help &#x2013; there's an important distinction that gets skipped over, causing some grief:
</p>

<p>
<textarea cols="80" rows="22">
stormrider@wintermute:~$  maas --help 
usage: maas [-h] COMMAND ...

optional arguments:
   -h, --help      show this help message and exit

drill down:
   COMMAND
      login         Log in to a remote API, and remember its description and credentials.
      logout        Log out of a remote API, purging any stored credentials.
      list          List remote APIs that have been logged-in to.
      refresh       Refresh the API descriptions of all profiles.
      init          Initialise MAAS in the specified run mode.
      config        View or change controller configuration.
      status        Status of controller services.
      migrate       Perform migrations on connected database.
      apikey        Used to manage a user's API keys. Shows existing keys unless --generate or --delete is passed.
      configauth    Configure external authentication.
      createadmin   Create a MAAS administrator account.
      changepassword
                    Change a MAAS user's password.
      admin         Interact with http://192.168.43.251:5240/MAAS/api/2.0/</textarea>
</p>


<p>
This is the help you get (a) if you're not logged in, or (b) if you don't type a logged-in username after maas - which is a little annoying to me, but it's just how we do it. What you see above isn't even half of what the MAAS CLI will do, but it's all you get as an unrecognized user.
</p>

<p>
So now, let's login and try that help again:
</p>

<p>
<textarea cols="80" rows="8">
stormrider@wintermute:~$  maas login admin http://192.168.43.251:5240/MAAS/api/2.0/ < api-key-file 

You are now logged in to the MAAS server at
http://192.168.43.251:5240/MAAS/api/2.0/ with the profile name 'admin'.

For help with the available commands, try:

maas admin --help</textarea>
</p>
</div>
</div>

<div id="outline-container-orgf52d93a" class="outline-6">
<h6 id="orgf52d93a">Getting real help</h6>
<div class="outline-text-6" id="text-orgf52d93a">
<p>
Now, having done that, I can get a much better idea what the CLI will do:
</p>

<p>
<textarea cols="80" rows="125">
stormrider@wintermute:~$ maas admin --help 

usage: maas admin [-h] COMMAND ...

Issue commands to the MAAS region controller at http://192.168.43.251:5240/MAAS/api/2.0/.

optional arguments:
   -h, --help            show this help message and exit

drill down:
   COMMAND
      account             Manage the current logged-in user.
      bcache-cache-set    Manage bcache cache set on a machine.
      bcache-cache-sets   Manage bcache cache sets on a machine.
      bcache              Manage bcache device on a machine.
      bcaches             Manage bcache devices on a machine.
      block-device        Manage a block device on a machine.
      block-devices       Manage block devices on a machine.
      boot-resource       Manage a boot resource.
      boot-resources      Manage the boot resources.
      boot-source         Manage a boot source.
      boot-source-selection
                          Manage a boot source selection.
      boot-source-selections
                          Manage the collection of boot source selections.
      boot-sources        Manage the collection of boot sources.
      commissioning-script
                          Manage a custom commissioning script.
      commissioning-scripts
                          Manage custom commissioning scripts.
      dhcpsnippet         Manage an individual DHCP snippet.
      dhcpsnippets        Manage the collection of all DHCP snippets in MAAS.
      dnsresource         Manage dnsresource.
      dnsresource-record  Manage dnsresourcerecord.
      dnsresource-records
                          Manage DNS resource records (e.g. CNAME, MX, NS, SRV, TXT)
      dnsresources        Manage dnsresources.
      device              Manage an individual device.
      devices             Manage the collection of all the devices in the MAAS.
      discoveries         Query observed discoveries.
      discovery           Read or delete an observed discovery.
      domain              Manage domain.
      domains             Manage domains.
      events              Retrieve filtered node events.
      fabric              Manage fabric.
      fabrics             Manage fabrics.
      fan-network         Manage Fan Network.
      fan-networks        Manage Fan Networks.
      file                Manage a FileStorage object.
      files               Manage the collection of all the files in this MAAS.
      ipaddresses         Manage IP addresses allocated by MAAS.
      iprange             Manage IP range.
      ipranges            Manage IP ranges.
      interface           Manage a node's or device's interface.
      interfaces          Manage interfaces on a node.
      license-key         Manage a license key.
      license-keys        Manage the license keys.
      maas                Manage the MAAS server.
      machine             Manage an individual machine.
      machines            Manage the collection of all the machines in the MAAS.
      network             Manage a network.
      networks            Manage the networks.
      node                Manage an individual Node.
      node-results        Read the collection of commissioning script results.
      node-script         Manage or view a custom script.
      node-script-result  Manage node script results.
      node-script-results
                          Manage node script results.
      node-scripts        Manage custom scripts.
      nodes               Manage the collection of all the nodes in the MAAS.
      notification        Manage an individual notification.
      notifications       Manage the collection of all the notifications in MAAS.
      package-repositories
                          Manage the collection of all Package Repositories in MAAS.
      package-repository  Manage an individual package repository.
      partition           Manage partition on a block device.
      partitions          Manage partitions on a block device.
      pod                 Manage an individual pod.
      pods                Manage the collection of all the pod in the MAAS.
      rack-controller     Manage an individual rack controller.
      rack-controllers    Manage the collection of all rack controllers in MAAS.
      raid                Manage a specific RAID (Redundant Array of Independent
                          Disks) on a machine.
      raids               Manage all RAIDs (Redundant Array of Independent Disks) on
                          a machine.
      region-controller   Manage an individual region controller.
      region-controllers  Manage the collection of all region controllers in MAAS.
      resource-pool       Manage a resource pool.
      resource-pools      Manage resource pools.
      sshkey              Manage an SSH key.
      sshkeys             Manage the collection of all the SSH keys in this MAAS.
      sslkey              Manage an SSL key.
      sslkeys             Operations on multiple keys.
      space               Manage space.
      spaces              Manage spaces.
      static-route        Manage static route.
      static-routes       Manage static routes.
      subnet              Manage subnet.
      subnets             Manage subnets.
      tag                 Tags are properties that can be associated with a Node and
                          serve as criteria for selecting and allocating nodes.
      tags                Manage all tags known to MAAS.
      user                Manage a user account.
      users               Manage the user accounts of this MAAS.
      version             Information about this MAAS instance.
      virtual-machine     Manage individual virtual machines.
      virtual-machines    Manage a collection of virtual machines.
      vlan                Manage a VLAN on a fabric.
      vlans               Manage VLANs on a fabric.
      vm-host             Manage an individual vm-host.
      vm-hosts            Manage the collection of all the vm-hosts in the MAAS.
      vmfs-datastore      Manage VMFS datastore on a machine.
      vmfs-datastores     Manage VMFS datastores on a machine.
      volume-group        Manage volume group on a machine.
      volume-groups       Manage volume groups on a machine.
      zone                Manage a physical zone.
      zones               Manage physical zones.

      This is a profile.  Any commands you issue on this profile will
      operate on the MAAS region server.

      The command information you see here comes from the region server's
      API; it may differ for different profiles.  If you believe the API may
      have changed, use the command's 'refresh' sub-command to fetch the
      latest version of this help information from the server.</textarea>
</p>

<p>
Wowee! Look at all the commands! The very first time I tried to use the MAAS API (before I actually hired on at Canonical), I was using various commands I could find in the documentation that actually returned things I wanted, and then digging it out of the JSON output. Not fun. Then someone reminded me about <code>jq</code> (we'll come to that in a minute), and things got a little easier. Eventually, I asked one of the developers what the deal was, and learned that I just missed a the section called "Get help" in the CLI introduction. After that, a whole new world opened up.
</p>

<p>
But we came here to configure MAAS, not tell stories, so let me see what I can do with this beast.
</p>
</div>
</div>

<div id="outline-container-org1115e40" class="outline-6">
<h6 id="org1115e40">Setting dns</h6>
<div class="outline-text-6" id="text-org1115e40">
<p>
The very first blank line you encounter in the MAAS UI is the DNS server IP address. In the UI, I just type "8.8.8.8" (Google's DNS server) and forget about it. But the CLI has no box, so how do I get there? Well, there is a subcommand called &lt;code&gt;dnsresource~, let's see what that does.
</p>

<p>
<textarea cols="80" rows="13">
stormrider@wintermute:~$  maas admin dnsresource --help 
Usage: maas admin dnsresource [-h] COMMAND ...

Manage dnsresource.

optional arguments:
   -h, --help  show this help message and exit

drill down:
   COMMAND
      read      Read a DNS resource
      update    Update a DNS resource
      delete    Delete a DNS resource</textarea>
</p>

<p>
Okay, let's be naive and try that:
</p>

<p>
<textarea cols="80" rows="16">
stormrider@wintermute:~$  maas admin dnsresource read 
Usage: maas admin dnsresource read [--help] [-d] [-k] id [data [data ...]]

Read a DNS resource

positional arguments:
   id
   data

optional arguments:
   --help, -h      Show this help message and exit.
   -d, --debug     Display more information about API responses.
   -k, --insecure  Disable SSL certificate check

Read a DNS resource by id.
   the following arguments are required: id, data</textarea>
</p>

<p>
Well, that isn't going to help me, I don't have any idea what the "dnsresource id" would be. Hmmm. Oh, wait. This CLI follows the "collection-instance" rule, that is, listing DNS resources would be part of a collection, so would be pluralized. So, for example, I can read &lt;code&gt;dnsresources~ (plural) and maybe find out something:
</p>

<p>
<textarea cols="80" rows="4">
stormrider@wintermute:~$  maas admin dnsresources read 
Success.
Machine-readable output follows:
[]</textarea>
</p>

<p>
Well. Maybe I should try the CLI documentation. Looking at the "Quick questions" under common tasks, I see there's one about setting a DNS forwarder. Let me check that out. Hmmm, yeah, that might be what I want. There's a easy way to tell: I can check the DNS setting in the MAAS dashboard in the UI, run the CLI command I found, and see if that sets it.
</p>

<p>
Okay, actually, I cheated first. I went and asked my friend Lee, who knows how this works, and I kept asking until I annoyed him. But it's useful to illustrate that there was a way to get this from the doc and experimentation, which I should have done. * Sorry, Lee. Owe you lunch. Maybe that's two lunches. *
</p>

<p>
Hey, in that field, it even says "DNS forwarder" &#x2013; so let me try it:
</p>

<p>
<textarea cols="80" rows="4">
stormrider@wintermute:~$  maas admin maas set-config name=upstream_dns value="8.8.8.8" 
Success.
Machine-readable output follows:
OK</textarea>
</p>

<p>
And it sets it! Woo-hoo, it worked! It wasn't obvious whether I needed to type the IP address with quotes, but I did, and it paid off. I guess I could try it without quotes to see what happens:
</p>

<p>
<textarea cols="80" rows="4">
stormrider@wintermute:~$ maas admin maas set-config name=upstream_dns value=9.9.9.9 
Success.
Machine-readable output follows:
OK</textarea>
</p>

<p>
And that works, too, so I'll change it back real fast before weird things start to happen, since I have no idea what "9.9.9.9" is.
</p>

<p>
note to self:  <i>always</i> RTFM. before annoying my friend Lee. 
</p>
</div>
</div>

<div id="outline-container-orgeca211a" class="outline-6">
<h6 id="orgeca211a">Importing images</h6>
<div class="outline-text-6" id="text-orgeca211a">
<p>
The next thing would be to import images. When I look at the dashboard, it's already been done, but TBH it was already synched when I logged in and opened the dashboard, so it must be automatic for at least one default image. Dunno. But I can bring in some other image (like Ubuntu 16.04 LTS) just to see how that works, and I can figure out how to confirm that the 18.04 (default) image is actually here.
</p>

<p>
Well, this time actually consulting the manual, it says I can confirm 18.04 by entering the following command:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$  maas admin boot-resources read </textarea>
</p>

<p>
The JSON resulting from this command is rather lengthy:
</p>

<p>
<textarea cols="80" rows="80">
Success.
Machine-readable output follows:
[
    {
        "id": 7,
        "type": "Synced",
        "name": "grub-efi-signed/uefi",
        "architecture": "amd64/generic",
        "resource_uri": "/MAAS/api/2.0/boot-resources/7/"
    },
    {
        "id": 8,
        "type": "Synced",
        "name": "grub-efi/uefi",
        "architecture": "arm64/generic",
        "resource_uri": "/MAAS/api/2.0/boot-resources/8/"
    },
    {
        "id": 9,
        "type": "Synced",
        "name": "grub-ieee1275/open-firmware",
        "architecture": "ppc64el/generic",
        "resource_uri": "/MAAS/api/2.0/boot-resources/9/"
    },
    {
        "id": 10,
        "type": "Synced",
        "name": "pxelinux/pxe",
        "architecture": "i386/generic",
        "resource_uri": "/MAAS/api/2.0/boot-resources/10/"
    },
    {
        "id": 1,
        "type": "Synced",
        "name": "ubuntu/bionic",
        "architecture": "amd64/ga-18.04",
        "resource_uri": "/MAAS/api/2.0/boot-resources/1/",
        "subarches": "generic,hwe-p,hwe-q,hwe-r,hwe-s,hwe-t,hwe-u,hwe-v,hwe-w,ga-16.04,ga-16.10,ga-17.04,ga-17.10,ga-18.04"
    },
    {
        "id": 2,
        "type": "Synced",
        "name": "ubuntu/bionic",
        "architecture": "amd64/ga-18.04-lowlatency",
        "resource_uri": "/MAAS/api/2.0/boot-resources/2/",
        "subarches": "generic,hwe-p,hwe-q,hwe-r,hwe-s,hwe-t,hwe-u,hwe-v,hwe-w,ga-16.04,ga-16.10,ga-17.04,ga-17.10,ga-18.04"
    },
    {
        "id": 3,
        "type": "Synced",
        "name": "ubuntu/bionic",
        "architecture": "amd64/hwe-18.04",
        "resource_uri": "/MAAS/api/2.0/boot-resources/3/",
        "subarches": "generic,hwe-p,hwe-q,hwe-r,hwe-s,hwe-t,hwe-u,hwe-v,hwe-w,ga-16.04,ga-16.10,ga-17.04,ga-17.10,ga-18.04"
    },
    {
        "id": 4,
        "type": "Synced",
        "name": "ubuntu/bionic",
        "architecture": "amd64/hwe-18.04-edge",
        "resource_uri": "/MAAS/api/2.0/boot-resources/4/",
        "subarches": "generic,hwe-p,hwe-q,hwe-r,hwe-s,hwe-t,hwe-u,hwe-v,hwe-w,ga-16.04,ga-16.10,ga-17.04,ga-17.10,ga-18.04,hwe-18.10,hwe-19.04"
    },
    {
        "id": 5,
        "type": "Synced",
        "name": "ubuntu/bionic",
        "architecture": "amd64/hwe-18.04-lowlatency",
        "resource_uri": "/MAAS/api/2.0/boot-resources/5/",
        "subarches": "generic,hwe-p,hwe-q,hwe-r,hwe-s,hwe-t,hwe-u,hwe-v,hwe-w,ga-16.04,ga-16.10,ga-17.04,ga-17.10,ga-18.04"
    },
    {
        "id": 6,
        "type": "Synced",
        "name": "ubuntu/bionic",
        "architecture": "amd64/hwe-18.04-lowlatency-edge",
        "resource_uri": "/MAAS/api/2.0/boot-resources/6/",
        "subarches": "generic,hwe-p,hwe-q,hwe-r,hwe-s,hwe-t,hwe-u,hwe-v,hwe-w,ga-16.04,ga-16.10,ga-17.04,ga-17.10,ga-18.04,hwe-18.10,hwe-19.04"
    }
]</textarea>
</p>

<p>
Okay, that's a lot of information, but it looks like I have a bunch of 18.04 images downloaded and synched. Let me try to get a little fancy with a grep and see if I can make that list shorter:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$  maas admin boot-resources read | grep architecture </textarea>
</p>

<p>
This produces a quick list of the images I've successfully downloaded:
</p>

<p>
<textarea cols="80" rows="10">
"architecture": "amd64/generic",
"architecture": "arm64/generic",
"architecture": "ppc64el/generic",
"architecture": "i386/generic",
"architecture": "amd64/ga-18.04",
"architecture": "amd64/ga-18.04-lowlatency",
"architecture": "amd64/hwe-18.04",
"architecture": "amd64/hwe-18.04-edge",
"architecture": "amd64/hwe-18.04-lowlatency",
"architecture": "amd64/hwe-18.04-lowlatency-edge",</textarea>
</p>

<p>
That definitely confirms 18.04. But what are those three or four on top? Looking at the massive JSON output, I can see that they have names like "open-firmware," "uefi," and "pxe." Okay, so those are images that can PXE-boot machines, basically. But how could I sort this information out in a neat way?
</p>
</div>
</div>

<div id="outline-container-orga37f54d" class="outline-6">
<h6 id="orga37f54d">Enter jq</h6>
<div class="outline-text-6" id="text-orga37f54d">
<p>
If you're going to use the MAAS CLI &#x2013; or anything with JSON-based output &#x2013; you'll want to consider learning the command line tool <a href="https://stedolan.github.io/jq/">jq</a>. It's quite handy for parsing the JSON output of the MAAS CLI. So, for example, if I want a (sorta) formatted table of names and architectures, I can run my last command through jq like this:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$  maas admin boot-resources read | jq -r '.[] | "\(.name)\t\(.architecture)"' </textarea>
</p>

<p>
This gives me a clean image list that looks something like this:
</p>

<p>
<textarea cols="80" rows="10">
grub-efi-signed/uefi         amd64/generic
grub-efi/uefi                arm64/generic
grub-ieee1275/open-firmware  ppc64el/generic
pxelinux/pxe                 i386/generic
ubuntu/bionic                amd64/ga-18.04
ubuntu/bionic                amd64/ga-18.04-lowlatency
ubuntu/bionic                amd64/hwe-18.04
ubuntu/bionic                amd64/hwe-18.04-edge
ubuntu/bionic                amd64/hwe-18.04-lowlatency
ubuntu/bionic                amd64/hwe-18.04-lowlatency-edge</textarea>
</p>

<p>
Okay, I cheated just a little there, too: I cleaned up the tabs a little, which wouldn't be quite as well lined-up unless you have a really wide tab setting (which is possible). Even what I did isn't enough to straighten it out totally, but the output is still readable, anyway.
</p>

<p>
So you can see that I basically have (a) the images I need to boot machines, and (b) an 18.04 image (set) to deploy. That's a good start, but let me see if I can pull down another image with the CLI. I know I can select images with the boot-source-selections command, so let me try that with "Trusty" (Xenial Xerus, aka 16.04):
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin boot-source-selections create 1 \
  > os="ubuntu" release="trusty" arches="amd64" subarches="*" \
  > labels="*"
</textarea>
</p>

<p>
The results look like this:
</p>

<p>
<textarea cols="80" rows="18">
Success.
Machine-readable output follows:
{
    "os": "ubuntu",
    "release": "trusty",
    "arches": [
        "amd64"
    ],
    "subarches": [
        "*"
    ],
    "labels": [
        "*"
    ],
    "boot_source_id": 1,
    "id": 2,
    "resource_uri": "/MAAS/api/2.0/boot-sources/1/selections/2/"
}</textarea>
</p>

<p>
And that appeared to work, which is good, because that was a long command to type correctly! Sure enough, if I look back at my "Images" tab in the UI, 14.04 LTS is now "Selected for download." Okay, this CLI seems to be working fairly well, let me just keep going and see if I can get it to download, now.
</p>

<p>
In reality, downloading them &#x2013; ahem, I mean "importing" them &#x2013; is a fairly simple command:
</p>

<p>
<textarea cols="80" rows="4">
stormrider@wintermute:~$ maas admin boot-resources import 
Success.
Machine-readable output follows:
Import of boot resources started</textarea>
</p>

<p>
Now when I switch back to the Images screen, I can see that 14.04 LTS is downloading, which is fantastic. 
</p>
</div>
</div>
</div>

<div id="outline-container-org967e01d" class="outline-5">
<h5 id="org967e01d">Enabling DHCP</h5>
<div class="outline-text-5" id="text-org967e01d">
<p>
Of course, the whole point here is to get machines deployed. The next step is to get DHCP working, which means I have to find the untagged VLAN. In truth, it shouldn't be too hard, because at this point, there still should only be one.
</p>

<p>
In order to turn on DHCP, I need to know two things besides the VLAN name ("untagged"): I need to know the fabric ID and the primary rack controller name. Actually, to start with, all the fabrics will be on the same untagged VLAN, so any fabric will do. In turn, I can find a valid fabric ID by reading it from any subnet, so I'll just pick one I know (192.168.123.0/24, the subnet for my virtual bridge). That means I can find a usable fabric ID like this:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$  maas admin subnet read 192.168.123.0/24 | grep fabric_id 
"fabric_id": 2,</textarea>
</p>

<p>
Then I need to find the name of the primary rack controller. I think it's going to be my laptop hostname, but for purposes of argument, I'll assume that I don't know it and get it this way:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$  maas admin rack-controllers read | grep hostname | cut -d '"' -f 4 
wintermute</textarea>
</p>

<p>
So this would mean I should be able to turn on DHCP like this:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$ maas admin vlan update 2 untagged dhcp_on=True primary_rack=wintermute 
{"dhcp_on": ["dhcp can only be turned on when a dynamic IP range is defined."]}</textarea>
</p>

<p>
Hmm. I need to define a dynamic IP range for this to work. Well, given that my virtual bridge is on 192.168.123.0/24, I think I'll just use that subnet, so let me choose, say, 192.168.123.190 to 192.168.123.253:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$  maas admin ipranges create type=dynamic start_ip=192.168.123.190 end_ip=192.168.123.253 </textarea>
</p>

<p>
The result of this command is:
</p>

<p>
<textarea cols="80" rows="47">
Success.
Machine-readable output follows:
{
    "subnet": {
        "name": "192.168.123.0/24",
        "description": "",
        "vlan": {
            "vid": 0,
            "mtu": 1500,
            "dhcp_on": false,
            "external_dhcp": null,
            "relay_vlan": null,
            "fabric": "fabric-2",
            "primary_rack": null,
            "name": "untagged",
            "id": 5003,
            "space": "undefined",
            "secondary_rack": null,
            "fabric_id": 2,
            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
        },
        "cidr": "192.168.123.0/24",
        "rdns_mode": 2,
        "gateway_ip": null,
        "dns_servers": [],
        "allow_dns": true,
        "allow_proxy": true,
        "active_discovery": false,
        "managed": true,
        "id": 4,
        "space": "undefined",
        "resource_uri": "/MAAS/api/2.0/subnets/4/"
    },
    "type": "dynamic",
    "start_ip": "192.168.123.190",
    "end_ip": "192.168.123.253",
    "user": {
        "is_superuser": true,
        "username": "admin",
        "email": "admin@admin.com",
        "is_local": true,
        "resource_uri": "/MAAS/api/2.0/users/admin/"
    },
    "comment": "",
    "id": 1,
    "resource_uri": "/MAAS/api/2.0/ipranges/1/"
}</textarea>
</p>

<p>
Okay, now let's try that DHCP switch-on one more time:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$  maas admin vlan update 2 untagged dhcp_on=True primary_rack=wintermute </textarea>
</p>

<p>
Now I get something more like I'd like:
</p>

<p>
<textarea cols="80" rows="17">
Success.
Machine-readable output follows:
{
    "vid": 0,
    "mtu": 1500,
    "dhcp_on": true,
    "external_dhcp": null,
    "relay_vlan": null,
    "fabric": "fabric-2",
    "space": "undefined",
    "primary_rack": "8dwnne",
    "secondary_rack": null,
    "name": "untagged",
    "fabric_id": 2,
    "id": 5003,
    "resource_uri": "/MAAS/api/2.0/vlans/5003/"
}</textarea>
</p>

<p>
It says success, and when I look at the UI? Yes, indeed, DHCP is enabled.
</p>
</div>
</div>

<div id="outline-container-orgda81b96" class="outline-5">
<h5 id="orgda81b96">Commissioning machines</h5>
<div class="outline-text-5" id="text-orgda81b96">
<p>
In order to deploy machines, I've got to create some, plain and simple, and then commission them. Normally, I'd do that with the UI, but for this exercise, I'm going to attempt it with the CLI.
</p>

<p>
<textarea cols="80" rows="185">
stormrider@wintermute:~$  maas admin machines create
  &gt; architecture=amd64
  &gt; mac_addresses=52:54:00:15:36:f2
  &gt; power_type=virsh
  &gt; power_parameters_power_id=f677a842-571c-4e65-adc9-11e2cf92d363
  &gt; power_parameters_power_address=qemu+ssh://stormrider@192.168.123.1/system
  &gt; power_parameters_power_pass=xxxxxxxx

Success.
Machine-readable output follows:
{
    "storage": 0.0,
    "tag_names": [],
    "special_filesystems": [],
    "memory": 0,
    "boot_disk": null,
    "virtualblockdevice_set": [],
    "hardware_info": {
        "system_vendor": "Unknown",
        "system_product": "Unknown",
        "system_family": "Unknown",
        "system_version": "Unknown",
        "system_sku": "Unknown",
        "system_serial": "Unknown",
        "cpu_model": "Unknown",
        "mainboard_vendor": "Unknown",
        "mainboard_product": "Unknown",
        "mainboard_serial": "Unknown",
        "mainboard_version": "Unknown",
        "mainboard_firmware_vendor": "Unknown",
        "mainboard_firmware_date": "Unknown",
        "mainboard_firmware_version": "Unknown",
        "chassis_vendor": "Unknown",
        "chassis_type": "Unknown",
        "chassis_serial": "Unknown",
        "chassis_version": "Unknown"
    },
    "address_ttl": null,
    "memory_test_status": -1,
    "other_test_status_name": "Unknown",
    "osystem": "",
    "status_message": "Commissioning",
    "netboot": true,
    "physicalblockdevice_set": [],
    "node_type": 0,
    "cpu_test_status": -1,
    "memory_test_status_name": "Unknown",
    "bcaches": [],
    "storage_test_status": 0,
    "system_id": "bhxws3",
    "status": 1,
    "commissioning_status": 0,
    "power_type": "virsh",
    "locked": false,
    "numanode_set": [
        {
            "index": 0,
            "memory": 0,
            "cores": []
        }
    ],
    "bios_boot_method": null,
    "fqdn": "ace-swan.maas",
    "node_type_name": "Machine",
    "hostname": "ace-swan",
    "volume_groups": [],
    "testing_status": 0,
    "network_test_status": -1,
    "other_test_status": -1,
    "interface_test_status": -1,
    "hwe_kernel": null,
    "blockdevice_set": [],
    "testing_status_name": "Pending",
    "power_state": "unknown",
    "min_hwe_kernel": "",
    "owner": "admin",
    "distro_series": "",
    "storage_test_status_name": "Pending",
    "cpu_speed": 0,
    "swap_size": null,
    "cpu_test_status_name": "Unknown",
    "hardware_uuid": null,
    "architecture": "amd64/generic",
    "pool": {
        "name": "default",
        "description": "Default pool",
        "id": 0,
        "resource_uri": "/MAAS/api/2.0/resourcepool/0/"
    },
    "cache_sets": [],
    "pod": null,
    "iscsiblockdevice_set": [],
    "disable_ipv4": false,
    "status_action": "",
    "boot_interface": {
        "name": "eth0",
        "id": 10,
        "product": null,
        "system_id": "bhxws3",
        "effective_mtu": 1500,
        "children": [],
        "link_connected": true,
        "enabled": true,
        "interface_speed": 0,
        "numa_node": 0,
        "firmware_version": null,
        "parents": [],
        "discovered": null,
        "params": "",
        "links": [],
        "sriov_max_vf": 0,
        "tags": [],
        "type": "physical",
        "vlan": null,
        "vendor": null,
        "link_speed": 0,
        "mac_address": "52:54:00:15:36:f2",
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
    },
    "cpu_count": 0,
    "domain": {
        "authoritative": true,
        "ttl": null,
        "resource_record_count": 0,
        "name": "maas",
        "is_default": true,
        "id": 0,
        "resource_uri": "/MAAS/api/2.0/domains/0/"
    },
    "current_testing_result_id": 7,
    "default_gateways": {
        "ipv4": {
            "gateway_ip": null,
            "link_id": null
        },
        "ipv6": {
            "gateway_ip": null,
            "link_id": null
        }
    },
    "interface_set": [
        {
            "name": "eth0",
            "id": 10,
            "product": null,
            "system_id": "bhxws3",
            "effective_mtu": 1500,
            "children": [],
            "link_connected": true,
            "enabled": true,
            "interface_speed": 0,
            "numa_node": 0,
            "firmware_version": null,
            "parents": [],
            "discovered": null,
            "params": "",
            "links": [],
            "sriov_max_vf": 0,
            "tags": [],
            "type": "physical",
            "vlan": null,
            "vendor": null,
            "link_speed": 0,
            "mac_address": "52:54:00:15:36:f2",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
        }
    ],
    "status_name": "Commissioning",
    "commissioning_status_name": "Pending",
    "owner_data": {},
    "ip_addresses": [],
    "raids": [],
    "network_test_status_name": "Unknown",
    "description": "",
    "current_commissioning_result_id": 6,
    "interface_test_status_name": "Unknown",
    "current_installation_result_id": null,
    "zone": {
        "name": "default",
        "description": "",
        "id": 1,
        "resource_uri": "/MAAS/api/2.0/zones/default/"
    },
    "resource_uri": "/MAAS/api/2.0/machines/bhxws3/"
}</textarea>
</p>

<p>
And just like that, it's already commissioning, just as if I'd created it from the UI. A lot of parameters there are a little hard to discover: They may be somewhere in the documentation, or perhaps they're buried in one of the "read" outputs. I used the help and a couple of other commands to discover the "powerpass" parameter, for example, though I later found it somewhere else in the documentation. Doc is always a work in progress, I guess.
Commissioning by CLI
</p>

<p>
So now I have a machine in the "Ready" state, but I'd like to get familiar with commanding MAAS to commission it via the CLI. All I really need for that is the system ID, which is the last parameter in the "resourceuri" above. But just for grins, let's go ahead and retrieve the system ID using the CLI. There's only one, so I don't have to worry about any other cross-referencing on this machine:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$  maas admin machines read | jq '.[] | .hostname, .system_id' 
"ace-swan"
"bhxws3"</textarea>
</p>

<p>
Okay, now I can use that system ID to commission the machine via the CLI:
</p>

<p>
<textarea cols="80" rows="289">
stormrider@wintermute:~$  maas admin machine commission bhxws3 

Success.
Machine-readable output follows:
{
    "storage_test_status_name": "Pending",
    "bcaches": [],
    "cpu_count": 1,
    "interface_set": [
        {
            "params": "",
            "numa_node": 0,
            "tags": [],
            "id": 10,
            "mac_address": "52:54:00:15:36:f2",
            "vendor": "Red Hat, Inc.",
            "children": [],
            "effective_mtu": 1500,
            "discovered": [],
            "links": [],
            "link_speed": 0,
            "link_connected": true,
            "system_id": "bhxws3",
            "enabled": true,
            "interface_speed": 0,
            "firmware_version": null,
            "name": "ens3",
            "sriov_max_vf": 0,
            "product": null,
            "vlan": {
                "vid": 0,
                "mtu": 1500,
                "dhcp_on": true,
                "external_dhcp": null,
                "relay_vlan": null,
                "fabric": "fabric-2",
                "primary_rack": "8dwnne",
                "name": "untagged",
                "id": 5003,
                "space": "undefined",
                "secondary_rack": null,
                "fabric_id": 2,
                "resource_uri": "/MAAS/api/2.0/vlans/5003/"
            },
            "parents": [],
            "type": "physical",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
        }
    ],
    "network_test_status_name": "Unknown",
    "numanode_set": [
        {
            "index": 0,
            "memory": 985,
            "cores": [
                0
            ]
        }
    ],
    "locked": false,
    "hardware_uuid": "F677A842-571C-4E65-ADC9-11E2CF92D363",
    "default_gateways": {
        "ipv4": {
            "gateway_ip": null,
            "link_id": null
        },
        "ipv6": {
            "gateway_ip": null,
            "link_id": null
        }
    },
    "status_action": "",
    "status_message": "Commissioning",
    "cpu_test_status_name": "Unknown",
    "memory_test_status": -1,
    "virtualblockdevice_set": [],
    "pool": {
        "name": "default",
        "description": "Default pool",
        "id": 0,
        "resource_uri": "/MAAS/api/2.0/resourcepool/0/"
    },
    "current_testing_result_id": 9,
    "current_installation_result_id": null,
    "netboot": true,
    "description": "",
    "special_filesystems": [],
    "testing_status": 0,
    "memory": 1024,
    "current_commissioning_result_id": 8,
    "storage": 5368.70912,
    "commissioning_status": 0,
    "cpu_test_status": -1,
    "tag_names": [
        "virtual"
    ],
    "memory_test_status_name": "Unknown",
    "swap_size": null,
    "status_name": "Commissioning",
    "other_test_status": -1,
    "pod": null,
    "storage_test_status": 0,
    "blockdevice_set": [
        {
            "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
            "size": 5368709120,
            "block_size": 512,
            "tags": [
                "ssd"
            ],
            "serial": "QM00001",
            "uuid": null,
            "numa_node": 0,
            "available_size": 5368709120,
            "id": 3,
            "partition_table_type": null,
            "model": "QEMU HARDDISK",
            "path": "/dev/disk/by-dname/sda",
            "storage_pool": null,
            "used_for": "Unused",
            "filesystem": null,
            "system_id": "bhxws3",
            "used_size": 0,
            "partitions": [],
            "name": "sda",
            "type": "physical",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
        }
    ],
    "other_test_status_name": "Unknown",
    "distro_series": "",
    "testing_status_name": "Pending",
    "ip_addresses": [],
    "address_ttl": null,
    "system_id": "bhxws3",
    "physicalblockdevice_set": [
        {
            "firmware_version": "2.5+",
            "serial": "QM00001",
            "uuid": null,
            "numa_node": 0,
            "available_size": 5368709120,
            "size": 5368709120,
            "tags": [
                "ssd"
            ],
            "id": 3,
            "partition_table_type": null,
            "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
            "model": "QEMU HARDDISK",
            "path": "/dev/disk/by-dname/sda",
            "storage_pool": null,
            "used_for": "Unused",
            "filesystem": null,
            "system_id": "bhxws3",
            "used_size": 0,
            "partitions": [],
            "name": "sda",
            "block_size": 512,
            "type": "physical",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
        }
    ],
    "fqdn": "ace-swan.maas",
    "osystem": "",
    "domain": {
        "authoritative": true,
        "ttl": null,
        "resource_record_count": 0,
        "name": "maas",
        "id": 0,
        "is_default": true,
        "resource_uri": "/MAAS/api/2.0/domains/0/"
    },
    "boot_interface": {
        "params": "",
        "numa_node": 0,
        "tags": [],
        "id": 10,
        "mac_address": "52:54:00:15:36:f2",
        "vendor": "Red Hat, Inc.",
        "children": [],
        "effective_mtu": 1500,
        "discovered": [],
        "links": [],
        "link_speed": 0,
        "link_connected": true,
        "system_id": "bhxws3",
        "enabled": true,
        "interface_speed": 0,
        "firmware_version": null,
        "name": "ens3",
        "sriov_max_vf": 0,
        "product": null,
        "vlan": {
            "vid": 0,
            "mtu": 1500,
            "dhcp_on": true,
            "external_dhcp": null,
            "relay_vlan": null,
            "fabric": "fabric-2",
            "primary_rack": "8dwnne",
            "name": "untagged",
            "id": 5003,
            "space": "undefined",
            "secondary_rack": null,
            "fabric_id": 2,
            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
        },
        "parents": [],
        "type": "physical",
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
    },
    "hostname": "ace-swan",
    "network_test_status": -1,
    "min_hwe_kernel": "",
    "power_state": "off",
    "interface_test_status_name": "Unknown",
    "owner_data": {},
    "volume_groups": [],
    "power_type": "virsh",
    "node_type": 0,
    "owner": "admin",
    "cache_sets": [],
    "architecture": "amd64/generic",
    "hwe_kernel": null,
    "zone": {
        "name": "default",
        "description": "",
        "id": 1,
        "resource_uri": "/MAAS/api/2.0/zones/default/"
    },
    "disable_ipv4": false,
    "boot_disk": {
        "firmware_version": "2.5+",
        "serial": "QM00001",
        "uuid": null,
        "numa_node": 0,
        "available_size": 5368709120,
        "size": 5368709120,
        "tags": [
            "ssd"
        ],
        "id": 3,
        "partition_table_type": null,
        "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
        "model": "QEMU HARDDISK",
        "path": "/dev/disk/by-dname/sda",
        "storage_pool": null,
        "used_for": "Unused",
        "filesystem": null,
        "system_id": "bhxws3",
        "used_size": 0,
        "partitions": [],
        "name": "sda",
        "block_size": 512,
        "type": "physical",
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
    },
    "status": 1,
    "iscsiblockdevice_set": [],
    "raids": [],
    "node_type_name": "Machine",
    "hardware_info": {
        "system_vendor": "QEMU",
        "system_product": "Standard PC (i440FX + PIIX, 1996)",
        "system_family": "Unknown",
        "system_version": "pc-i440fx-focal",
        "system_sku": "Unknown",
        "system_serial": "Unknown",
        "cpu_model": "Intel Core Processor (Skylake, IBRS)",
        "mainboard_vendor": "Unknown",
        "mainboard_product": "Unknown",
        "mainboard_serial": "Unknown",
        "mainboard_version": "Unknown",
        "mainboard_firmware_vendor": "SeaBIOS",
        "mainboard_firmware_date": "04/01/2014",
        "mainboard_firmware_version": "1.13.0-1ubuntu1",
        "chassis_vendor": "QEMU",
        "chassis_type": "Other",
        "chassis_serial": "Unknown",
        "chassis_version": "pc-i440fx-focal"
    },
    "commissioning_status_name": "Pending",
    "bios_boot_method": "pxe",
    "interface_test_status": -1,
    "cpu_speed": 0,
    "resource_uri": "/MAAS/api/2.0/machines/bhxws3/"
}</textarea>
</p>

<p>
And that's it, it's that easy. It takes a minute to get all the parameters together to create a new machine, but it doesn't seem that difficult to me. 
</p>
</div>
</div>

<div id="outline-container-org83197a3" class="outline-5">
<h5 id="org83197a3">Deploying machines</h5>
<div class="outline-text-5" id="text-org83197a3">
<p>
I guess now it's time to acquire and deploy my commissioned machine.
</p>
</div>

<div id="outline-container-orgfc45915" class="outline-6">
<h6 id="orgfc45915">Acquiring a machine using the CLI</h6>
<div class="outline-text-6" id="text-orgfc45915">
<p>
When it's finished commissioning, I can acquire a machine like this:
</p>

<p>
<textarea cols="80" rows="493">
stormrider@wintermute:~$ maas admin machines allocate system_id=bhxws3

Success.
Machine-readable output follows:
{
    "raids": [],
    "zone": {
        "name": "default",
        "description": "",
        "id": 1,
        "resource_uri": "/MAAS/api/2.0/zones/default/"
    },
    "current_commissioning_result_id": 8,
    "storage_test_status": 2,
    "current_testing_result_id": 9,
    "bcaches": [],
    "ip_addresses": [
        "192.168.123.190"
    ],
    "pool": {
        "name": "default",
        "description": "Default pool",
        "id": 0,
        "resource_uri": "/MAAS/api/2.0/resourcepool/0/"
    },
    "physicalblockdevice_set": [
        {
            "firmware_version": "2.5+",
            "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
            "system_id": "bhxws3",
            "partition_table_type": "GPT",
            "type": "physical",
            "block_size": 512,
            "id": 3,
            "numa_node": 0,
            "partitions": [
                {
                    "uuid": "8aa1164c-8a91-41d7-92e3-c411634355bb",
                    "size": 5360320512,
                    "bootable": false,
                    "tags": [],
                    "id": 3,
                    "used_for": "ext4 formatted filesystem mounted at /",
                    "device_id": 3,
                    "system_id": "bhxws3",
                    "path": "/dev/disk/by-dname/sda-part2",
                    "type": "partition",
                    "filesystem": {
                        "fstype": "ext4",
                        "label": "root",
                        "uuid": "68487852-7e38-4605-a84e-d787532fd443",
                        "mount_point": "/",
                        "mount_options": null
                    },
                    "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/partition/3"
                }
            ],
            "filesystem": null,
            "available_size": 0,
            "size": 5368709120,
            "storage_pool": null,
            "model": "QEMU HARDDISK",
            "used_size": 5366611968,
            "tags": [
                "ssd"
            ],
            "used_for": "GPT partitioned with 1 partition",
            "uuid": null,
            "name": "sda",
            "path": "/dev/disk/by-dname/sda",
            "serial": "QM00001",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
        }
    ],
    "swap_size": null,
    "storage": 5368.70912,
    "node_type_name": "Machine",
    "system_id": "bhxws3",
    "owner_data": {},
    "special_filesystems": [],
    "tag_names": [
        "virtual"
    ],
    "cpu_test_status_name": "Unknown",
    "locked": false,
    "cpu_count": 1,
    "volume_groups": [],
    "storage_test_status_name": "Passed",
    "hardware_info": {
        "system_vendor": "QEMU",
        "system_product": "Standard PC (i440FX + PIIX, 1996)",
        "system_family": "Unknown",
        "system_version": "pc-i440fx-focal",
        "system_sku": "Unknown",
        "system_serial": "Unknown",
        "cpu_model": "Intel Core Processor (Skylake, IBRS)",
        "mainboard_vendor": "Unknown",
        "mainboard_product": "Unknown",
        "mainboard_serial": "Unknown",
        "mainboard_version": "Unknown",
        "mainboard_firmware_vendor": "SeaBIOS",
        "mainboard_firmware_date": "04/01/2014",
        "mainboard_firmware_version": "1.13.0-1ubuntu1",
        "chassis_vendor": "QEMU",
        "chassis_type": "Other",
        "chassis_serial": "Unknown",
        "chassis_version": "pc-i440fx-focal"
    },
    "node_type": 0,
    "other_test_status": -1,
    "hostname": "ace-swan",
    "interface_test_status": -1,
    "boot_interface": {
        "link_speed": 0,
        "params": "",
        "vendor": "Red Hat, Inc.",
        "firmware_version": null,
        "system_id": "bhxws3",
        "enabled": true,
        "type": "physical",
        "links": [
            {
                "id": 15,
                "mode": "auto",
                "subnet": {
                    "name": "192.168.123.0/24",
                    "description": "",
                    "vlan": {
                        "vid": 0,
                        "mtu": 1500,
                        "dhcp_on": true,
                        "external_dhcp": null,
                        "relay_vlan": null,
                        "fabric": "fabric-2",
                        "id": 5003,
                        "secondary_rack": null,
                        "primary_rack": "8dwnne",
                        "name": "untagged",
                        "fabric_id": 2,
                        "space": "undefined",
                        "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                    },
                    "cidr": "192.168.123.0/24",
                    "rdns_mode": 2,
                    "gateway_ip": null,
                    "dns_servers": [],
                    "allow_dns": true,
                    "allow_proxy": true,
                    "active_discovery": false,
                    "managed": true,
                    "id": 4,
                    "space": "undefined",
                    "resource_uri": "/MAAS/api/2.0/subnets/4/"
                }
            }
        ],
        "id": 10,
        "discovered": [
            {
                "subnet": {
                    "name": "192.168.123.0/24",
                    "description": "",
                    "vlan": {
                        "vid": 0,
                        "mtu": 1500,
                        "dhcp_on": true,
                        "external_dhcp": null,
                        "relay_vlan": null,
                        "fabric": "fabric-2",
                        "id": 5003,
                        "secondary_rack": null,
                        "primary_rack": "8dwnne",
                        "name": "untagged",
                        "fabric_id": 2,
                        "space": "undefined",
                        "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                    },
                    "cidr": "192.168.123.0/24",
                    "rdns_mode": 2,
                    "gateway_ip": null,
                    "dns_servers": [],
                    "allow_dns": true,
                    "allow_proxy": true,
                    "active_discovery": false,
                    "managed": true,
                    "id": 4,
                    "space": "undefined",
                    "resource_uri": "/MAAS/api/2.0/subnets/4/"
                },
                "ip_address": "192.168.123.190"
            }
        ],
        "numa_node": 0,
        "children": [],
        "parents": [],
        "link_connected": true,
        "effective_mtu": 1500,
        "tags": [],
        "sriov_max_vf": 0,
        "interface_speed": 0,
        "name": "ens3",
        "mac_address": "52:54:00:15:36:f2",
        "product": null,
        "vlan": {
            "vid": 0,
            "mtu": 1500,
            "dhcp_on": true,
            "external_dhcp": null,
            "relay_vlan": null,
            "fabric": "fabric-2",
            "id": 5003,
            "secondary_rack": null,
            "primary_rack": "8dwnne",
            "name": "untagged",
            "fabric_id": 2,
            "space": "undefined",
            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
        },
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
    },
    "memory": 1024,
    "memory_test_status_name": "Unknown",
    "default_gateways": {
        "ipv4": {
            "gateway_ip": null,
            "link_id": null
        },
        "ipv6": {
            "gateway_ip": null,
            "link_id": null
        }
    },
    "blockdevice_set": [
        {
            "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
            "size": 5368709120,
            "block_size": 512,
            "tags": [
                "ssd"
            ],
            "system_id": "bhxws3",
            "partition_table_type": "GPT",
            "type": "physical",
            "id": 3,
            "numa_node": 0,
            "partitions": [
                {
                    "uuid": "8aa1164c-8a91-41d7-92e3-c411634355bb",
                    "size": 5360320512,
                    "bootable": false,
                    "tags": [],
                    "id": 3,
                    "used_for": "ext4 formatted filesystem mounted at /",
                    "device_id": 3,
                    "system_id": "bhxws3",
                    "path": "/dev/disk/by-dname/sda-part2",
                    "type": "partition",
                    "filesystem": {
                        "fstype": "ext4",
                        "label": "root",
                        "uuid": "68487852-7e38-4605-a84e-d787532fd443",
                        "mount_point": "/",
                        "mount_options": null
                    },
                    "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/partition/3"
                }
            ],
            "filesystem": null,
            "available_size": 0,
            "storage_pool": null,
            "model": "QEMU HARDDISK",
            "used_size": 5366611968,
            "used_for": "GPT partitioned with 1 partition",
            "uuid": null,
            "name": "sda",
            "path": "/dev/disk/by-dname/sda",
            "serial": "QM00001",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
        }
    ],
    "interface_set": [
        {
            "link_speed": 0,
            "params": "",
            "vendor": "Red Hat, Inc.",
            "firmware_version": null,
            "system_id": "bhxws3",
            "enabled": true,
            "type": "physical",
            "links": [
                {
                    "id": 15,
                    "mode": "auto",
                    "subnet": {
                        "name": "192.168.123.0/24",
                        "description": "",
                        "vlan": {
                            "vid": 0,
                            "mtu": 1500,
                            "dhcp_on": true,
                            "external_dhcp": null,
                            "relay_vlan": null,
                            "fabric": "fabric-2",
                            "id": 5003,
                            "secondary_rack": null,
                            "primary_rack": "8dwnne",
                            "name": "untagged",
                            "fabric_id": 2,
                            "space": "undefined",
                            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                        },
                        "cidr": "192.168.123.0/24",
                        "rdns_mode": 2,
                        "gateway_ip": null,
                        "dns_servers": [],
                        "allow_dns": true,
                        "allow_proxy": true,
                        "active_discovery": false,
                        "managed": true,
                        "id": 4,
                        "space": "undefined",
                        "resource_uri": "/MAAS/api/2.0/subnets/4/"
                    }
                }
            ],
            "id": 10,
            "discovered": [
                {
                    "subnet": {
                        "name": "192.168.123.0/24",
                        "description": "",
                        "vlan": {
                            "vid": 0,
                            "mtu": 1500,
                            "dhcp_on": true,
                            "external_dhcp": null,
                            "relay_vlan": null,
                            "fabric": "fabric-2",
                            "id": 5003,
                            "secondary_rack": null,
                            "primary_rack": "8dwnne",
                            "name": "untagged",
                            "fabric_id": 2,
                            "space": "undefined",
                            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                        },
                        "cidr": "192.168.123.0/24",
                        "rdns_mode": 2,
                        "gateway_ip": null,
                        "dns_servers": [],
                        "allow_dns": true,
                        "allow_proxy": true,
                        "active_discovery": false,
                        "managed": true,
                        "id": 4,
                        "space": "undefined",
                        "resource_uri": "/MAAS/api/2.0/subnets/4/"
                    },
                    "ip_address": "192.168.123.190"
                }
            ],
            "numa_node": 0,
            "children": [],
            "parents": [],
            "link_connected": true,
            "effective_mtu": 1500,
            "tags": [],
            "sriov_max_vf": 0,
            "interface_speed": 0,
            "name": "ens3",
            "mac_address": "52:54:00:15:36:f2",
            "product": null,
            "vlan": {
                "vid": 0,
                "mtu": 1500,
                "dhcp_on": true,
                "external_dhcp": null,
                "relay_vlan": null,
                "fabric": "fabric-2",
                "id": 5003,
                "secondary_rack": null,
                "primary_rack": "8dwnne",
                "name": "untagged",
                "fabric_id": 2,
                "space": "undefined",
                "resource_uri": "/MAAS/api/2.0/vlans/5003/"
            },
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
        }
    ],
    "numanode_set": [
        {
            "index": 0,
            "memory": 985,
            "cores": [
                0
            ]
        }
    ],
    "min_hwe_kernel": "",
    "memory_test_status": -1,
    "power_type": "virsh",
    "power_state": "off",
    "status": 10,
    "testing_status_name": "Passed",
    "interface_test_status_name": "Unknown",
    "cache_sets": [],
    "constraints_by_type": {},
    "domain": {
        "authoritative": true,
        "ttl": null,
        "id": 0,
        "resource_record_count": 0,
        "name": "maas",
        "is_default": true,
        "resource_uri": "/MAAS/api/2.0/domains/0/"
    },
    "network_test_status": -1,
    "current_installation_result_id": null,
    "bios_boot_method": "pxe",
    "status_name": "Allocated",
    "address_ttl": null,
    "fqdn": "ace-swan.maas",
    "cpu_speed": 0,
    "hwe_kernel": null,
    "description": "",
    "commissioning_status_name": "Passed",
    "pod": null,
    "network_test_status_name": "Unknown",
    "hardware_uuid": "F677A842-571C-4E65-ADC9-11E2CF92D363",
    "commissioning_status": 2,
    "status_message": "Ready",
    "owner": "admin",
    "distro_series": "",
    "status_action": "",
    "testing_status": 2,
    "cpu_test_status": -1,
    "architecture": "amd64/generic",
    "netboot": true,
    "iscsiblockdevice_set": [],
    "disable_ipv4": false,
    "virtualblockdevice_set": [],
    "osystem": "",
    "boot_disk": {
        "firmware_version": "2.5+",
        "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
        "system_id": "bhxws3",
        "partition_table_type": "GPT",
        "type": "physical",
        "block_size": 512,
        "id": 3,
        "numa_node": 0,
        "partitions": [
            {
                "uuid": "8aa1164c-8a91-41d7-92e3-c411634355bb",
                "size": 5360320512,
                "bootable": false,
                "tags": [],
                "id": 3,
                "used_for": "ext4 formatted filesystem mounted at /",
                "device_id": 3,
                "system_id": "bhxws3",
                "path": "/dev/disk/by-dname/sda-part2",
                "type": "partition",
                "filesystem": {
                    "fstype": "ext4",
                    "label": "root",
                    "uuid": "68487852-7e38-4605-a84e-d787532fd443",
                    "mount_point": "/",
                    "mount_options": null
                },
                "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/partition/3"
            }
        ],
        "filesystem": null,
        "available_size": 0,
        "size": 5368709120,
        "storage_pool": null,
        "model": "QEMU HARDDISK",
        "used_size": 5366611968,
        "tags": [
            "ssd"
        ],
        "used_for": "GPT partitioned with 1 partition",
        "uuid": null,
        "name": "sda",
        "path": "/dev/disk/by-dname/sda",
        "serial": "QM00001",
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
    },
    "other_test_status_name": "Unknown",
    "resource_uri": "/MAAS/api/2.0/machines/bhxws3/"
}</textarea>
</p>
</div>
</div>

<div id="outline-container-org660f49c" class="outline-6">
<h6 id="org660f49c">Deploying a machine with the CLI</h6>
<div class="outline-text-6" id="text-org660f49c">
<p>
Having once acquired the machine, which basically gives my username control, I can deploy the machine this way:
</p>

<p>
<textarea cols="80" rows="492">
stormrider@wintermute:~$  maas admin machine deploy bhxws3 

Success.
Machine-readable output follows:
{
    "architecture": "amd64/generic",
    "cpu_speed": 0,
    "tag_names": [
        "virtual"
    ],
    "boot_interface": {
        "mac_address": "52:54:00:15:36:f2",
        "links": [
            {
                "id": 15,
                "mode": "auto",
                "subnet": {
                    "name": "192.168.123.0/24",
                    "description": "",
                    "vlan": {
                        "vid": 0,
                        "mtu": 1500,
                        "dhcp_on": true,
                        "external_dhcp": null,
                        "relay_vlan": null,
                        "fabric_id": 2,
                        "id": 5003,
                        "fabric": "fabric-2",
                        "secondary_rack": null,
                        "name": "untagged",
                        "space": "undefined",
                        "primary_rack": "8dwnne",
                        "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                    },
                    "cidr": "192.168.123.0/24",
                    "rdns_mode": 2,
                    "gateway_ip": null,
                    "dns_servers": [],
                    "allow_dns": true,
                    "allow_proxy": true,
                    "active_discovery": false,
                    "managed": true,
                    "id": 4,
                    "space": "undefined",
                    "resource_uri": "/MAAS/api/2.0/subnets/4/"
                }
            }
        ],
        "numa_node": 0,
        "enabled": true,
        "params": "",
        "firmware_version": null,
        "sriov_max_vf": 0,
        "type": "physical",
        "children": [],
        "vendor": "Red Hat, Inc.",
        "system_id": "bhxws3",
        "parents": [],
        "vlan": {
            "vid": 0,
            "mtu": 1500,
            "dhcp_on": true,
            "external_dhcp": null,
            "relay_vlan": null,
            "fabric_id": 2,
            "id": 5003,
            "fabric": "fabric-2",
            "secondary_rack": null,
            "name": "untagged",
            "space": "undefined",
            "primary_rack": "8dwnne",
            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
        },
        "link_connected": true,
        "id": 10,
        "effective_mtu": 1500,
        "discovered": [
            {
                "subnet": {
                    "name": "192.168.123.0/24",
                    "description": "",
                    "vlan": {
                        "vid": 0,
                        "mtu": 1500,
                        "dhcp_on": true,
                        "external_dhcp": null,
                        "relay_vlan": null,
                        "fabric_id": 2,
                        "id": 5003,
                        "fabric": "fabric-2",
                        "secondary_rack": null,
                        "name": "untagged",
                        "space": "undefined",
                        "primary_rack": "8dwnne",
                        "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                    },
                    "cidr": "192.168.123.0/24",
                    "rdns_mode": 2,
                    "gateway_ip": null,
                    "dns_servers": [],
                    "allow_dns": true,
                    "allow_proxy": true,
                    "active_discovery": false,
                    "managed": true,
                    "id": 4,
                    "space": "undefined",
                    "resource_uri": "/MAAS/api/2.0/subnets/4/"
                },
                "ip_address": "192.168.123.190"
            }
        ],
        "link_speed": 0,
        "name": "ens3",
        "product": null,
        "interface_speed": 0,
        "tags": [],
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
    },
    "ip_addresses": [
        "192.168.123.190"
    ],
    "testing_status_name": "Passed",
    "osystem": "ubuntu",
    "bcaches": [],
    "owner": "admin",
    "special_filesystems": [],
    "numanode_set": [
        {
            "index": 0,
            "memory": 985,
            "cores": [
                0
            ]
        }
    ],
    "node_type": 0,
    "cpu_test_status": -1,
    "storage_test_status_name": "Passed",
    "locked": false,
    "disable_ipv4": false,
    "status_message": "Deploying",
    "other_test_status_name": "Unknown",
    "interface_test_status_name": "Unknown",
    "status_name": "Deploying",
    "commissioning_status": 2,
    "hardware_uuid": "F677A842-571C-4E65-ADC9-11E2CF92D363",
    "fqdn": "ace-swan.maas",
    "min_hwe_kernel": "",
    "network_test_status": -1,
    "iscsiblockdevice_set": [],
    "current_testing_result_id": 9,
    "interface_test_status": -1,
    "status_action": "",
    "pool": {
        "name": "default",
        "description": "Default pool",
        "id": 0,
        "resource_uri": "/MAAS/api/2.0/resourcepool/0/"
    },
    "netboot": true,
    "distro_series": "bionic",
    "current_installation_result_id": 10,
    "memory_test_status_name": "Unknown",
    "cpu_count": 1,
    "hwe_kernel": "ga-18.04",
    "description": "",
    "current_commissioning_result_id": 8,
    "cpu_test_status_name": "Unknown",
    "storage_test_status": 2,
    "hardware_info": {
        "system_vendor": "QEMU",
        "system_product": "Standard PC (i440FX + PIIX, 1996)",
        "system_family": "Unknown",
        "system_version": "pc-i440fx-focal",
        "system_sku": "Unknown",
        "system_serial": "Unknown",
        "cpu_model": "Intel Core Processor (Skylake, IBRS)",
        "mainboard_vendor": "Unknown",
        "mainboard_product": "Unknown",
        "mainboard_serial": "Unknown",
        "mainboard_version": "Unknown",
        "mainboard_firmware_vendor": "SeaBIOS",
        "mainboard_firmware_date": "04/01/2014",
        "mainboard_firmware_version": "1.13.0-1ubuntu1",
        "chassis_vendor": "QEMU",
        "chassis_type": "Other",
        "chassis_serial": "Unknown",
        "chassis_version": "pc-i440fx-focal"
    },
    "bios_boot_method": "pxe",
    "storage": 5368.70912,
    "blockdevice_set": [
        {
            "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
            "size": 5368709120,
            "block_size": 512,
            "tags": [
                "ssd"
            ],
            "numa_node": 0,
            "partition_table_type": "GPT",
            "storage_pool": null,
            "type": "physical",
            "filesystem": null,
            "model": "QEMU HARDDISK",
            "used_size": 5366611968,
            "serial": "QM00001",
            "system_id": "bhxws3",
            "uuid": null,
            "available_size": 0,
            "path": "/dev/disk/by-dname/sda",
            "id": 3,
            "name": "sda",
            "partitions": [
                {
                    "uuid": "8aa1164c-8a91-41d7-92e3-c411634355bb",
                    "size": 5360320512,
                    "bootable": false,
                    "tags": [],
                    "path": "/dev/disk/by-dname/sda-part2",
                    "device_id": 3,
                    "type": "partition",
                    "id": 3,
                    "system_id": "bhxws3",
                    "filesystem": {
                        "fstype": "ext4",
                        "label": "root",
                        "uuid": "68487852-7e38-4605-a84e-d787532fd443",
                        "mount_point": "/",
                        "mount_options": null
                    },
                    "used_for": "ext4 formatted filesystem mounted at /",
                    "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/partition/3"
                }
            ],
            "used_for": "GPT partitioned with 1 partition",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
        }
    ],
    "system_id": "bhxws3",
    "boot_disk": {
        "firmware_version": "2.5+",
        "tags": [
            "ssd"
        ],
        "numa_node": 0,
        "partition_table_type": "GPT",
        "size": 5368709120,
        "storage_pool": null,
        "type": "physical",
        "block_size": 512,
        "filesystem": null,
        "model": "QEMU HARDDISK",
        "used_size": 5366611968,
        "serial": "QM00001",
        "system_id": "bhxws3",
        "uuid": null,
        "available_size": 0,
        "path": "/dev/disk/by-dname/sda",
        "id": 3,
        "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
        "name": "sda",
        "partitions": [
            {
                "uuid": "8aa1164c-8a91-41d7-92e3-c411634355bb",
                "size": 5360320512,
                "bootable": false,
                "tags": [],
                "path": "/dev/disk/by-dname/sda-part2",
                "device_id": 3,
                "type": "partition",
                "id": 3,
                "system_id": "bhxws3",
                "filesystem": {
                    "fstype": "ext4",
                    "label": "root",
                    "uuid": "68487852-7e38-4605-a84e-d787532fd443",
                    "mount_point": "/",
                    "mount_options": null
                },
                "used_for": "ext4 formatted filesystem mounted at /",
                "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/partition/3"
            }
        ],
        "used_for": "GPT partitioned with 1 partition",
        "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
    },
    "default_gateways": {
        "ipv4": {
            "gateway_ip": null,
            "link_id": null
        },
        "ipv6": {
            "gateway_ip": null,
            "link_id": null
        }
    },
    "raids": [],
    "cache_sets": [],
    "domain": {
        "authoritative": true,
        "ttl": null,
        "is_default": true,
        "id": 0,
        "name": "maas",
        "resource_record_count": 0,
        "resource_uri": "/MAAS/api/2.0/domains/0/"
    },
    "hostname": "ace-swan",
    "virtualblockdevice_set": [],
    "memory": 1024,
    "owner_data": {},
    "zone": {
        "name": "default",
        "description": "",
        "id": 1,
        "resource_uri": "/MAAS/api/2.0/zones/default/"
    },
    "power_state": "off",
    "status": 9,
    "address_ttl": null,
    "other_test_status": -1,
    "volume_groups": [],
    "power_type": "virsh",
    "pod": null,
    "testing_status": 2,
    "physicalblockdevice_set": [
        {
            "firmware_version": "2.5+",
            "tags": [
                "ssd"
            ],
            "numa_node": 0,
            "partition_table_type": "GPT",
            "size": 5368709120,
            "storage_pool": null,
            "type": "physical",
            "block_size": 512,
            "filesystem": null,
            "model": "QEMU HARDDISK",
            "used_size": 5366611968,
            "serial": "QM00001",
            "system_id": "bhxws3",
            "uuid": null,
            "available_size": 0,
            "path": "/dev/disk/by-dname/sda",
            "id": 3,
            "id_path": "/dev/disk/by-id/ata-QEMU_HARDDISK_QM00001",
            "name": "sda",
            "partitions": [
                {
                    "uuid": "8aa1164c-8a91-41d7-92e3-c411634355bb",
                    "size": 5360320512,
                    "bootable": false,
                    "tags": [],
                    "path": "/dev/disk/by-dname/sda-part2",
                    "device_id": 3,
                    "type": "partition",
                    "id": 3,
                    "system_id": "bhxws3",
                    "filesystem": {
                        "fstype": "ext4",
                        "label": "root",
                        "uuid": "68487852-7e38-4605-a84e-d787532fd443",
                        "mount_point": "/",
                        "mount_options": null
                    },
                    "used_for": "ext4 formatted filesystem mounted at /",
                    "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/partition/3"
                }
            ],
            "used_for": "GPT partitioned with 1 partition",
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/blockdevices/3/"
        }
    ],
    "interface_set": [
        {
            "mac_address": "52:54:00:15:36:f2",
            "links": [
                {
                    "id": 15,
                    "mode": "auto",
                    "subnet": {
                        "name": "192.168.123.0/24",
                        "description": "",
                        "vlan": {
                            "vid": 0,
                            "mtu": 1500,
                            "dhcp_on": true,
                            "external_dhcp": null,
                            "relay_vlan": null,
                            "fabric_id": 2,
                            "id": 5003,
                            "fabric": "fabric-2",
                            "secondary_rack": null,
                            "name": "untagged",
                            "space": "undefined",
                            "primary_rack": "8dwnne",
                            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                        },
                        "cidr": "192.168.123.0/24",
                        "rdns_mode": 2,
                        "gateway_ip": null,
                        "dns_servers": [],
                        "allow_dns": true,
                        "allow_proxy": true,
                        "active_discovery": false,
                        "managed": true,
                        "id": 4,
                        "space": "undefined",
                        "resource_uri": "/MAAS/api/2.0/subnets/4/"
                    }
                }
            ],
            "numa_node": 0,
            "enabled": true,
            "params": "",
            "firmware_version": null,
            "sriov_max_vf": 0,
            "type": "physical",
            "children": [],
            "vendor": "Red Hat, Inc.",
            "system_id": "bhxws3",
            "parents": [],
            "vlan": {
                "vid": 0,
                "mtu": 1500,
                "dhcp_on": true,
                "external_dhcp": null,
                "relay_vlan": null,
                "fabric_id": 2,
                "id": 5003,
                "fabric": "fabric-2",
                "secondary_rack": null,
                "name": "untagged",
                "space": "undefined",
                "primary_rack": "8dwnne",
                "resource_uri": "/MAAS/api/2.0/vlans/5003/"
            },
            "link_connected": true,
            "id": 10,
            "effective_mtu": 1500,
            "discovered": [
                {
                    "subnet": {
                        "name": "192.168.123.0/24",
                        "description": "",
                        "vlan": {
                            "vid": 0,
                            "mtu": 1500,
                            "dhcp_on": true,
                            "external_dhcp": null,
                            "relay_vlan": null,
                            "fabric_id": 2,
                            "id": 5003,
                            "fabric": "fabric-2",
                            "secondary_rack": null,
                            "name": "untagged",
                            "space": "undefined",
                            "primary_rack": "8dwnne",
                            "resource_uri": "/MAAS/api/2.0/vlans/5003/"
                        },
                        "cidr": "192.168.123.0/24",
                        "rdns_mode": 2,
                        "gateway_ip": null,
                        "dns_servers": [],
                        "allow_dns": true,
                        "allow_proxy": true,
                        "active_discovery": false,
                        "managed": true,
                        "id": 4,
                        "space": "undefined",
                        "resource_uri": "/MAAS/api/2.0/subnets/4/"
                    },
                    "ip_address": "192.168.123.190"
                }
            ],
            "link_speed": 0,
            "name": "ens3",
            "product": null,
            "interface_speed": 0,
            "tags": [],
            "resource_uri": "/MAAS/api/2.0/nodes/bhxws3/interfaces/10/"
        }
    ],
    "node_type_name": "Machine",
    "commissioning_status_name": "Passed",
    "network_test_status_name": "Unknown",
    "memory_test_status": -1,
    "swap_size": null,
    "resource_uri": "/MAAS/api/2.0/machines/bhxws3/"
}</textarea>
</p>

<p>
Okay, done with that much. I have installed and configured MAAS, started DHCP, created a machine, commissioned it, acquired it, and deployed it without touching the UI.
</p>
</div>
</div>
</div>

<div id="outline-container-org22568fd" class="outline-5">
<h5 id="org22568fd">jq tricks</h5>
<div class="outline-text-5" id="text-org22568fd">
<p>
It's very evident that the JSON output from the allocate and deploy commands was very lengthy for even one machine — so you can imagine how large a list of 10 or 12 machines might be. Traditional JSON output is both consistent and comprehensive, but sometimes hard for humans to process.
</p>

<p>
Enter jq, a command-line tool dedicated to filtering and formatting JSON output, so that you can more easily summarize data. For instance, consider a small MAAS install with 12 virtual machines. Six of these machines are lxd VMs, and six are libvirt VMs. Suppose I enter the MAAS CLI command to list all those machines:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read</textarea>
</p>

<p>
The listing would be many pages long, and likely very time-consuming to pick through. On the other hand, I can apply the jq command, a couple of other Ubuntu CLI commands, and just a little bit of finesse to get something conventional-looking:
</p>

<p>
<textarea cols="80" rows="6">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","SYSID",
"POWER","STATUS","OWNER", "TAGS", "POOL","VLAN","FABRIC",
"SUBNET"] | (., map(length*"-"))),(.[] | [.hostname, .system_id, 
.power_state, .status_name, .owner // "-",.tag_names[0] // "-", 
.pool.name,.boot_interface.vlan.name,.boot_interface.vlan.fabric,
.boot_interface.links[0].subnet.name]) | @tsv' | column -t</textarea>
</p>

<p>
In fact, with this command,we can produce an useful and compact machine listing that serves 99% of my routine MAAS information needs:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      SYSID   POWER  STATUS     OWNER  TAGS                 POOL     VLAN      FABRIC    SUBNET
 --------      -----   -----  ------     -----  ----                 ----     ----      ------    ------
 lxd-vm-1      r8d6yp  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 lxd-vm-2      tfftrx  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 lxd-vm-3      grwpwc  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 lxd-vm-4      6s8dt4  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 lxd-vm-5      pyebgm  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 lxd-vm-6      ebnww6  off    New        -      pod-console-logging  default  untagged  fabric-1  
 libvirt-vm-1  m7ffsg  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 libvirt-vm-2  kpawad  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 libvirt-vm-3  r44hr6  error  Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 libvirt-vm-4  s3sdkw  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 libvirt-vm-5  48dg8m  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
 libvirt-vm-6  bacx77  on     Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24</textarea>
</p>

<p>
Here we have a clean text table listing the machine hostnames, along with the system IDs, power states, machines statuses, tags, pools, and networking information. These parameters represent only a small fraction of the available JSON output, of course. Let's break this command down, piece by piece, and see how it works.
</p>
</div>

<div id="outline-container-orge988ccc" class="outline-6">
<h6 id="orge988ccc">Basic jq usage</h6>
<div class="outline-text-6" id="text-orge988ccc">
<p>
First, we'll just pull the hostnames from these machines, with no qualifiers or formatting rules, like this:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq '(.[] | [.hostname])'</textarea>
</p>

<p>
This command returns output that looks something like this:
</p>

<p>
<textarea cols="80" rows="36">
[
  "lxd-vm-1"
]
[
  "lxd-vm-2"
]
[
  "lxd-vm-3"
]
[
  "lxd-vm-4"
]
[
  "lxd-vm-5"
]
[
  "lxd-vm-6"
]
[
  "libvirt-vm-1"
]
[
  "libvirt-vm-2"
]
[
  "libvirt-vm-3"
]
[
  "libvirt-vm-4"
]
[
  "libvirt-vm-5"
]
[
  "libvirt-vm-6"
]</textarea>
</p>

<p>
Note a couple of things about this command:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq '(.[] | [.hostname])'</textarea>
</p>

<p>
First, the jq instructions are enclosed in single quotes. As such, they can span lines if necessary, without any line continuations (\), like this:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$ maas admin machines read | jq '(.[]
| [.hostname])'</textarea>
</p>

<p>
Second, notice the structure of the jq instructions. The .[] tells jq that it's decoding an array of data sets — in this case, an array of machine data sets — and that it should iterate through each of the outer data sets (each machine) individually. The pipe symbol (|) completes the “for each” construct, so this command basically says, “for each set of machine data you get, pull out (and return) the value associated with the JSON key hostname. The return value reflects this structure:
</p>

<p>
<textarea cols="80" rows="6">
[
   "libvirt-vm-5"
]
[
   "libvirt-vm-6"
]</textarea>
</p>

<p>
The outer square brackets represent the boundaries of each machine's data set, and the value in quotes corresponds to the value of the key hostname in successive machine data sets. It can get a little complicated sometimes, but that's basically the way to parse JSON with jq.
</p>

<p>
For practice let's try pulling the value of the key that holds machine status, again with no qualifiers or special formatting:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq '(.[] | [.hostname, .status_name])'</textarea>
</p>

<p>
This command essentially tells jq to do the same thing as last time, but also collect the value of the key “statusname” for each machine. The results looks something like this:
</p>

<p>
<textarea cols="80" rows="48">
[
  "lxd-vm-1",
  "Deployed"
]
[
  "lxd-vm-2",
  "Allocated"
]
[
  "lxd-vm-3",
  "Ready"
]
[
  "lxd-vm-4",
  "Deployed"
]
[
  "lxd-vm-5",
  "Allocated"
]
[
  "lxd-vm-6",
  "New"
]
[
  "libvirt-vm-1",
  "Ready"
]
[
  "libvirt-vm-2",
  "Ready"
]
[
  "libvirt-vm-3",
  "Ready"
]
[
  "libvirt-vm-4",
  "Ready"
]
[
  "libvirt-vm-5",
  "Ready"
]
[
  "libvirt-vm-6",
  "Deployed"
]</textarea>
</p>

<p>
So much for printing the values of JSON keys. There are still some nuances (arrays, nested keys, …), but this is the lion's share of the syntax. Let's divert for a minute and look at how to format the output in a more human-readable way.
</p>
</div>
</div>

<div id="outline-container-org9f41cf0" class="outline-6">
<h6 id="org9f41cf0">Improved formatting</h6>
<div class="outline-text-6" id="text-org9f41cf0">
<p>
Most of the Ubuntu text-processing commands use tabs as field delimiters, which is a trait inherited from grandfather UNIX. Currently, the output is clean, but relatively hard to format into lines. Luckily jq has a filter for this: the “tab-separated values” filter, known as @tsv. This filter transforms the output records into individual lines with values separated by tabs.
</p>

<p>
Adding @tsv to the mix:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq '(.[] | [.hostname, .status_name]) | @tsv'</textarea>
</p>

<p>
we get something like this:
</p>

<p>
<textarea cols="80" rows="12">
"lxd-vm-1\tDeployed"
"lxd-vm-2\tAllocated"
"lxd-vm-3\tReady"
"lxd-vm-4\tDeployed"
"lxd-vm-5\tAllocated"
"lxd-vm-6\tNew"
"libvirt-vm-1\tReady"
"libvirt-vm-2\tReady"
"libvirt-vm-3\tReady"
"libvirt-vm-4\tReady"
"libvirt-vm-5\tReady"
"libvirt-vm-6\tDeployed"</textarea>
</p>

<p>
That's a step in the right direction, but it's still pretty far from human-readable output. If only there were some way to get rid of the quotes and just do the tab, instead of representing it as a regex character. In fact, the jq “raw” output option (-r) takes care of this:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq -r '(.[] | [.hostname, .status_name]) | @tsv'</textarea>
</p>

<p>
Feeding the raw output into our three-filter set gives us a more readable result:
</p>

<p>
<textarea cols="80" rows="12">
lxd-vm-1	Deployed
lxd-vm-2	Allocated
lxd-vm-3	Ready
lxd-vm-4	Deployed
lxd-vm-5	Allocated
lxd-vm-6	New
libvirt-vm-1	Ready
libvirt-vm-2	Ready
libvirt-vm-3	Ready
libvirt-vm-4	Ready
libvirt-vm-5	Ready
libvirt-vm-6	Deployed</textarea>
</p>

<p>
This is tabulated, but the number of spaces between the columns is a little big, and, if there's an unusually long value in one of the fields, it may throw the tabulation off for that line. Something could have been added to jq for that, but there is no need, since Ubuntu already has the column utility. Piping the output of the command so far to column -t (-t for “tabs”) will normalize the tab spacing to the data and ensure that each column is exactly long enough for the longest value in that column:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq -r '(.[] | [.hostname, .status_name]) | @tsv' | column -t</textarea>
</p>

<p>
This command result is very similar to the previous output, though you'll notice that the field spacing is neatly optimized to the data itself:
</p>

<p>
<textarea cols="80" rows="12">
lxd-vm-1      Deployed
lxd-vm-2      Allocated
lxd-vm-3      Ready
lxd-vm-4      Deployed
lxd-vm-5      Allocated
lxd-vm-6      New
libvirt-vm-1  Ready
libvirt-vm-2  Ready
libvirt-vm-3  Ready
libvirt-vm-4  Ready
libvirt-vm-5  Ready
libvirt-vm-6  Deployed</textarea>
</p>
</div>
</div>

<div id="outline-container-org680ae36" class="outline-6">
<h6 id="org680ae36">Making real tables</h6>
<div class="outline-text-6" id="text-org680ae36">
<p>
So far, so good, but this still isn't a presentable data table. First of all, there are no headings. These can be added by passing a literal row to jq, like this:
</p>

<p>
<textarea cols="80" rows="1">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS"]), (.[] | [.hostname, .status_name]) | @tsv' | column -t</textarea>
</p>

<p>
You'll note that there are two expressions in parenthesis (representing individual lines or rows). The first just contains the two column headings, while the second contains the “for each” construct that pulls the hostname and status out of the JSON. In essence, the first expression evaluates to just one row, since there's nothing to tell it to iterate. The second expression evaluates to one row per machine, since that's the level of data we're reading. Here's what we get from this command:
</p>

<p>
<textarea cols="80" rows="13">
HOSTNAME      STATUS
lxd-vm-1      Deployed
lxd-vm-2      Allocated
lxd-vm-3      Ready
lxd-vm-4      Deployed
lxd-vm-5      Allocated
lxd-vm-6      New
libvirt-vm-1  Ready
libvirt-vm-2  Ready
libvirt-vm-3  Ready
libvirt-vm-4  Ready
libvirt-vm-5  Ready
libvirt-vm-6  Deployed</textarea>
</p>

<p>
Nice, but it needs a horizontal rule, like a line of dashes, to separate the headings from the data. We can do this by essentially turning the one header row into two, using some jq macros to generate dashes lines of appropriate length:
</p>

<p>
<textarea cols="80" rows="2">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS"] | 
(.,map(length*"-"))), (.[] | [.hostname, .status_name]) | @tsv' | column -t</textarea>
</p>

<p>
The expression | (.,) tells jq to convert the foregoing header row into two rows: the first contains the two headers, as in the previous row, and the second contains the result of a couple of macros (map and length). We won't detail those here, but the use of this construct produces the following output:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      STATUS
--------      ------
lxd-vm-1      Deployed
lxd-vm-2      Allocated
lxd-vm-3      Ready
lxd-vm-4      Deployed
lxd-vm-5      Allocated
lxd-vm-6      New
libvirt-vm-1  Ready
libvirt-vm-2  Ready
libvirt-vm-3  Ready
libvirt-vm-4  Ready
libvirt-vm-5  Ready
libvirt-vm-6  Deployed</textarea>
</p>
</div>
</div>

<div id="outline-container-orga5c07f9" class="outline-6">
<h6 id="orga5c07f9">Extending the list</h6>
<div class="outline-text-6" id="text-orga5c07f9">
<p>
Let's add a couple more fields, owner (which is sometimes blank), and systemid (which is never blank), to the output:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS", "OWNER", "SYSTEM-ID"] 
| (.,map(length*"-"))), (.[] | [.hostname, .status_name,.owner,.system_id]) 
| @tsv' | column -t</textarea>
</p>

<p>
This gives us the following result:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      STATUS     OWNER   SYSTEM-ID
--------      ------     -----   ---------
lxd-vm-1      Deployed   admin   r8d6yp
lxd-vm-2      Allocated  admin   tfftrx
lxd-vm-3      Ready      grwpwc  
lxd-vm-4      Deployed   admin   6s8dt4
lxd-vm-5      Allocated  admin   pyebgm
lxd-vm-6      New        ebnww6  
libvirt-vm-1  Ready      m7ffsg  
libvirt-vm-2  Ready      kpawad  
libvirt-vm-3  Ready      r44hr6  
libvirt-vm-4  Ready      s3sdkw  
libvirt-vm-5  Ready      48dg8m  
libvirt-vm-6  Deployed   admin   bacx77</textarea>
</p>

<p>
You'll notice right away there's a problem with the columns. Remember that only machines in the “Allocated” or “Deployed” state are owned by anyone, since that's what allocate/acquire means. The lines for the deployed and allocated machines lay out correctly, but the lines for the unowned machines are incorrectly formatted. We can fix this by using the jq “alternate value” construct (a // "b"), which can be loosely read, “if not a, then b.” We add it to the owner key like this:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS", "OWNER", "SYSTEM-ID"] 
| (.,map(length*"-"))), (.[] | [.hostname, .status_name,.owner // "-",.system_id]) 
| @tsv' | column -t</textarea>
</p>

<p>
Then the results line up nicely, based on the longest value in each key column:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      STATUS     OWNER  SYSTEM-ID
--------      ------     -----  ---------
lxd-vm-1      Deployed   admin  r8d6yp
lxd-vm-2      Allocated  admin  tfftrx
lxd-vm-3      Ready      -      grwpwc
lxd-vm-4      Deployed   admin  6s8dt4
lxd-vm-5      Allocated  admin  pyebgm
lxd-vm-6      New        -      ebnww6
libvirt-vm-1  Ready      -      m7ffsg
libvirt-vm-2  Ready      -      kpawad
libvirt-vm-3  Ready      -      r44hr6
libvirt-vm-4  Ready      -      s3sdkw
libvirt-vm-5  Ready      -      48dg8m
libvirt-vm-6  Deployed   admin  bacx77</textarea>
</p>
</div>
</div>

<div id="outline-container-org21cea15" class="outline-6">
<h6 id="org21cea15">Nested arrays</h6>
<div class="outline-text-6" id="text-org21cea15">
<p>
Machines have a nested array (of indeterminate length) for machine tags. In JSON terms, instead of having a single key-value pair at the top level, like this:
</p>

<p>
<textarea cols="80" rows="1">
"hostname": "libvirt-vm-6",</textarea>
</p>

<p>
tags are represented by nested arrays, like this:
</p>

<p>
<textarea cols="80" rows="4">
"tag_names": [
    "pod-console-logging",
    "virtual"
],</textarea>
</p>

<p>
Incorporating a random number of tags per machine into a neat table is beyond the scope of this particular section, but we can show the first tag in the table rows:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS", "OWNER", "SYSTEM-ID",
"FIRST TAG"] | (.,map(length*"-"))), (.[] | [.hostname, .status_name,
.owner // "-",.system_id,.tag_names[0] // "-"]) | @tsv' | column -t</textarea>
</p>

<p>
Where we would use .json-key-name for a non-nested value, we need only use .json-key-name[0] to refer to the first element of the nested array. Doing this produces the following result:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      STATUS     OWNER  SYSTEM-ID  FIRST                TAG
--------      ------     -----  ---------  ---------            
lxd-vm-1      Deployed   admin  r8d6yp     pod-console-logging  
lxd-vm-2      Allocated  admin  tfftrx     pod-console-logging  
lxd-vm-3      Ready      -      grwpwc     pod-console-logging  
lxd-vm-4      Deployed   admin  6s8dt4     pod-console-logging  
lxd-vm-5      Allocated  admin  pyebgm     pod-console-logging  
lxd-vm-6      New        -      ebnww6     pod-console-logging  
libvirt-vm-1  Ready      -      m7ffsg     pod-console-logging  
libvirt-vm-2  Ready      -      kpawad     pod-console-logging  
libvirt-vm-3  Ready      -      r44hr6     pod-console-logging  
libvirt-vm-4  Ready      -      s3sdkw     pod-console-logging  
libvirt-vm-5  Ready      -      48dg8m     pod-console-logging  
libvirt-vm-6  Deployed   admin  bacx77     pod-console-logging</textarea>
</p>

<p>
That's almost right, but notice that the heading separates on spaces between words. Let's try a better way, with an underscore:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS", "OWNER", "SYSTEM-ID",
"FIRST_TAG"] | (.,map(length*"-"))), (.[] | [.hostname, .status_name,
.owner // "-",.system_id,.tag_names[0] // "-"]) | @tsv' | column -t</textarea>
</p>

<p>
This version of the command produces the expected output:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      STATUS     OWNER  SYSTEM-ID  FIRST_TAG
--------      ------     -----  ---------  ---------
lxd-vm-1      Deployed   admin  r8d6yp     pod-console-logging
lxd-vm-2      Allocated  admin  tfftrx     pod-console-logging
lxd-vm-3      Ready      -      grwpwc     pod-console-logging
lxd-vm-4      Deployed   admin  6s8dt4     pod-console-logging
lxd-vm-5      Allocated  admin  pyebgm     pod-console-logging
lxd-vm-6      New        -      ebnww6     pod-console-logging
libvirt-vm-1  Ready      -      m7ffsg     pod-console-logging
libvirt-vm-2  Ready      -      kpawad     pod-console-logging
libvirt-vm-3  Ready      -      r44hr6     pod-console-logging
libvirt-vm-4  Ready      -      s3sdkw     pod-console-logging
libvirt-vm-5  Ready      -      48dg8m     pod-console-logging
libvirt-vm-6  Deployed   admin  bacx77     pod-console-logging</textarea>
</p>
</div>
</div>

<div id="outline-container-org9c791bf" class="outline-6">
<h6 id="org9c791bf">Nested keys</h6>
<div class="outline-text-6" id="text-org9c791bf">
<p>
These aren't all the routine key-value pairs we want in the table, though. It would also be nice to print the pool to which each machine is assigned. Just asking for .pool as a single key-value pair:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS", "OWNER", "SYSTEM-ID",
"FIRST_TAG","POOL"] | (.,map(length*"-"))), (.[] | [.hostname, .status_name,
.owner // "-",.system_id,.tag_names[0] // "-", .pool]) | @tsv' | column -t</textarea>
</p>

<p>
produces an error:
</p>

<p>
<textarea cols="80" rows="1">
jq: error (at <stdin>:5639): object ({"name":"de...") is not valid in a csv row</textarea>
</p>

<p>
Looking at the JSON output, we see that .pool is a nested key, not a key-value pair:
</p>

<p>
<textarea cols="80" rows="6">
"pool": {
    "name": "default",
    "description": "Default pool",
    "id": 0,
    "resource_uri": "/MAAS/api/2.0/resourcepool/0/"
},</textarea>
</p>

<p>
What we really want is the pool name, so we need to add one level of indirection to that particular key to reach the actual key-value pair, like this:
</p>

<p>
<textarea cols="80" rows="3">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","STATUS", "OWNER", "SYSTEM-ID",
"FIRST_TAG","POOL"] | (.,map(length*"-"))), (.[] | [.hostname, .status_name,
.owner // "-",.system_id,.tag_names[0] // "-", .pool.name]) | @tsv' | column -t</textarea>
</p>

<p>
which gives us what we want:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      STATUS     OWNER  SYSTEM-ID  FIRST_TAG            POOL
--------      ------     -----  ---------  ---------            ----
lxd-vm-1      Deployed   admin  r8d6yp     pod-console-logging  default
lxd-vm-2      Allocated  admin  tfftrx     pod-console-logging  default
lxd-vm-3      Ready      -      grwpwc     pod-console-logging  default
lxd-vm-4      Deployed   admin  6s8dt4     pod-console-logging  default
lxd-vm-5      Allocated  admin  pyebgm     pod-console-logging  default
lxd-vm-6      New        -      ebnww6     pod-console-logging  default
libvirt-vm-1  Ready      -      m7ffsg     pod-console-logging  default
libvirt-vm-2  Ready      -      kpawad     pod-console-logging  default
libvirt-vm-3  Ready      -      r44hr6     pod-console-logging  default
libvirt-vm-4  Ready      -      s3sdkw     pod-console-logging  default
libvirt-vm-5  Ready      -      48dg8m     pod-console-logging  default
libvirt-vm-6  Deployed   admin  bacx77     pod-console-logging  default</textarea>
</p>

<p>
It's also useful to list the VLAN and fabric names in the output table. Looking at the JSON again, these values present like this:
</p>

<p>
<textarea cols="80" rows="16">
"boot_interface": {
            "vlan": {
                "vid": 0,
                "mtu": 1500,
                "dhcp_on": true,
                "external_dhcp": null,
                "relay_vlan": null,
                "secondary_rack": null,
                "name": "untagged",
                "id": 5001,
                "fabric_id": 1,
                "space": "undefined",
                "fabric": "fabric-1",
                "primary_rack": "wnmkpn",
                "resource_uri": "/MAAS/api/2.0/vlans/5001/"
             },</textarea>
</p>

<p>
This means they are doubly-nested. No problem; just use double indirection (two levels of . separators) to retrieve them:
</p>

<p>
<textarea cols="80" rows="5">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS","OWNER", 
"TAGS", "POOL", "VLAN","FABRIC"] | (., map(length*"-"))), (.[] | [.hostname, 
.system_id, .power_state, .status_name, .owner // "-", .tag_names[0] // "-", 
.pool.name, .boot_interface.vlan.name, .boot_interface.vlan.fabric]) 
| @tsv' | column -t</textarea>
</p>

<p>
The modified command yields the desired results:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      SYSID   POWER  STATUS     OWNER  TAGS                 POOL     VLAN      FABRIC
--------      -----   -----  ------     -----  ----                 ----     ----      ------
lxd-vm-1      r8d6yp  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1
lxd-vm-2      tfftrx  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1
lxd-vm-3      grwpwc  off    Ready      -      pod-console-logging  default  untagged  fabric-1
lxd-vm-4      6s8dt4  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1
lxd-vm-5      pyebgm  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1
lxd-vm-6      ebnww6  off    New        -      pod-console-logging  default  untagged  fabric-1
libvirt-vm-1  m7ffsg  off    Ready      -      pod-console-logging  default  untagged  fabric-1
libvirt-vm-2  kpawad  off    Ready      -      pod-console-logging  default  untagged  fabric-1
libvirt-vm-3  r44hr6  error  Ready      -      pod-console-logging  default  untagged  fabric-1
libvirt-vm-4  s3sdkw  off    Ready      -      pod-console-logging  default  untagged  fabric-1
libvirt-vm-5  48dg8m  off    Ready      -      pod-console-logging  default  untagged  fabric-1
libvirt-vm-6  bacx77  on     Deployed   admin  pod-console-logging  default  untagged  fabric-1</textarea>
</p>

<p>
There's just one more (deeply nested) value we want to retrieve, and that's the fully-qualified subnet address in CIDR form. That's a little trickier, because it's buried in JSON like this:
</p>

<p>
<textarea cols="80" rows="20">
"boot_interface": {
     "vlan": {
         "vid": 0,
         "mtu": 1500,
         "dhcp_on": true,
         ...
         "resource_uri": "/MAAS/api/2.0/vlans/5001/"
     },
     "parents": [],
     "product": null,
     ...
     "link_connected": true,
     "type": "physical",
     "links": [
         {
             "id": 79,
             "mode": "auto",
             "ip_address": "10.124.141.4",
             "subnet": {
                 "name": "10.124.141.0/24",</textarea>
</p>

<p>
So the value we want is in the nested key bootinterface, in a nested array links[], which contains the doubly-nested key subnet.name. We can finish our basic CLI machine list — the one we started with — by adding this complex formulation to the command:
</p>

<p>
<textarea cols="80" rows="6">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS",
"OWNER", "TAGS", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // "-", 
.tag_names[0] // "-", .pool.name,
.boot_interface.vlan.name, .boot_interface.vlan.fabric,
.boot_interface.links[0].subnet.name]) | @tsv' | column -t</textarea>
</p>

<p>
Sure enough, this command gives us the same table we had at the beginning of this section:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      SYSID   POWER  STATUS     OWNER  TAGS                 POOL     VLAN      FABRIC    SUBNET
--------      -----   -----  ------     -----  ----                 ----     ----      ------    ------
lxd-vm-1      r8d6yp  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-2      tfftrx  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-3      grwpwc  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-4      6s8dt4  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-5      pyebgm  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-6      ebnww6  off    New        -      pod-console-logging  default  untagged  fabric-1  
libvirt-vm-1  m7ffsg  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-2  kpawad  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-3  r44hr6  error  Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-4  s3sdkw  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-5  48dg8m  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-6  bacx77  on     Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24</textarea>
</p>
</div>
</div>

<div id="outline-container-org2279378" class="outline-6">
<h6 id="org2279378">Chaining Ubuntu CLI commands</h6>
<div class="outline-text-6" id="text-org2279378">
<p>
Although the machine list above looks fairly neat, it's actually not sorted by hostname, exactly. To accomplish this, we'd need to add a couple of Ubuntu CLI commands to the mix. Sorting on hostname means we want to sort on field 1 of the current command's output. We can try just feeding that to sort like this:
</p>

<p>
<textarea cols="80" rows="6">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS", "OWNER", 
"TAGS", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))), (.[] | 
[.hostname, .system_id, .power_state, .status_name, .owner // "-", 
.tag_names[0] // "-", .pool.name, .boot_interface.vlan.name, 
.boot_interface.vlan.fabric, .boot_interface.links[0].subnet.name]) 
| @tsv' | column -t | sort -k 1</textarea>
</p>

<p>
This command does indeed sort by hostname:
</p>

<p>
<textarea cols="80" rows="14">
--------      -----   -----  ------     -----  ----                 ----     ----      ------    ------
HOSTNAME      SYSID   POWER  STATUS     OWNER  TAGS                 POOL     VLAN      FABRIC    SUBNET
libvirt-vm-1  m7ffsg  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-2  kpawad  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-3  r44hr6  error  Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-4  s3sdkw  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-5  48dg8m  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-6  bacx77  on     Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-1      r8d6yp  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-2      tfftrx  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-3      grwpwc  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-4      6s8dt4  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-5      pyebgm  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-6      ebnww6  off    New        -      pod-console-logging  default  untagged  fabric-1</textarea>
</p>

<p>
but it has the unintended side-effect of sorting the header lines into the output. There are probably at least a dozen Ubuntu CLI solutions for this, so we'll just pick one of the most elegant here, using awk:
</p>

<p>
<textarea cols="80" rows="6">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS","OWNER", 
"TAGS", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),(.[] | 
[.hostname, .system_id, .power_state, .status_name, .owner // "-", 
.tag_names[0] // "-", .pool.name, .boot_interface.vlan.name, 
.boot_interface.vlan.fabric,.boot_interface.links[0].subnet.name]) 
| @tsv' | column -t | awk 'NR<3{print $0;next}{print $0| "sort -k 1"}'</textarea>
</p>

<p>
This command gives us the desired output:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      SYSID   POWER  STATUS     OWNER  TAGS                 POOL     VLAN      FABRIC    SUBNET
--------      -----   -----  ------     -----  ----                 ----     ----      ------    ------
libvirt-vm-1  m7ffsg  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-2  kpawad  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-3  r44hr6  error  Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-4  s3sdkw  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-5  48dg8m  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-6  bacx77  on     Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-1      r8d6yp  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-2      tfftrx  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-3      grwpwc  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-4      6s8dt4  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-5      pyebgm  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-6      ebnww6  off    New        -      pod-console-logging  default  untagged  fabric-1</textarea>
</p>

<p>
Note that by changing the numerical “-k” argument to “sort,” you can change which field controls the sort:
</p>

<p>
<textarea cols="80" rows="6">
stormrider@wintermute:~$ maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS","OWNER", 
"TAGS", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),(.[] | 
[.hostname, .system_id, .power_state, .status_name, .owner // "-", 
.tag_names[0] // "-", .pool.name, .boot_interface.vlan.name, 
.boot_interface.vlan.fabric,.boot_interface.links[0].subnet.name]) 
| @tsv' | column -t | awk 'NR<3{print $0;next}{print $0| "sort -k 4"}'</textarea>
</p>

<p>
This command sorts by machine state, which is the fourth field:
</p>

<p>
<textarea cols="80" rows="14">
HOSTNAME      SYSID   POWER  STATUS     OWNER  TAGS                 POOL     VLAN      FABRIC    SUBNET
--------      -----   -----  ------     -----  ----                 ----     ----      ------    ------
lxd-vm-2      tfftrx  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-5      pyebgm  off    Allocated  admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-6  bacx77  on     Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-1      r8d6yp  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-4      6s8dt4  off    Deployed   admin  pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-6      ebnww6  off    New        -      pod-console-logging  default  untagged  fabric-1  
libvirt-vm-1  m7ffsg  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-2  kpawad  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-4  s3sdkw  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-5  48dg8m  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
lxd-vm-3      grwpwc  off    Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24
libvirt-vm-3  r44hr6  error  Ready      -      pod-console-logging  default  untagged  fabric-1  10.124.141.0/24</textarea>
</p>

<p>
At this point, it should be clear that jq is a relatively simple, powerful tool for formatting output from the MAAS CLI. You should also remember that, like any Ubuntu CLI command, jq simply outputs text — so anything you can do with text output, you can do with the output from jq.
</p>
</div>
</div>
</div>

<div id="outline-container-org8b93ab2" class="outline-5">
<h5 id="org8b93ab2">SSH/SCP with MAAS machines</h5>
<div class="outline-text-5" id="text-org8b93ab2">
<p>
Now that we have some running machines, what if we just set ourselves up to SSH into one of them? Making this work will also allow us to scp files in &#x2013; and I'm sure you can see how we'd provision a machine from there. We can also do the provisioning with MAAS, if we're clever, but I'll leave that for later.
</p>

<p>
First things first: we need to build the MAAS infrastructure necessary to play with this feature.
</p>
</div>

<div id="outline-container-org755f3ce" class="outline-6">
<h6 id="org755f3ce">Create a KVM</h6>
<div class="outline-text-6" id="text-org755f3ce">
<p>
We start by creating a vm-host. Let's play dumb and walk our way through this; first, we'll just try creating a vm-host, like this:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-host create</textarea>
</p>

<p>
This doesn't give anything like the expected result:
</p>

<p>
<textarea cols="80" rows="23">
usage: maas admin vm-host [-h] COMMAND ...

Manage an individual vm-host.

optional arguments:
  -h, --help  show this help message and exit

drill down:
  COMMAND
    refresh   Refresh a pod
    parameters
              Obtain pod parameters
    compose   Compose a pod machine
    add-tag   Add a tag to a pod
    remove-tag
              Remove a tag from a pod
    read
    update    Update a specific pod
    delete    Deletes a pod

A vm-host is identified by its id.

argument COMMAND: invalid choice: 'create' (choose from 'refresh', 'parameters', 'compose', 'add-tag', 'remove-tag', 'read', 'update', 'delete')</textarea>
</p>

<p>
Oops, forgot about the collective pluralism of the MAAS CLI &#x2013; we need to use vm-hosts to create one, because we're adding to the collection, so the correct command should look something like this:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-hosts create</textarea>
</p>

<p>
Still not quite what we expected, but we're failing forward fast, which is a great way to learn new software. As a side note, it's not great for skydiving, but that's another story altogether. The MAAS CLI tells us we need to specify a type:
</p>

<p>
<textarea cols="80" rows="1">
{"type": ["This field is required."]}</textarea>
</p>

<p>
Of course! We have to specify what kind of vm-host we want; in this case, it's going to be an LXD vm-host, so we modify our previous command like this:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-hosts create type=lxd</textarea>
</p>

<p>
Oops, still one more thing to enter: the power_address:
</p>

<p>
<textarea cols="80" rows="1">
{"power_address": ["This field is required."]}</textarea>
</p>

<p>
We need to update our command to tell MAAS what LXD instance we're going to use. The power_address for an LXD vm-host is of the form <code>https://&lt;gateway-ip-address&gt;:8443</code>. The <code>8443</code> is the default port when you ran lxd init to get LXD started, after installing it. The rest is just what you learn by experience, or by reading blogs like this one.
</p>

<p>
In my case, the LXD gateway is 10.38.31.1 at the moment, so my modified command would be:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-hosts create type=lxd power_address=https://10.38.31.1:8443</textarea>
</p>

<p>
Within seconds, we get a success message and JSON output. From now on, I'll leave the JSON output for you to generate and view on your own, unless it bears specifically on the discussion. In this case, all that we'll need is the last non-bracket line of the JSON return, which is:
</p>

<p>
<textarea cols="80" rows="1">
"resource_uri": "/MAAS/api/2.0/pods/7/"</textarea>
</p>

<p>
What we'll need in the next step is the vm-host ID, which is the number on the end of the resource_uri &#x2013; specifically, "7".
</p>

<p>
By way of additional confirmation, we could pull up the MAAS UI and see that an LXD "KVM HOST TYPE" named "wintermute" has been created. This might be a good moment to bring up some terminology dissonance, which is nothing unusual for an open-source product. Originally, vm-hosts were called "pods," hence the word "pods" in the resource URI. Later, they were changed to "KVM hosts" to correspond to the term "KVM," used commonly by libvirt. Note that libvirt was, at one time, the only common vm-host used by MAAS. As the product transitioned to using more than one VM tool &#x2013; that is, LXD &#x2013; the team decided a more inclusive name was needed, hence "VM host."
</p>
</div>
</div>

<div id="outline-container-org1c5696f" class="outline-6">
<h6 id="org1c5696f">Composing a machine</h6>
<div class="outline-text-6" id="text-org1c5696f">
<p>
Having a VM host is great, but we can't demonstrate ssh/scp machine actions without a virtual machine running on that host. Let's create one. This may get tricky, so let's start by looking at the MAAS CLI help:
</p>

<p>
<textarea cols="80" rows="1">
maas admin --help</textarea>
</p>

<p>
This gives us the following, very long command list:
</p>

<p>
<textarea cols="80" rows="129">
usage: maas admin [-h] COMMAND ...

Issue commands to the MAAS region controller at http://192.168.56.91:5240/MAAS/api/2.0/.

optional arguments:
  -h, --help            show this help message and exit

drill down:
  COMMAND
    account             Manage the current logged-in user.
    bcache-cache-set    Manage bcache cache set on a machine.
    bcache-cache-sets   Manage bcache cache sets on a machine.
    bcache              Manage bcache device on a machine.
    bcaches             Manage bcache devices on a machine.
    block-device        Manage a block device on a machine.
    block-devices       Manage block devices on a machine.
    boot-resource       Manage a boot resource.
    boot-resources      Manage the boot resources.
    boot-source         Manage a boot source.
    boot-source-selection
                        Manage a boot source selection.
    boot-source-selections
                        Manage the collection of boot source selections.
    boot-sources        Manage the collection of boot sources.
    commissioning-script
                        Manage a custom commissioning script.
    commissioning-scripts
                        Manage custom commissioning scripts.
    dhcpsnippet         Manage an individual DHCP snippet.
    dhcpsnippets        Manage the collection of all DHCP snippets in MAAS.
    dnsresource         Manage dnsresource.
    dnsresource-record  Manage dnsresourcerecord.
    dnsresource-records
                        Manage DNS resource records (e.g. CNAME, MX, NS, SRV,
                        TXT)
    dnsresources        Manage dnsresources.
    device              Manage an individual device.
    devices             Manage the collection of all the devices in the MAAS.
    discoveries         Query observed discoveries.
    discovery           Read or delete an observed discovery.
    domain              Manage domain.
    domains             Manage domains.
    events              Retrieve filtered node events.
    fabric              Manage fabric.
    fabrics             Manage fabrics.
    fan-network         Manage Fan Network.
    fan-networks        Manage Fan Networks.
    file                Manage a FileStorage object.
    files               Manage the collection of all the files in this MAAS.
    ipaddresses         Manage IP addresses allocated by MAAS.
    iprange             Manage IP range.
    ipranges            Manage IP ranges.
    interface           Manage a node's or device's interface.
    interfaces          Manage interfaces on a node.
    license-key         Manage a license key.
    license-keys        Manage the license keys.
    maas                Manage the MAAS server.
    machine             Manage an individual machine.
    machines            Manage the collection of all the machines in the MAAS.
    network             Manage a network.
    networks            Manage the networks.
    node                Manage an individual Node.
    node-results        Read the collection of commissioning script results.
    node-script         Manage or view a custom script.
    node-script-result  Manage node script results.
    node-script-results
                        Manage node script results.
    node-scripts        Manage custom scripts.
    nodes               Manage the collection of all the nodes in the MAAS.
    notification        Manage an individual notification.
    notifications       Manage the collection of all the notifications in
                        MAAS.
    package-repositories
                        Manage the collection of all Package Repositories in
                        MAAS.
    package-repository  Manage an individual package repository.
    partition           Manage partition on a block device.
    partitions          Manage partitions on a block device.
    pod                 Manage an individual pod.
    pods                Manage the collection of all the pod in the MAAS.
    rack-controller     Manage an individual rack controller.
    rack-controllers    Manage the collection of all rack controllers in MAAS.
    raid                Manage a specific RAID (Redundant Array of Independent
                        Disks) on a machine.
    raids               Manage all RAIDs (Redundant Array of Independent
                        Disks) on a machine.
    region-controller   Manage an individual region controller.
    region-controllers  Manage the collection of all region controllers in
                        MAAS.
    resource-pool       Manage a resource pool.
    resource-pools      Manage resource pools.
    sshkey              Manage an SSH key.
    sshkeys             Manage the collection of all the SSH keys in this
                        MAAS.
    sslkey              Manage an SSL key.
    sslkeys             Operations on multiple keys.
    space               Manage space.
    spaces              Manage spaces.
    static-route        Manage static route.
    static-routes       Manage static routes.
    subnet              Manage subnet.
    subnets             Manage subnets.
    tag                 Tags are properties that can be associated with a Node
                        and serve as criteria for selecting and allocating
                        nodes.
    tags                Manage all tags known to MAAS.
    user                Manage a user account.
    users               Manage the user accounts of this MAAS.
    version             Information about this MAAS instance.
    virtual-machine     Manage individual virtual machines.
    virtual-machines    Manage a collection of virtual machines.
    vlan                Manage a VLAN on a fabric.
    vlans               Manage VLANs on a fabric.
    vm-host             Manage an individual vm-host.
    vm-hosts            Manage the collection of all the vm-hosts in the MAAS.
    vmfs-datastore      Manage VMFS datastore on a machine.
    vmfs-datastores     Manage VMFS datastores on a machine.
    volume-group        Manage volume group on a machine.
    volume-groups       Manage volume groups on a machine.
    zone                Manage a physical zone.
    zones               Manage physical zones.

This is a profile.  Any commands you issue on this profile will
operate on the MAAS region server.

The command information you see here comes from the region server's
API; it may differ for different profiles.  If you believe the API may
have changed, use the command's 'refresh' sub-command to fetch the
latest version of this help information from the server.</textarea>
</p>

<p>
We're looking to compose a machine here, so where would you look instinctively? Well, the first thought might be machines, so we can give that help screen a try:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines --help</textarea>
</p>

<p>
This produces a few commands:
</p>

<p>
<textarea cols="80" rows="23">
usage: maas admin machines [-h] COMMAND ...

Manage the collection of all the machines in the MAAS.

optional arguments:
  -h, --help            show this help message and exit

drill down:
  COMMAND
    is-registered       MAC address registered
    set-zone            Assign nodes to a zone
    power-parameters    Get power parameters
    accept              Accept declared machines
    accept-all          Accept all declared machines
    release             Release machines
    list-allocated      List allocated
    allocate            Allocate a machine
    add-chassis         Add special hardware
    clone               Clone storage and/or interface configurations
    read                List Nodes visible to the user
    create              Create a new machine
    is-action-in-progress
                        MAC address of deploying or commissioning node</textarea>
</p>

<p>
This list is interesting, but there isn't a specific compose command here. We could go down the garden path with maas admin machines create, but first, let's see if the vm-host command has anything we're seeking:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-host --help</textarea>
</p>

<p>
Bingo. Found the command; do you see it in this list?
</p>

<p>
<textarea cols="80" rows="21">
usage: maas admin vm-host [-h] COMMAND ...

Manage an individual vm-host.

optional arguments:
  -h, --help  show this help message and exit

drill down:
  COMMAND
    refresh   Refresh a pod
    parameters
              Obtain pod parameters
    compose   Compose a pod machine
    add-tag   Add a tag to a pod
    remove-tag
              Remove a tag from a pod
    read
    update    Update a specific pod
    delete    Deletes a pod

A vm-host is identified by its id.</textarea>
</p>

<p>
Okay, so maas admin vm-host compose is the root command, let's see what it requires:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-host compose --help</textarea>
</p>

<p>
Wow! This command is incredibly robust, including some NUMA stuff (which we'll look at later):
</p>

<p>
<textarea cols="80" rows="103">
usage: maas admin vm-host compose [--help] [-d] [-k] id [data [data ...]]

Compose a pod machine


Positional arguments:
        id


This method accepts keyword arguments.  Pass each argument as a
key-value pair with an equals sign between the key and the value:
key1=value1 key2=value key3=value3.  Keyword arguments must come after
any positional arguments.

Compose a new machine from a pod.

:param cores: Optional.  The minimum number of CPU cores.
:type cores: Int

 :param memory: Optional.  The minimum amount of memory,
specified in MiB (e.g. 2 MiB == 2*1024*1024).
:type memory: Int

 :param hugepages_backed: Optional.  Whether to request
hugepages backing for the machine.
:type hugepages_backed: Boolean

 :param pinned_cores: Optional.  List of host CPU cores
to pin the VM to. If this is passed, the "cores" parameter is ignored.
:type pinned_cores: Int

 :param cpu_speed: Optional.  The minimum CPU speed,
specified in MHz.
:type cpu_speed: Int

 :param architecture: Optional.  The architecture of
the new machine (e.g. amd64). This must be an architecture the pod
supports.
:type architecture: String

 :param storage: Optional.  A list of storage
constraint identifiers in the form ``label:size(tag,tag,...),
label:size(tag,tag,...)``. For more information please see the CLI
pod management page of the official MAAS documentation.
:type storage: String

 :param interfaces: Optional.  A
labeled constraint map associating constraint labels with desired
interface properties. MAAS will assign interfaces that match the
given interface properties.

Format: ``label:key=value,key=value,...``

Keys:

- ``id``: Matches an interface with the specific id
- ``fabric``: Matches an interface attached to the specified fabric.
- ``fabric_class``: Matches an interface attached to a fabric
  with the specified class.
- ``ip``: Matches an interface whose VLAN is on the subnet implied by
  the given IP address, and allocates the specified IP address for
  the machine on that interface (if it is available).
- ``mode``: Matches an interface with the specified mode. (Currently,
  the only supported mode is "unconfigured".)
- ``name``: Matches an interface with the specified name.
  (For example, "eth0".)
- ``hostname``: Matches an interface attached to the node with
  the specified hostname.
- ``subnet``: Matches an interface attached to the specified subnet.
- ``space``: Matches an interface attached to the specified space.
- ``subnet_cidr``: Matches an interface attached to the specified
  subnet CIDR. (For example, "192.168.0.0/24".)
- ``type``: Matches an interface of the specified type. (Valid
  types: "physical", "vlan", "bond", "bridge", or "unknown".)
- ``vlan``: Matches an interface on the specified VLAN.
- ``vid``: Matches an interface on a VLAN with the specified VID.
- ``tag``: Matches an interface tagged with the specified tag.
:type interfaces: String

 :param hostname: Optional.  The hostname of the newly
composed machine.
:type hostname: String

 :param domain: Optional.  The ID of the domain in which
to put the newly composed machine.
:type domain: Int

 :param zone: Optional.  The ID of the zone in which to
put the newly composed machine.
:type zone: Int

 :param pool: Optional.  The ID of the pool in which to
put the newly composed machine.
:type pool: Int


Common command-line options:
    --help, -h
        Show this help message and exit.
    -d, --debug
        Display more information about API responses.
    -k, --insecure
        Disable SSL certificate check</textarea>
</p>

<p>
We could get fancy, but for these purposes, we just need a machine. The only thing that's absolutely required besides the command we already got "help" for is the vm-host ID. Remember that line of JSON from above? The ID is "7" &#x2013; so we'll enter this command:
</p>

<p>
<textarea cols="80" rows="1">
maas admin vm-host compose 7</textarea>
</p>

<p>
Hey, how about that! We got some feedback with a machine system_id:
</p>

<p>
<textarea cols="80" rows="6">
Success.
Machine-readable output follows:
{
    "system_id": "xttpfx",
    "resource_uri": "/MAAS/api/2.0/machines/xttpfx/"
}</textarea>
</p>

<p>
We can use this, along with some of our jq tricks, to see if this machine is commissioning (as expected):
</p>

<p>
<textarea cols="80" rows="6">
maas admin machines read | jq -r '(["HOSTNAME","SYSID",
"POWER","STATUS","OWNER", "TAGS", "POOL","VLAN","FABRIC",
"SUBNET"] | (., map(length*"-"))),(.[] | [.hostname, .system_id, 
.power_state, .status_name, .owner // "-",.tag_names[0] // "-", 
.pool.name,.boot_interface.vlan.name,.boot_interface.vlan.fabric,
.boot_interface.links[0].subnet.name]) | @tsv' | column -t</textarea>
</p>

<p>
This gives the following output on my machine:
</p>

<p>
<textarea cols="80" rows="3">
HOSTNAME    SYSID   POWER  STATUS   OWNER  TAGS     POOL     VLAN      FABRIC    SUBNET
--------    -----   -----  ------   -----  ----     ----     ----      ------    ------
native-cub  xttpfx  on     Testing  admin  virtual  default  untagged  fabric-1  10.38.31.0/24</textarea>
</p>

<p>
By the time I got this command typed in, commissioning had already nearly finished, and the machine was in the "testing" phase. If we run this command again now, we should see that it's in the "Ready" state:
</p>

<p>
<textarea cols="80" rows="3">
HOSTNAME    SYSID   POWER  STATUS  OWNER  TAGS     POOL     VLAN      FABRIC    SUBNET
--------    -----   -----  ------  -----  ----     ----     ----      ------    ------
native-cub  xttpfx  off    Ready   -      virtual  default  untagged  fabric-1  10.38.31.0/24</textarea>
</p>
</div>
</div>

<div id="outline-container-orgc92ca72" class="outline-6">
<h6 id="orgc92ca72">Getting the machine to a login state</h6>
<div class="outline-text-6" id="text-orgc92ca72">
<p>
We can't SSH into it, because it automatically turned off after commissioning, and anyway, we didn't have a chance to ask for SSH keys to be loaded during the commissioning process. Let's run that commissioning again, with SSH keys enabled, and making sure that it's left on after it's done. For this operation, we just use the standard machine commands, because the vm-host is hosting a MAAS machine, which is the same as any other MAAS machine:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machine commission xttpfx enable_ssh=1</textarea>
</p>

<p>
This will return a success message (be sure to substitute the "xttpfx" with whatever your composed machine system_id turns out to be; your mileage may vary). After a little while, the machine should return to a "Ready" state again, but this time, with the power left on, and with SSH keys passed to the machine, so that we can login to it. We can check this without complex jq command again:
</p>

<p>
<textarea cols="80" rows="3">
HOSTNAME    SYSID   POWER  STATUS  OWNER  TAGS     POOL     VLAN      FABRIC    SUBNET
--------    -----   -----  ------  -----  ----     ----     ----      ------    ------
native-cub  xttpfx  on     Ready   -      virtual  default  untagged  fabric-1  10.38.31.0/24</textarea>
</p>
</div>
</div>

<div id="outline-container-orgadc3948" class="outline-6">
<h6 id="orgadc3948">Logging into a commissioned machine</h6>
<div class="outline-text-6" id="text-orgadc3948">
<p>
So it's "Ready" and it's powered on, that's good. In order to log in, we'll need to know the machine's IP address. There are several ways to get this, but by far the easiest, IMHO, is just using the lxc command:
</p>

<p>
<textarea cols="80" rows="1">
lxc list</textarea>
</p>

<p>
This will give us the following output:
</p>

<p>
<textarea cols="80" rows="7">
+------------+---------+---------------------+-----------------------------------------------+-----------------+-----------+
|    NAME    |  STATE  |        IPV4         |                     IPV6                      |      TYPE       | SNAPSHOTS |
+------------+---------+---------------------+-----------------------------------------------+-----------------+-----------+
| first-one  | RUNNING | 10.38.31.193 (eth0) |                                               | CONTAINER       | 0         |
+------------+---------+---------------------+-----------------------------------------------+-----------------+-----------+
| native-cub | RUNNING | 10.38.31.202 (eth0) | fd42:fd4c:6ab9:19bc:216:3eff:fe9e:bc7b (eth0) | VIRTUAL-MACHINE | 0         |
+------------+---------+---------------------+-----------------------------------------------+-----------------+-----------+</textarea>
</p>

<p>
This brings up some important nuances about the LXD list. Note that there are two machines, one of which is a CONTAINER that I use for general testing of new software. The other, "native-cub," is the VIRTUAL-MACHINE we just created, and that's the one whose IP address we want for SSH purposes: 10.38.31.202.
</p>

<p>
Okay, so now we can try logging in via SSH, using the "ubuntu" user (always):
</p>

<p>
<textarea cols="80" rows="1">
ssh ubuntu@10.38.31.202</textarea>
</p>

<p>
We get the expected first-login response:
</p>

<p>
<textarea cols="80" rows="3">
The authenticity of host '10.38.31.202 (10.38.31.202)' can't be established.
ECDSA key fingerprint is SHA256:hkKRDyRDG9JcsSmAQ0ir5jy0UKQ+PrU/FTJr36U3bvw.
Are you sure you want to continue connecting (yes/no/[fingerprint])? </textarea>
</p>

<p>
And if we say "yes," we should get this result:
</p>

<p>
<textarea cols="80" rows="34">
Warning: Permanently added '10.38.31.202' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-64-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Feb  1 00:11:52 UTC 2021

  System load:    0.0       Processes:               127
  Usage of /home: unknown   Users logged in:         0
  Memory usage:   10%       IPv4 address for enp5s0: 10.38.31.202
  Swap usage:     0%

14 updates can be installed immediately.
2 of these updates are security updates.
To see these additional updates run: apt list --upgradable

tmpfs-root /media/root-rw tmpfs rw,relatime 0 0
overlayroot / overlay rw,relatime,lowerdir=/media/root-ro,upperdir=/media/root-rw/overlay,workdir=/media/root-rw/overlay-workdir/_ 0 0
/dev/loop0 /media/root-ro squashfs ro,relatime 0 0


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

ubuntu@native-cub:~$ </textarea>
</p>
</div>
</div>

<div id="outline-container-orgcf9fa0b" class="outline-6">
<h6 id="orgcf9fa0b">Using SCP</h6>
<div class="outline-text-6" id="text-orgcf9fa0b">
<p>
We can jump out of this machine and use its IP address to copy files over to it. First, let's make sure that there isn't anything in the local directory on the machine:
</p>

<p>
<textarea cols="80" rows="1">
ls</textarea>
</p>

<p>
And we get what we'd expect:
</p>

<p>
<textarea cols="80" rows="2">
ubuntu@native-cub:~$ ls
ubuntu@native-cub:~$ </textarea>
</p>

<p>
So now, let's exit the machine with exit, and just touch a file called "zork" (a very uncommon filename) in the CWD on the local machine:
</p>

<p>
<textarea cols="80" rows="10">
ubuntu@native-cub:~$ exit
logout
Connection to 10.38.31.202 closed.
stormrider@wintermute:~$ touch zork
stormrider@wintermute:~$ ls
 api-key-file   Credentials   Dropbox   Pictures      snap            Templates
 Backups        Desktop       git       Public        stormrider.io   Videos
 BRF            Documents     mnt      '#scratch#'    temp            Websites
 Code           Downloads     Music     Show-n-Tell   temp~           zork
stormrider@wintermute:~$ </textarea>
</p>

<p>
Now, let's try to scp (secure copy) the file over to the machine, login, and see if the file made it:
</p>

<p>
<textarea cols="80" rows="32">
stormrider@wintermute:~$ scp ./zork ubuntu@10.38.31.202:
zork                                          100%    0     0.0KB/s   00:00    
stormrider@wintermute:~$ ssh ubuntu@10.38.31.202
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-64-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Feb  1 00:20:42 UTC 2021

  System load:    0.0       Processes:               123
  Usage of /home: unknown   Users logged in:         0
  Memory usage:   10%       IPv4 address for enp5s0: 10.38.31.202
  Swap usage:     0%


14 updates can be installed immediately.
2 of these updates are security updates.
To see these additional updates run: apt list --upgradable

tmpfs-root /media/root-rw tmpfs rw,relatime 0 0
overlayroot / overlay rw,relatime,lowerdir=/media/root-ro,upperdir=/media/root-rw/overlay,workdir=/media/root-rw/overlay-workdir/_ 0 0
/dev/loop0 /media/root-ro squashfs ro,relatime 0 0

Last login: Mon Feb  1 00:19:34 2021 from 10.38.31.1
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

ubuntu@native-cub:~$ ls
zork
ubuntu@native-cub:~$ </textarea>
</p>

<p>
Cool! So we can copy files to a machine! Neat.
</p>
</div>
</div>

<div id="outline-container-org388258d" class="outline-6">
<h6 id="org388258d">Copying files to a deployed machine</h6>
<div class="outline-text-6" id="text-org388258d">
<p>
Copying files to a commissioned machine doesn't do us much good, of course, since the machine gets wiped out and reloaded on deployment. Let's acquire and deploy that same machine, and then try logging in and copying files again. First, we have to acquire and deploy the machine:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines allocate system_id=xttpfx</textarea>
</p>
<p>
(Success message and JSON data stream)
</p>

<p>
<textarea cols="80" rows="1">
maas admin machine deploy xttpfx</textarea>
</p>
<p>
(Success message and JSON data stream)
</p>

<p>
<textarea cols="80" rows="10">
maas admin machines read | jq -r '(["HOSTNAME","SYSID", 
"POWER","STATUS","OWNER", "TAGS", "POOL","VLAN","FABRIC",
"SUBNET"] | (., map(length*"-"))),(.[] | [.hostname, .system_id, 
.power_state, .status_name, .owner // "-",.tag_names[0] // "-", 
.pool.name,.boot_interface.vlan.name,.boot_interface.vlan.fabric,
.boot_interface.links[0].subnet.name]) | @tsv' | column -t

HOSTNAME    SYSID   POWER  STATUS     OWNER  TAGS     POOL     VLAN      FABRIC    SUBNET
--------    -----   -----  ------     -----  ----     ----     ----      ------    ------
native-cub  xttpfx  on     Deploying  admin  virtual  default  untagged  fabric-1  10.38.31.0/24</textarea>
</p>

<p>
When it finally reaches the "Deployed" state, we can try and log into it:
</p>

<p>
<textarea cols="80" rows="16">
stormrider@wintermute:~$ ssh ubuntu@10.38.31.2
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:AsOdI357mZdmymQG/bmZzbtrDwZPKNYwdUDgCecHHhI.
Please contact your system administrator.
Add correct host key in /home/stormrider/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /home/stormrider/.ssh/known_hosts:20
  remove with:
  ssh-keygen -f "/home/stormrider/.ssh/known_hosts" -R "10.38.31.2"
ECDSA host key for 10.38.31.2 has changed and you have requested strict checking.
Host key verification failed.</textarea>
</p>

<p>
What??!!?? This is supposed to work, isn't it??
</p>

<p>
No worries! On deployment, the SSH key just got updated, so just do what the message suggests, and you can SSH in normally:
</p>

<p>
<textarea cols="80" rows="39">
stormrider@wintermute:~$ ssh-keygen -f "/home/stormrider/.ssh/known_hosts" -R "10.38.31.2"
# Host 10.38.31.2 found: line 20
/home/stormrider/.ssh/known_hosts updated.
Original contents retained as /home/stormrider/.ssh/known_hosts.old
stormrider@wintermute:~$ ssh ubuntu@10.38.31.2
The authenticity of host '10.38.31.2 (10.38.31.2)' can't be established.
ECDSA key fingerprint is SHA256:AsOdI357mZdmymQG/bmZzbtrDwZPKNYwdUDgCecHHhI.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.38.31.2' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 20.04.1 LTS (GNU/Linux 5.4.0-65-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon Feb  1 00:34:27 UTC 2021

  System load:  0.08              Processes:               133
  Usage of /:   48.2% of 6.78GB   Users logged in:         0
  Memory usage: 10%               IPv4 address for enp5s0: 10.38.31.2
  Swap usage:   0%

14 updates can be installed immediately.
2 of these updates are security updates.
To see these additional updates run: apt list --upgradable



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

ubuntu@native-cub:~$ </textarea>
</p>
</div>
</div>

<div id="outline-container-orgb9fa887" class="outline-6">
<h6 id="orgb9fa887">Copying a script over there and running it</h6>
<div class="outline-text-6" id="text-orgb9fa887">
<p>
So first, let's verify that the script we want to copy over there isn't already there. In fact, to keep it simple, let's just create a simple and fun script to see what scp can get us. First, we'll need to install a couple of software packages on the deployed machine:
</p>

<p>
<textarea cols="80" rows="88">
ubuntu@native-cub:~$ fortune

Command 'fortune' not found, but can be installed with:

sudo apt install fortune-mod

ubuntu@native-cub:~$ sudo apt install fortune-mod
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following additional packages will be installed:
  fortunes-min librecode0
Suggested packages:
  fortunes x11-utils
The following NEW packages will be installed:
  fortune-mod fortunes-min librecode0
0 upgraded, 3 newly installed, 0 to remove and 17 not upgraded.
Need to get 615 kB of archives.
After this operation, 2135 kB of additional disk space will be used.
Do you want to continue? [Y/n] Y
Get:1 http://archive.ubuntu.com/ubuntu focal/main amd64 librecode0 amd64 3.6-24 [523 kB]
Get:2 http://archive.ubuntu.com/ubuntu focal/universe amd64 fortune-mod amd64 1:1.99.1-7build1 [37.3 kB]
Get:3 http://archive.ubuntu.com/ubuntu focal/universe amd64 fortunes-min all 1:1.99.1-7build1 [55.1 kB]
Fetched 615 kB in 3s (203 kB/s)    
Selecting previously unselected package librecode0:amd64.
(Reading database ... 71387 files and directories currently installed.)
Preparing to unpack .../librecode0_3.6-24_amd64.deb ...
Unpacking librecode0:amd64 (3.6-24) ...
Selecting previously unselected package fortune-mod.
Preparing to unpack .../fortune-mod_1%3a1.99.1-7build1_amd64.deb ...
Unpacking fortune-mod (1:1.99.1-7build1) ...
Selecting previously unselected package fortunes-min.
Preparing to unpack .../fortunes-min_1%3a1.99.1-7build1_all.deb ...
Unpacking fortunes-min (1:1.99.1-7build1) ...
Setting up librecode0:amd64 (3.6-24) ...
Setting up fortunes-min (1:1.99.1-7build1) ...
Setting up fortune-mod (1:1.99.1-7build1) ...
Processing triggers for man-db (2.9.1-1) ...
Processing triggers for libc-bin (2.31-0ubuntu9.1) ...
ubuntu@native-cub:~$ ddate

Command 'ddate' not found, but can be installed with:

sudo apt install ddate

ubuntu@native-cub:~$ sudo apt install ddate
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following NEW packages will be installed:
  ddate
0 upgraded, 1 newly installed, 0 to remove and 17 not upgraded.
Need to get 10.8 kB of archives.
After this operation, 34.8 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu focal/universe amd64 ddate amd64 0.2.2-1build1 [10.8 kB]
Fetched 10.8 kB in 1s (20.0 kB/s)
Selecting previously unselected package ddate.
(Reading database ... 71424 files and directories currently installed.)
Preparing to unpack .../ddate_0.2.2-1build1_amd64.deb ...
Unpacking ddate (0.2.2-1build1) ...
Setting up ddate (0.2.2-1build1) ...
Processing triggers for man-db (2.9.1-1) ...
ubuntu@native-cub:~$ cowsay

Command 'cowsay' not found, but can be installed with:

sudo apt install cowsay

ubuntu@native-cub:~$ sudo apt install cowsay
Reading package lists... Done
Building dependency tree       
Reading state information... Done
Suggested packages:
  filters cowsay-off
The following NEW packages will be installed:
  cowsay
0 upgraded, 1 newly installed, 0 to remove and 17 not upgraded.
Need to get 18.5 kB of archives.
After this operation, 93.2 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu focal/universe amd64 cowsay all 3.03+dfsg2-7 [18.5 kB]
Fetched 18.5 kB in 2s (7603 B/s) 
Selecting previously unselected package cowsay.
(Reading database ... 71431 files and directories currently installed.)
Preparing to unpack .../cowsay_3.03+dfsg2-7_all.deb ...
Unpacking cowsay (3.03+dfsg2-7) ...
Setting up cowsay (3.03+dfsg2-7) ...
Processing triggers for man-db (2.9.1-1) ...
ubuntu@native-cub:~$ </textarea>
</p>

<p>
Now we can drop back and write a script that uses these three packages to produce an interesting result. Here's what should be in the script:
</p>

<p>
<textarea cols="80" rows="5">
#!/bin/bash
ddate > /tmp/foo
echo '   ' >> /tmp/foo
fortune -s >> /tmp/foo
cat /tmp/foo | cowsay</textarea>
</p>

<p>
Add the text above to a script called motd.sh, and then chmod 777 motd.sh. Then, use the following command to copy the script to the deployed machine:
</p>

<p>
<textarea cols="80" rows="1">
scp ./motd.sh ubuntu@10.38.31.2:</textarea>
</p>

<p>
Then we can log back into the deployed machine and check the permissions on motd.sh in the arriving CWD:
</p>

<p>
<textarea cols="80" rows="7">
ssh ubuntu@10.38.31.2
...
ls -lsa motd.sh

ubuntu@native-cub:~$ ls -lsa motd.sh
4 -rwxrwxr-x 1 ubuntu ubuntu 97 Feb  1 00:49 motd.sh
ubuntu@native-cub:~$ </textarea>
</p>

<p>
On my machine, it didn't copy the permissions precisely, but it is executable by me, so I can run it and get the highly-important output:
</p>

<p>
<textarea cols="80" rows="14">
 ________________________________________
/ Today is Boomtime, the 32nd day of     \
| Chaos in the YOLD 3187                 |
|                                        |
| Water, taken in moderation cannot hurt |
| anybody.                               |
|                                        |
\ -- Mark Twain                          /
 ----------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||</textarea>
</p>

<p>
So we see that it's possible to deploy a machine and then load usable software on it. Certainly, that's one method MAAS users depend on to get their machines configured &#x2013; probably using scripts or install packages that they scp over and kick off. There are more sophisticated ways to make this happen, and we'll cover those in the future, maybe.
</p>
</div>
</div>
</div>

<div id="outline-container-org03b8a0b" class="outline-5">
<h5 id="org03b8a0b">More neat jq things</h5>
<div class="outline-text-5" id="text-org03b8a0b">
<p>
I covered basic usage of jq with MAAS a couple of sections ago. Now I want to dig in a little bit, and see what else I can do with it.
</p>
</div>

<div id="outline-container-org7fe435c" class="outline-6">
<h6 id="org7fe435c">Sorting natively with jq</h6>
<div class="outline-text-6" id="text-org7fe435c">
<p>
In my previous jq section, I showed how to use Linux command line utilities to sort lines in a multi-record jq output. It's not the only way &#x2013; nor maybe even the easiest way. The jq tool has a native sort capability. Let's take a look.
</p>

<p>
Suppose we have a random list of machines that I quickly created on one of my local MAAS installs &#x2013; haven't even bothered to commission them, since that doesn't matter here. If I run the command:
</p>

<p>
<textarea cols="80" rows="4">
maas admin machines read | jq -r '(["HOSTNAME","SYSID",
"TAGS", "POOL","ZONE"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .tag_names[0] // "-", 
.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
on my very casually defined set of new machines, I'll get a listing something like this:
</p>

<p>
<textarea cols="80" rows="12">
HOSTNAME       SYSID   TAGS      POOL      ZONE
--------       -----   ----      ----      ----
nearby-louse   ed8pda  plover    swimming  defense
novel-cod      4ds3eh  dunnet    swimming  fault
nearby-koala   k6cagg  xyzzy     car       twilight
superb-koi     6sqads  xyzzy     swimming  twilight
amazed-hermit  mehgsk  xyzzy     swimming  twilight
daring-minnow  ceamb4  plover    car       demilitarized
ace-colt       hfm84c  zork      tidal     defense
unique-donkey  tsf8tk  plover    tidal     demilitarized
mutual-cod     sxbkyp  bedquilt  tidal     defense
fun-ibex       8pq6qx  zork      car       fault</textarea>
</p>

<p>
These aren't really sorted by anything, in particular, so let's just start at the front and work our way in, shall we?
sorting by one parameter
</p>

<p>
Rather than passing our output through an awk script, we can just use the jq construct for sorting, which is:
</p>

<p>
<textarea cols="80" rows="1">
sort_by(<fieldname>)</textarea>
</p>

<p>
For example, if we wanted to sort by HOSTNAME, we could try:
</p>

<p>
<textarea cols="80" rows="4">
maas admin machines read | jq -r '(["HOSTNAME","SYSID",
"TAGS", "POOL","ZONE"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .tag_names[0] // "-", 
.pool.name,.zone.name] | sort_by(.hostname)) | @tsv' | column -t</textarea>
</p>

<p>
This doesn't give us anything like what we want, just a mysterious error:
</p>

<p>
<textarea cols="80" rows="3">
jq: error (at <stdin>:2911): Cannot index string with string "hostname"
HOSTNAME  SYSID  TAGS  POOL  ZONE
--------  -----  ----  ----  ----</textarea>
</p>

<p>
Huh? Don't you just link pipes together, and they work?
</p>
</div>
</div>

<div id="outline-container-org82167c3" class="outline-6">
<h6 id="org82167c3">jq is not UNIX (jqNU?)</h6>
<div class="outline-text-6" id="text-org82167c3">
<p>
No, that's UNIX, but that's not necessarily jq. Too see what's wrong, we have to break down the earlier jq statement a little more &#x2013; you know, the one that just gives us the unsorted list:
</p>

<p>
<textarea cols="80" rows="4">
maas admin machines read | jq -r '(["HOSTNAME","SYSID",
"TAGS", "POOL","ZONE"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .tag_names[0] // "-", 
.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
If we read it from left to right, we have the MAAS command that generates the JSON to begin with:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines read</textarea>
</p>

<p>
We pipe that through jq, with raw output:
</p>

<p>
<textarea cols="80" rows="1">
| jq -r</textarea>
</p>

<p>
We give jq some series of commands, between the single quotes:
</p>

<p>
<textarea cols="80" rows="1">
'(["HOSTNAME", blah, blah, blah | @tsv'</textarea>
</p>

<p>
Finally, we pipe that to column to make the columns line up nicely:
</p>

<p>
<textarea cols="80" rows="1">
| column -t</textarea>
</p>

<p>
So essentially, from a UNIX perspective, we have a data source and two filters:
</p>

<p>
<textarea cols="80" rows="1">
maas <options> | jq <options> | column <options></textarea>
</p>

<p>
The options we give to jq most definitely don't work like UNIX.
where's the data coming from?
</p>

<p>
A great question to ask yourself when building jq blocks is, "Where's the data coming from?" Let's take a closer look at the jq options:
</p>

<p>
<textarea cols="80" rows="5">
'(["HOSTNAME","SYSID","TAG","POOL","ZONE"] |
(.,map(length*"-"))),
(.[]  |
[.hostname, .system_id, .tag_names[0] // "-",.pool.name,.zone.name]) |
@tsv'</textarea>
</p>

<p>
Ask yourself where the array data is coming from. Does anything in this line retrieve data?
</p>

<p>
<textarea cols="80" rows="1">
'(["HOSTNAME","SYSID","TAG","POOL","ZONE"] |</textarea>
</p>

<p>
Nope. Those are literals, which don't retrieve any data at all. How about the next line?
</p>

<p>
<textarea cols="80" rows="1">
(.,map(length*"-"))),</textarea>
</p>

<p>
No, that line acts on data it gets, but it doesn't get data. And the next one?
</p>

<p>
<textarea cols="80" rows="1">
(.[] |</textarea>
</p>

<p>
Yep, that's it. The .[] command tells jq to iterate over what it gets. The rest of the line just tells jq which of the fields in the .[] iteration to actually retrieve.
</p>

<p>
So by process of elimination, there's only one place we could sort data &#x2013; where it comes into the command, that is, where we currently iterate over the incoming JSON arrays, .[].
</p>
</div>
</div>

<div id="outline-container-org4265b09" class="outline-6">
<h6 id="org4265b09">So how does "sortby()" work?</h6>
<div class="outline-text-6" id="text-org4265b09">
<p>
The "sortby()" subcommand operates on whatever it gets. In this case, we're sending it a JSON array of machine datasets. So there are two things wrong with our first attempt:
</p>

<p>
<textarea cols="80" rows="4">
maas admin machines read | jq -r '(["HOSTNAME","SYSID",
"TAGS", "POOL","ZONE"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .tag_names[0] // "-", 
.pool.name,.zone.name] | sort_by(.hostname)) | @tsv' | column -t</textarea>
</p>

<p>
First, it's set up to handle a single JSON dataset, and sort it by a single parameter &#x2013; sort_by(.hostname) &#x2013; so there's actually nothing to sort, hence an error. Second, we trying to pipe a formatted entry from an array of JSON datasets through it, which doesn't even make any sense: you can't sort one thing.
</p>

<p>
To make the command work, we have to make sort_by itself the data source. In other words, we want jq to sort the record stream before it gets our field list, like this:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines read | jq -r '(["HOSTNAME","SYSID","TAG","POOL","ZONE"] | (., map(length*"-"))),(sort_by(.hostname)[] | [.hostname,.system_id,.tag_names[0],.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
As we can see, this command works as we expect:
</p>

<p>
<textarea cols="80" rows="12">
HOSTNAME       SYSID   TAG       POOL      ZONE
--------       -----   ---       ----      ----
ace-colt       hfm84c  zork      tidal     defense
amazed-hermit  mehgsk  xyzzy     swimming  twilight
daring-minnow  ceamb4  plover    car       demilitarized
fun-ibex       8pq6qx  zork      car       fault
mutual-cod     sxbkyp  bedquilt  tidal     defense
nearby-koala   k6cagg  xyzzy     car       twilight
nearby-louse   ed8pda  plover    swimming  defense
novel-cod      4ds3eh  dunnet    swimming  fault
superb-koi     6sqads  xyzzy     swimming  twilight
unique-donkey  tsf8tk  plover    tidal     demilitarized</textarea>
</p>

<p>
Reading the new command from left to right helps understand it. Basically, it reads: "Take the data for all machines from MAAS, display a heading line and a horizontal rule line; then sort the machine data by hostname, and show the following 5 parameters, in tab-separated rows, lined up in neat columns."
</p>
</div>
</div>

<div id="outline-container-org61af7c5" class="outline-6">
<h6 id="org61af7c5">Checking our work</h6>
<div class="outline-text-6" id="text-org61af7c5">
<p>
We can check our work by trying different sorts:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines read | jq -r '(["HOSTNAME","SYSID","TAG","POOL","ZONE"] | (., map(length*"-"))),(sort_by(.system_id)[] | [.hostname,.system_id,.tag_names[0],.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
This command sorts by system ID:
</p>

<p>
<textarea cols="80" rows="12">
HOSTNAME       SYSID   TAG       POOL      ZONE
--------       -----   ---       ----      ----
novel-cod      4ds3eh  dunnet    swimming  fault
superb-koi     6sqads  xyzzy     swimming  twilight
fun-ibex       8pq6qx  zork      car       fault
daring-minnow  ceamb4  plover    car       demilitarized
nearby-louse   ed8pda  plover    swimming  defense
ace-colt       hfm84c  zork      tidal     defense
nearby-koala   k6cagg  xyzzy     car       twilight
amazed-hermit  mehgsk  xyzzy     swimming  twilight
mutual-cod     sxbkyp  bedquilt  tidal     defense
unique-donkey  tsf8tk  plover    tidal     demilitarized</textarea>
</p>

<p>
We can also try pool name:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines read | jq -r '(["HOSTNAME","SYSID","TAG","POOL","ZONE"] | (., map(length*"-"))),(sort_by(.pool.name)[] | [.hostname,.system_id,.tag_names[0],.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
which also works as we'd expect:
</p>

<p>
<textarea cols="80" rows="12">
HOSTNAME       SYSID   TAG       POOL      ZONE
--------       -----   ---       ----      ----
nearby-koala   k6cagg  xyzzy     car       twilight
daring-minnow  ceamb4  plover    car       demilitarized
fun-ibex       8pq6qx  zork      car       fault
nearby-louse   ed8pda  plover    swimming  defense
novel-cod      4ds3eh  dunnet    swimming  fault
superb-koi     6sqads  xyzzy     swimming  twilight
amazed-hermit  mehgsk  xyzzy     swimming  twilight
ace-colt       hfm84c  zork      tidal     defense
unique-donkey  tsf8tk  plover    tidal     demilitarized
mutual-cod     sxbkyp  bedquilt  tidal     defense</textarea>
</p>
</div>
</div>

<div id="outline-container-orgb67a162" class="outline-6">
<h6 id="orgb67a162">Sorting by more than one parameter</h6>
<div class="outline-text-6" id="text-orgb67a162">
<p>
To sort by more than one parameter, simply include a comma-separated list of parameters for the sort, in order. For example, to sort by tag first and pool next, use this incantation:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines read | jq -r '(["HOSTNAME","SYSID","TAG","POOL","ZONE"] | (., map(length*"-"))),(sort_by(.tag_names[0],.pool.name)[] | [.hostname,.system_id,.tag_names[0],.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
This will give you:
</p>

<p>
<textarea cols="80" rows="10">
mutual-cod     sxbkyp  bedquilt  tidal     defense
novel-cod      4ds3eh  dunnet    swimming  fault
daring-minnow  ceamb4  plover    car       demilitarized
nearby-louse   ed8pda  plover    swimming  defense
unique-donkey  tsf8tk  plover    tidal     demilitarized
nearby-koala   k6cagg  xyzzy     car       twilight
superb-koi     6sqads  xyzzy     swimming  twilight
amazed-hermit  mehgsk  xyzzy     swimming  twilight
fun-ibex       8pq6qx  zork      car       fault
ace-colt       hfm84c  zork      tidal     defense</textarea>
</p>

<p>
You can even try three parameters. Note that I set this up with the two hosts "superb-koi" and "amazed-hermit" &#x2013; so we can use a command like this to see how multiple parameters work:
</p>

<p>
<textarea cols="80" rows="1">
maas admin machines read | jq -r '(["HOSTNAME","SYSID","TAG","POOL","ZONE"] | (., map(length*"-"))),(sort_by(.tag_names[0],.pool.name,.hostname)[] | [.hostname,.system_id,.tag_names[0],.pool.name,.zone.name]) | @tsv' | column -t</textarea>
</p>

<p>
Note that "superb-koi" and "amazed-hermit" have changed places in the listing below:
</p>

<p>
<textarea cols="80" rows="12">
HOSTNAME       SYSID   TAG       POOL      ZONE
--------       -----   ---       ----      ----
mutual-cod     sxbkyp  bedquilt  tidal     defense
novel-cod      4ds3eh  dunnet    swimming  fault
daring-minnow  ceamb4  plover    car       demilitarized
nearby-louse   ed8pda  plover    swimming  defense
unique-donkey  tsf8tk  plover    tidal     demilitarized
nearby-koala   k6cagg  xyzzy     car       twilight
amazed-hermit  mehgsk  xyzzy     swimming  twilight
superb-koi     6sqads  xyzzy     swimming  twilight
fun-ibex       8pq6qx  zork      car       fault
ace-colt       hfm84c  zork      tidal     defense</textarea>
</p>

<p>
So there's a little more jq for you, but still a lot more to learn. Might as well keep going with this, it seems to be useful to some folks &#x2013; so more jq to come.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org68934e6" class="outline-4">
<h4 id="org68934e6">Networking tutorial</h4>
<div class="outline-text-4" id="text-org68934e6">
</div>
<div id="outline-container-orgdb25c19" class="outline-5">
<h5 id="orgdb25c19">About networking</h5>
<div class="outline-text-5" id="text-orgdb25c19">
<p>
Centuries ago, John Milton wrote, "I cannot praise a fugitive and cloistered virtue," referring, at least in part, to those who keep their intelligence to themselves.  Without some form of communication &#x2013; without manifesting that intelligence in word or deed &#x2013; there is generally no evidence of intelligence or intelligent life.  Our knowledge must create ripples in space and time if it is to be shared, and it must be shared to benefit others.
</p>

<p>
For this reason, we create networks, which might be defined as "channels of sharing".  All virtue and all goodness is valued only in sharing, whether by having mercy on another person or communicating the answer to life, the universe, and everything.  Only by sharing do we come to the notice of others, and only with the help of others do we share the load of living.
</p>
</div>
</div>
<div id="outline-container-org4b88ad1" class="outline-5">
<h5 id="org4b88ad1">Channels of sharing are complicated</h5>
<div class="outline-text-5" id="text-org4b88ad1">
<p>
Sharing involves risk.  Will the other person understand?  Will they accept what I've shared, or turn against me?  Will they appreciate what I have shared, or judge me harshly?  All communication involves the risks of misunderstanding, judgement, and ridicule.  We must choose carefully when sharing information, tools, knowledge &#x2013; even compassion, love, loyalty, and devotion.  In a way, that's one of the "equations" of living in a society, although public social media platforms have made that more, er, interesting.
</p>

<p>
Often we segregate our sharing based on some measurable characteristic.  For example, we share with people of our own race, gender, color, or national origin, but not with the "others".  And we share in different ways with different social groups.  In fact, you might say that the average person has as many personalities as there are groups of people whose opinions they care about: we are one person at home, another at the office, still another on the Internet, and yet another when we're golfing, as examples.  Each of these channels can have different rules, mores, idioms, dialects, and vocabulary.
</p>

<p>
As we grow up, we learn to be <i>one</i> self, sharing with everyone in very much the same way, restricting only <i>what</i> we share, not <i>how</i> we share it.  You begin to deeply understand the basics of human communication.  If you're serious about it, you begin to try to normalise your messaging to include less moody prejudice and more honest opinion, modulated only by personal privacy.
</p>

<p>
Thus it has been with computer networks.  For a very long time, there were at least as many network protocols &#x2013; <i>selves</i> &#x2013; as there were brands and styles of computers.  Different methods were needed to share information from one system to another, sometimes even involving specially-crafted physical interface cables to handle the translation.
</p>

<p>
Eventually, though, computer networks began to gravitate toward a standard approach, "one self to rule them all", as it were.  This singular personality is known as TCP/IP.  Learning how the TCP/IP protocols work will serve you well in understanding, designing, and debugging computer networks.
</p>

<p>
Let's get started.
</p>
</div>
</div>
<div id="outline-container-orgc54223c" class="outline-5">
<h5 id="orgc54223c">Adversarial beginnings</h5>
<div class="outline-text-5" id="text-orgc54223c">
<p>
If you're going to learn a new language, it's probably important to get an idea of the culture.  After all, culture defines the vocabulary and the level of abstraction of a country's language.  Certainly that's true of networking.
</p>

<p>
Computer networks began largely because of the ways humans segregate their sharing, not out of a desire to share freely.  TCP/IP &#x2013; and a lot of its underlying structure &#x2013; evolved to meet a specific need: how can we keep a computer network functioning in the event of a nuclear war? When nodes go offline, randomly, how can surviving nodes keep the communication going?  If Boise is destroyed, how can we still communicate with Seattle?  Wiping out Kansas should not imply that we can't connect with Nebraska.
</p>

<p>
Gruesome beginnings, indeed.  Over time, though, those same TCP/IP networks evolved to meet a less bellicose need: How can we keep a network functioning efficiently if some of the paths are bottle-necked or even out-of-service?  Well, the answer is, "build the ARPAnet" – now called the Internet – which relies heavily on TCP/IP networks. The OSI model underlying TCP/IP can adapt to changing loads, handle significant failures, and strictly limit the network “blast radius” (yes, sadly, that’s what it’s called) when things go wrong.  TCP/IP networks distil the core of human sharing into (arguably) a much simpler and more predictable form.
</p>

<p>
Happily, the threat of nuclear war has dropped off substantially in the meantime, though it sometimes raises an ugly eyebrow.  Also happily, the TCP/IP network has survived even the loss of its original purpose. This tutorial is about the surviving network.  Full disclosure: I used to work in the WMD industry, but one day, I walked away and chose to promote sharing with other humans, instead of dividing and cloistering them.  And I changed my official term for network failures from "blast radius" to "cone of silence" (CoS), probably my happiest choice of all.
</p>
</div>
</div>
<div id="outline-container-org28db3cc" class="outline-5">
<h5 id="org28db3cc">Focusing on architecture</h5>
<div class="outline-text-5" id="text-org28db3cc">
<p>
With complicated subjects, it's always hard to know where to start. There's a huge chicken-and-egg problem with TCP/IP when trying to define terms. I prefer to take Isaac Newton's approach to physics, as he did in the Principia &#x2013; create some definitions that start from common things we're all likely to understand.
</p>

<p>
For example, Newton begins with mass; slightly paraphrasing his definition:
</p>

<ul class="org-ul">
<li>The quantity of matter is defined as the density of that matter and the volume that it takes up, conjointly.</li>
</ul>

<p>
In other words, m = ρ x V, or "mass equals density times volume". That doesn't seem like much, but it's an astounding starting point. Hint: If you haven't read an English translation of the Principia (it's natively in Latin), you should take the time out to do so: it'll change your understanding. Anyway, back to our story.
</p>
</div>

<div id="outline-container-orga2845d4" class="outline-6">
<h6 id="orga2845d4">Network architecture</h6>
<div class="outline-text-6" id="text-orga2845d4">
<p>
It's very easy to just dive in, of course, and some fair percentage of my readers will get what I'm saying, but that isn't good enough for this tutorial. Instead, imagine two computers, "SanDiego" and "Bangor", located at opposite corners of the country. They want to communicate via available networks. How do they do it?
</p>

<p>
Well, we could just hook up a wire between SanDiego and Bangor:
</p>


<div id="orgf5c8850" class="figure">
<p><img src="images/sandiego-bangor.jpg" alt="sandiego-bangor.jpg" />
</p>
</div>

<p>
People probably did that, at one point, back in the day. It might have even worked, until someone with a backhoe cut a cable.  No problem! We'll just use two wires.  Surely we can get the first one fixed before somebody cuts the second one, right?
</p>


<div id="org26e5973" class="figure">
<p><img src="images/sandiego-bangor-2.jpg" alt="sandiego-bangor-2.jpg" />
</p>
</div>

<p>
Of course, it wouldn't take long to figure out that messages are getting lost and garbled.  After all, it's a long wire, which has lots of impedance. Some signals will disappear into the noise long before they get there. No problem!  We'll just build repeaters, little boxes that read the incoming signal and duplicate it at full voltage on the outgoing line:
</p>


<div id="orgec9fab8" class="figure">
<p><img src="images/sandiego-bangorA.jpg" alt="sandiego-bangorA.jpg" />
</p>
</div>

<p>
(Forgive the weird choice of cities, but I'm trying to work from memory here.) And if memory serves, leasing this space all over the country to add repeaters &#x2013; especially at military bases like Redstone (Huntsville), Fort Hood, and Point Mugu &#x2013; can get really expensive, really fast.
</p>
</div>
</div>

<div id="outline-container-org25f7f0f" class="outline-6">
<h6 id="org25f7f0f">The AAC network model</h6>
<div class="outline-text-6" id="text-org25f7f0f">
<p>
By far a much easier way is to create and use the Internet. As the Internet became "the network", it evolved into what some call the "access-aggregation-core" network.  
</p>

<p>
In the AAC model, SanDiego sends a message, labelled for Bangor, to some router on the Internet (which one doesn't matter so much). If this router doesn't know where Bangor is, it just sends it on to another router, until the message finds a router that knows where to forward the message:
</p>


<div id="org8d009ed" class="figure">
<p><img src="images/sandiego-bangor-3.jpg" alt="sandiego-bangor-3.jpg" />
</p>
</div>

<p>
Theoretically, this works great, but from a practical standpoint, there are "short circuits" all over this network:
</p>


<div id="orga640b5f" class="figure">
<p><img src="images/network-shortcuts.jpg" alt="network-shortcuts.jpg" />
</p>
</div>

<p>
These "sideways paths" are there mostly for performance reasons, like latency, redundancy, and so on. Sometimes they're there because someone can get a better deal, so the reasoning is financial, too. Later on in this tutorial, we'll talk about some of these issues &#x2013; and why network architectures have evolved. For now, though, let's just say that they have evolved to a more monochromatic design known at the Clos architecture:
</p>


<div id="orgcbe1b86" class="figure">
<p><img src="images/clos-network-topology.jpg" alt="clos-network-topology.jpg" />
</p>
</div>

<p>
This more scalable architecture can basically use the same switch for everything. There are leaf switches, known as "top of rack" (TOR) switches, and spine switches. As I've ghosted into the diagram, you scale horizontally by adding more racks, and vertically by adding more levels of spine switches. This architectural model is more economical to scale, so it discourages these little "side bets" that plagued the early Internet.
</p>
</div>
</div>

<div id="outline-container-orgd006907" class="outline-6">
<h6 id="orgd006907">Yesterday’s phone network is today’s Internet</h6>
<div class="outline-text-6" id="text-orgd006907">
<p>
When learning a language, it also helps to get into some of the <i>history</i> of the people who speak that language.  For instance, you may have noticed that a lot of Cajuns &#x2013; who live in the humid swamps of the southern United States &#x2013; often build houses in a unique way.  They build a very sloped main roof, surrounding the house with a somewhat-elevated, wraparound porch.
</p>

<p>
To be honest, this design makes <i>no</i> sense for a people living in "hurricane alley".  They'd be better off building houses out of concrete block, with a metal and concrete roof tied to the base with welded steel girders, and small windows instead of French doors.  But they don't, because of their <i>history</i>.
</p>

<p>
The word "Cajun" is a lazy contraction of <i>Acadian</i>, the people who lived in Acadia, or "New France" in the 17th and 18th centuries.  If you look it up, you'll find that Acadia included New Brunswick, Maine, and lots of Canadian maritime islands.  They built houses with high-pitched roofs, with wraparound porches, so that the heavy <i>snow load</i> of winter would slide down the sloped roof, scoot off the porch roof, and land in the yard.  This gave them a clear outside area to take care of outside business, such as chopping wood or skinning animals, without having to wade through the snow.
</p>

<p>
As a homework assignment, you can Google how the Acadians got to South Louisiana and South Mississippi; Wikipedia is largely accurate, if local folklore means anything.
</p>
</div>

<ul class="org-ul">
<li><a id="org7effbf8"></a>Reusing what already works<br />
<div class="outline-text-7" id="text-org7effbf8">
<p>
In the same way, most of today’s modern networking is just a direct translation of the landline telephone system &#x2013; <a href="https://networkencyclopedia.com/plain-old-telephone-service-pots/">the "Plain Old Telephone Service (POTS)</a>" &#x2013; into the digital space. Network switching is really just an outgrowth of crossbar, which is how local phone calls were “switched” or “routed” to the correct telephone line. In most cases, every number dialled closed one more relay, with all seven relays making a connection to the target phone line.
</p>

<p>
Small exchanges often “swallowed” dialled digits. For example, if every local phone number had the exchange “881”, those numbers wouldn’t trigger any relays beyond just sending the call to the “881” frameset. In some small exchanges, it wasn’t even necessary to dial the exchange, just the four digits of the phone number, if the caller had the same exchange. My grandparents had such an arrangement for many years, as did my partner's parents.
</p>

<p>
Essentially, these "shorthand numbers" were the early <i>subnets</i>.
</p>
</div>
</li>

<li><a id="org4aa330c"></a>Long distance and T1<br />
<div class="outline-text-7" id="text-org4aa330c">
<p>
In order to maintain call quality, the very early telephone system (about 1908) began to use repeaters and loading coils.  A repeater receives a signal and regenerates a new signal of the same frequency, raising the signal back to the same power level.  A loading coil adds inductance to the line, which resists changes in current, keeping the transmitted waveform more stable, that is, reducing the distortion introduced by the impedance of the long wires.
</p>

<p>
The next evolution, T1 lines, couldn’t compete with today’s fibre
connections, but they did provide a speedy (at the time) 1.5Mbps
connection. For example, in the oil and gas industry of the early
1990s, many of the city offices in New Orleans had wall after wall of
T1 lines wired directly into the building, so that they could get
high-speed data from the offshore oil platforms just a few miles away.
</p>

<p>
T1 wasn’t originally designed for network traffic.  The idea was to
multiplex phone calls on one line via Time-Division Multiplexing. TDM
split up the call traffic into little <i>digital</i> packets that were sent
on a rotating basis. The first T1 lines, which showed up around 1962,
could handle about 24 calls without the average telephone user
noticing. Telephone linemen, on the other hand, could usually tell by
the “clipped” nature of the call, as there is a distinctive flatness
to the conversation over a digital TDM circuit.
</p>

<p>
My first real job was telephone lineman, so I can attest to this
"flatness".  In fact, I recall an actual training session in which we listened to the same call on two different lines in stereo headphones.  In one ear, we heard the T1 call; in the other, the analog output of the same conversation.  Listening to them in stereo, in sync, made it easy to learn the subtle differences.
</p>

<p>
The real point is that these “little digital packets” formed the model
for the <i>packet networking</i> we have today.
</p>
</div>
</li>

<li><a id="org3f244ec"></a>On the shoulders of giants<br />
<div class="outline-text-7" id="text-org3f244ec">
<p>
Especially in the computer field, people who come up with new ideas
love to pretend that they invented it.  But as Newton said (him
again?), we are "standing on the shoulders of giants".  In fact, it
actually helps if you realise that today's networking technology
evolved from telephone technology, which evolved from carbon fibres
and cups of acid, which evolved from telegraph clickers, which evolved
from cans and strings&#x2026;.  If you look back far enough, everything
about modern networks makes perfect sense, because you can see the
original problems that drove today's designs.
</p>

<p>
For example, telephone connections have used balanced or twisted pair wiring for more than 100 years.  Twisted pairs resist interference from other pairs of wires <i>because</i> they are twisted together.  I have <i>read</i> that in the very early days, the called party transmitted on one wire, and the calling party transmitted on the other, but I've never been able to make much mathematical sense of that, so take that with a small box of salt.
</p>

<p>
T1 lines just used ordinary, <i>double</i>-twisted-pair copper wiring.  When WAN and MAN networking became a thing, the phone company just repurposed some of those pairs to carry data traffic. Many other key elements of TCP/IP, like twisted-pair Ethernet cables, packet-based messaging, and multiplexing (like TDM), are all just holdovers of the original telephone system, repurposed for computer networking. Why invent something when you have a working model? Just rename it.
</p>
</div>
</li>

<li><a id="orgb96e544"></a>To be fair&#x2026;<br />
<div class="outline-text-7" id="text-orgb96e544">
<p>
Actually, in many cases, renaming isn't actually a <i>terrible</i> idea, because it often conveys the repurposing aspect of the new technology.  You can buy t-shirts that say, "It's not really a cloud, it's just someone else's server," but it's actually <i>useful</i> to say "cloud".  That implies that it's out there somewhere (you don't care where), it may change randomly (as with the weather, you still don't care), and you don't have to do anything about it.
</p>

<p>
Using the word "cloud" also kind of forces the providers to guarantee the promise that you won't ever have to know anything about it except an address where you can get to it, and maybe a handy script to upload changes every time you save.  The new name carries implications that can't be drawn so easily from the term "someone else's server", and that helps to set expectations and standards.  
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org1328a08" class="outline-6">
<h6 id="org1328a08">The Internet infrastructure</h6>
<div class="outline-text-6" id="text-org1328a08">
<p>
There's an idea floating around that the Internet is survivable because any and every computer can connect any and every other computer. While that might be possible, that's not generally how it works. There's actually a hierarchy which we refer to as the Internet Infrastructure:
</p>

<ul class="org-ul">
<li>Internet Infrastructure
&#x2013; a hierarchy of computers used to transfer messages from one computer to another.</li>
</ul>

<p>
Yes, the Internet is <i>theoretically</i> survivable because every computer can connect to every other computer, but that’s not standard operating procedure. High-level networks (Network Service Providers, NSPs) connect to at least three top level nodes called Network Access Points (NAPs), aka Internet Exchange Points. At these points, packets to jump from one NSP to another. NAPs are public access points, Metropolitan Area Exchanges are private. These are virtually indistinguishable for the purposes of this discussion:
</p>


<div id="org1d2b194" class="figure">
<p><img src="images/sandiego-bangor-4.jpg" alt="sandiego-bangor-4.jpg" />
</p>
</div>

<p>
And, of course, by now you've probably guessed that many of the MAEs are the residue of the phone company’s early T1 nodes, which was the initial backbone for the Internet. These MAEs act just like a NAP for the purposes of this discussion.
</p>
</div>
</div>

<div id="outline-container-org15688a0" class="outline-6">
<h6 id="org15688a0">About Internet network traffic</h6>
<div class="outline-text-6" id="text-org15688a0">
<p>
On-the-fly, Internet network paths can become very complicated and somewhat unpredictable. As a result, there’s rarely a reason to even count how many hops a message takes, or where it hops, unless you’re trying to debug a broken route with, say, <code>traceroute</code>. From a TCP/IP point of view, it’s much easier to ignore the specific network, since each one is custom built, so to speak. The path can theoretically change every time a message is sent, even between the same two computers.
</p>

<p>
When it comes to designing and troubleshooting networks, knowing the specific route (almost) never helps. What we do want to know about is the network traffic between computers. We have to understand what kind of data travels between computers, besides just the data we send. The structure and grouping of message traffic in TCP/IP is governed by the <b>OSI model</b>.  Let's take a look.
</p>
</div>
</div>
</div>
<div id="outline-container-org3a29fe1" class="outline-5">
<h5 id="org3a29fe1">The OSI model</h5>
<div class="outline-text-5" id="text-org3a29fe1">
<p>
No, that's not referring to the WWII forerunner of the CIA (which was the <i><a href="https://en.wikipedia.org/wiki/Office_of_Strategic_Services">OSS</a></i> anyway), but to the <i>Open Systems Interconnect</i> model, once called "<a href="https://en.wikipedia.org/wiki/Government_Open_Systems_Interconnection_Profile">GOSIP</a>".  Networks are really just continuous wires. We need to understand what travels on those wires, which depends on our perspective – our level of magnification.
</p>

<p>
At the highest “zoom” level, all we’ll see are electrons travelling
down the wire; that’s a level of abstraction that isn’t comprehensible
for debugging purposes. About all we can tell is whether or not the
circuit’s dead &#x2013; and not even that, if we don't pick a low range on the voltmeter.
</p>

<p>
The Open Systems Interconnection model was created to standardise on a few, well-defined levels. It defines how the data should be <i>encapsulated</i>, how the transmission "dance" is carried out, and what to do when things go wrong.  Collectively, this <i>interface definition</i> is called a <i>protocol</i>.  As long as you follow the protocol, it doesn't matter how you build your network device.
</p>

<p>
The OSI model looks something like this:
</p>


<div id="orgb322936" class="figure">
<p><img src="images/osi-model.jpeg" alt="osi-model.jpeg" />
</p>
</div>

<p>
This model starts just <i>above</i> the raw physics, with the <b>physical layer</b>, also known as <b>Layer 1</b>.
</p>

<p>
The choice of “1” makes sense, because this is the lowest level we consider. Layers are normally added on top of each other. For example, if you put six coats of varnish on a piece of furniture, you’re going to have six layers. The first layer you put on wouldn’t sensibly be called “layer 6”; neither does network layering work that way.
</p>

<p>
Here’s a quick rundown of what each layer does. Most likely, we won’t get into details about all the layers, because the higher you go, the more widely they vary with the user application. Higher layers don’t really help us better understand networking, any more than watching electrons travel through a wire help us debug a missing packet.
</p>
</div>

<div id="outline-container-org073cf04" class="outline-6">
<h6 id="org073cf04">The physical layer (L1)</h6>
<div class="outline-text-6" id="text-org073cf04">
<p>
The phrase “physical layer” may conjure up notions of physics, but don’t worry: we look at <i>signals</i>, not <i>electrons</i>. At the physical layer, we’re looking for binary (on/off) signals, set to the cadence of a clock. Every computer brings its own clock to the party, so we definitely need a way to “synchronise our watches”. NTP, the network time protocol, does the trick.
</p>

<p>
NTP is probably the oldest Internet protocol in use.  It synchronises subscriber computers to within a few milliseconds of UTC (Coordinated Universal Time).  That acronym is <i>not</i> out of order, by the way.  English speakers wanted CUT (for "coordinated universal time"), while French speakers preferred TUC (for "temps universel coordonné").  "UTC" was picked because, (1) it was a compromise between those two proposals, and (2) there was already a "UT" (Universal Time) that is based on a measure of the Earth's current angle of rotation and the International Celestial Reference Frame&#x2026;.
</p>

<p>
Yeah, it really <i>is</i> better if you don't ask.
</p>

<p>
You could say that NTP only has one job: keeping time.  Like all the moving parts of a clock, though, keeping computer clocks in sync is very difficult.  If your curiosity is stronger than your fear of complexity, you might <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">take a look at this NTP article on Wikipedia</a>.  It'll tell you more than you need to know about the protocol.
</p>
</div>

<ul class="org-ul">
<li><a id="org11911b2"></a>Variable latency<br />
<div class="outline-text-7" id="text-org11911b2">
<p>
Variable latency is the important thing to know about the physical layer, because it affects the timing of network traffic. In order to understand variable latency, we need to understand network latency. Packets aren’t sent without some delay, because of:
</p>

<ul class="org-ul">
<li>The processing delay - how long it takes the router to process the packet header.</li>
<li>A queuing delay - how long the packet sits idle in routing queues.</li>
<li>Transmission delay - how long it takes layer 1 to push the packet’s bits onto the link.</li>
<li>Propagation delay - how long it takes the bits to travel through the wire to the other end.</li>
</ul>

<p>
The size of the queue directly influences how fast data can get onto the link. The processing and transmission delays are real, though relatively constant. The propagation delay doesn’t just depend on the speed of light, because there may be lots of other “relay” computers in the link. Propagation depends on network architecture, network congestion, and the number of hops (how many routers between source and destination), among other things. As we’ll see later on, within your enterprise, modern cloud architectures usually create significantly less propagation delay.
</p>

<p>
Variable-latency networks are “variable” because of the density of network traffic and the complexity of the route between hosts. We can’t predict congestion or routing, although we can influence local routing by choosing the right network architecture. We can’t predict transmission delays, though we can statistically bound them. Almost all digital networks are considered “variable-latency”.
</p>
</div>
</li>

<li><a id="orgc6d8017"></a>The physical layer is not very interesting<br />
<div class="outline-text-7" id="text-orgc6d8017">
<p>
In spite of the complexities given above, the physical layer really
doesn't do much for us when it comes to building and debugging
networks.  Other than verifying that signals are flowing, the physical
layer doesn’t usually tell us much about what happened to that DHCP
request that never made it to the router. Consequently, we really
won’t talk that much about the physical layer.
</p>

<p>
Just know that it’s the thing that’s passing bits back and forth
between hosts, and very occasionally, we need to scan it to find network breakage.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org1c9cd66" class="outline-6">
<h6 id="org1c9cd66">The datalink layer (L2)</h6>
<div class="outline-text-6" id="text-org1c9cd66">
<p>
The <b>datalink layer</b> (the <b>link layer</b>, <b>Layer 2</b> or <b>L2</b>) also has one purpose: send and receive IP datagrams. L2 doesn’t maintain a connection with the target host; it’s intentionally “connectionless”, and it doesn’t guarantee delivery or integrity of packets. It just ships them between source and destination.  Give it a message, give it a MAC address, and it sends it; that's all.
</p>

<p>
At first, this message-agnostic approach may seem a little weird. L2 is not without error-checking and recovery code, but it functions efficiently <i>precisely</i> because it isn’t concerned with the data, or even the message containing the data. That might surprise you, especially since the word "datagram" is sometimes used a little too freely with respect to L2.
</p>

<p>
A datagram is just a basic network transfer unit – the indivisible
unit for a given layer &#x2013; <i>any</i> given layer. If we’re talking about
L2, it’s an IEEE 802.xx frame. At the network layer (L3, we'll come to
that in a minute), it’s a data packet. For the transport layer (L4), it
would be called a segment.
</p>

<p>
By now, you're probably wondering what the indivisible units in the
<i>physical layer</i> are called.  <i>Chips</i>; they're called chips. Beats me.
But I do know that they are <a href="https://en.wikipedia.org/wiki/Spread_spectrum">spread-spectrum</a> pulses in the CDMA,
noise-utilising transmission system that operates at that layer.  My advice?  Unless you're a EE with some communications training, you might not need to go there.
</p>

<p>
Since datagram isn’t carefully used by everyone (think of User Datagram Protocol), we’ll agree to call these indivisible layer units PDUs (protocol data units). This avoids conflation with other uses and reminds you that it’s the atomic unit at the current network layer. Just remember that, at the link layer (L2), it’s a frame.
</p>
</div>

<ul class="org-ul">
<li><a id="org782ee83"></a>MAC frames<br />
<div class="outline-text-7" id="text-org782ee83">
<p>
A MAC frame, or just “frame”, encapsulates the packets from the network layer so that they can be transmitted on the physical layer. A frame can be small or big, anywhere from 5 bytes up to the kilobyte range. The upper size limit is called the maximum transmission unit (MTU) or maximum frame size. This size is set by the particular network technology in use.
</p>

<p>
This last observation brings up a good point: In order to talk sensibly about frames, we’d need to say what kind of frame. We’re almost always talking about packet-switched networks, so there are potentially four frame types to consider: Ethernet, fibre channel, V.42, and PPP (point-to-point protocol).
</p>

<p>
Happily, Internet networks almost exclusively use Ethernet, as defined in the IEEE 802 standards, so we’ll stick to that particular frame type for this discussion. Where other frame types may come into play, we’ll discuss those as special cases.
</p>
</div>
</li>

<li><a id="org4b61fde"></a>Ethernet<br />
<div class="outline-text-7" id="text-org4b61fde">
<p>
Before explaining an Ethernet Frame, we need to give a little background information about how Ethernet works; otherwise a lot of the frame components either won’t make sense, or you’ll wonder how it works at all.
</p>

<p>
Remember earlier, when we talked about voice radio, and the need to say “over”? Well, Ethernet at the link layer is all about controlling the conversation, so that computers don’t “talk over each other”. Ethernet implements an algorithm called CSMA/CD, which stands for “carrier sense multiple access with collision detection.” This algorithm controls which computers can access the shared medium (an Ethernet cable) without any special synchronisation requirements.
</p>

<p>
“Carrier sense” means that every NIC does what humans (should) do when we’re talking: it waits for quiet. In this case, it’s waiting for the network to be quiet, that is, when no signal is being sent on the network.
</p>

<p>
“Collision detection” means that, should two NICs both start to send on a shared network at the same time (because the network was quiet), they each receive a jam signal. This signal tells them to wait a specific, randomly-generated amount of time before attempting again. Every time subsequent messages collide, the NIC waits twice the amount of time it previously waited. When it waits some maximum number of times, the NIC will declare a failure and report that the message didn’t go. This ensures that only one frame is traversing the network at any given time.
</p>
</div>
</li>

<li><a id="org6ac85c7"></a>Media Access Control (MAC)<br />
<div class="outline-text-7" id="text-org6ac85c7">
<p>
Systems like CSMA/CD are a subset of the Media Access Control (MAC) protocol kit. MAC is one-half of the link layer, with Logical Link Control (LLC) being the other half – though these are sometimes called sub-layers. LLC mostly just defines the frame format for the 802.xx protocols, like WiFi, so we can safely ignore it for the moment.
</p>

<p>
If you’ve worked with networks at all, you’ve heard of MAC addresses. Those are basically unique serial numbers assigned to network interface devices (like NICs) at the time of manufacture. Theoretically, they are unique in the world, not counting virtual NICs in virtual machine environments. MAC address collisions do happen when using VMs, and there are ways to fix it, assuming that your VMs are confined to a subnet.
</p>

<p>
The MAC sub-layer is connected to the physical layer by a media-independent interface (MII), independent of the actual link protocol (e.g, cellular broadband, Wi-Fi radio, Bluetooth, Cat5e, T1, …). You can learn more about the MII if you’re so inclined, but we won’t address it again in the context of this tutorial.
</p>

<p>
Essentially, the MAC sub-layer grabs higher-level frames and makes them digestible by the physical layer, by encoding them into an MII format. It adds some synchronisation info and pads the message (if needed). The MAC sub-layer also adds a frame check sequence that makes it easier to identify errors.
</p>

<p>
In conventional Ethernet networks, all this looks something like the following:
</p>


<div id="orgfde648d" class="figure">
<p><img src="images/mac-frame.jpeg" alt="mac-frame.jpeg" />
</p>
</div>

<p>
Let’s decode those blocks of bits:
</p>

<ul class="org-ul">
<li>The Preamble is 7 bytes of clock sync, basically just zeroes and ones like this: …0101010101… This gives the receiving station a chance to catch up and sync their clock, so the following data isn’t out of sync (and thus misinterpreted). To delve just a little deeper, the Preamble helps the receiving NIC figure out the exact amount of time between encoded bits (it’s called clock recovery). NTP is nice, but Ethernet is an asynchronous LAN protocol, meaning it doesn’t expect perfectly synchronised clocks between any two NICs. The Preamble is similar to the way an orchestra conductor might “count the players in” so they all get the same rhythm to start. Before clock recovery, there was MPE. Clock recovery is much more reliable than trying to get computers all over the world synced up to the same clock frequency and the same downbeat (starting point). Ethernet actually started out that way with something called Manchester Encoding or Manchester Phase Encoding (MPE). This was important because electrical frequency varies not only across the world, but also from moment to moment when the power is slightly “dirty”. MPE involved bouncing a bit between two fractional voltages using a 20MHz oscillator to generate a reference square wave. It works, but it’s not very efficient, so MPE was scrapped in favour of using the Preamble, the way that projectionists use alignment marks on reels of movie film.</li>

<li>The Start Frame Delimiter (SFD) is the last chance for clock sync. It is exactly 10101011, where the “11” tells the receiving station that the real header content starts next. The receiving NIC has to recover the clock by the time it hits the SFD, or abandon the frame to the bit bucket.</li>

<li>The Destination Address (DAddr) is six bytes long, and gives the physical address – the MAC address – of the next hop. Be aware that the next hop might be the destination, but it’s also possible that the next hop might be a NAP, MAE, NSP, or intermediate ISP. It’s basically the next address in the direction of the destination that the sender knows about. Unlike the Source Address, the Destination Address can be in a broadcast format (similar to a subnet like 192.18.0.0, but using MAC addresses).</li>

<li>The Source Address (SAddr) is also a six-byte MAC address, this time the MAC address of the sender, which does not change as long as the message is traversing only layer-2 (Ethernet) switches and routers.</li>

<li>The PDU Length (PDULen) gives the byte length of the entire frame, assuming that it’s 1500 or less. If it’s longer than that, it indicates a message type, like IPv4, ARP, or a “q-tagged” frame, which carries a VLAN ID.</li>

<li>The DSAP, SSAP, and Control elements are each one byte in length, and help define devices and protocols. For the most part, we won’t be worried about these with typical networks. Just know that as more and more 802 point-standards come out (e.g., 802.11, WiFi), these elements get longer and more complex.</li>

<li>The Data or “Payload” is the actual packet being sent, which in the case of TCP/IP, is just a TCP header attached to a fixed-length chunk of the application’s data. It’s passed on from the layer above. It cannot be less than 46 bytes, and in conventional Ethernet, it cannot be larger than 1500 bytes. If the actual data is too small, it’s padded out to 46 bytes.</li>

<li>The CRC or “Frame Checksum” (FCS) is a standard checksum, used to verify that the message hasn’t been corrupted along the way.</li>
</ul>

<p>
The Preamble and SFD are often considered to be part of the IEEE “packet”, so some people start counting the “frame” at the Destination Address. That distinction shouldn’t affect anything meaningful that we do with networks, but it’s nice to keep in mind, in case you run into someone who groups packets differently than you do.
</p>
</div>
</li>

<li><a id="org8545b8a"></a>Trunking VLANs<br />
<div class="outline-text-7" id="text-org8545b8a">
<p>
There is a crucial modification to the basic frame format called a P/Q or VLAN Tag. This allows something called VLAN trunking, which means sending all the VLAN data over the same wire and port, but giving the NICs a field (the P/Q tag) to control access. On paper, it looks something like this:
</p>


<div id="orgcfccc47" class="figure">
<p><img src="images/vlan-trunking.jpeg" alt="vlan-trunking.jpeg" />
</p>
</div>

<p>
As you can see in the modified P/Q frame, the following fields replace part of the frame:
</p>

<ul class="org-ul">
<li>Sixteen bits of tags or a protocol ID.</li>

<li>Three bits representing a priority.</li>

<li>One bit is used as a Canonical Format Indicator (CFI), which is 0 if the following VLAN ID is in Ethernet format, or 1 if it’s in Token Ring format.</li>

<li>Twelve bits of VLAN ID.</li>
</ul>

<p>
This matters when we’re building complex networks with lots of VLANS that probably cross over switches. After all, VLANs were initially controlled with ports and switches, although they more commonly use tags now. When more than one VLAN spans multiple switches, frames need to carry VLAN information that can be used by switches to sort or “trunk” the traffic.
</p>
</div>

<ul class="org-ul">
<li><a id="orga289ca7"></a>The origin of “trunking”<br />
<div class="outline-text-8" id="text-orga289ca7">
<p>
The word “trunking” is derived from the telephone network term trunk lines, which are lines connecting switchboards.
</p>

<p>
In the original telephone company model, each telephone had a subscriber line, which was a wire that went straight from the local Central Office (CO) to that subscriber’s telephone. Each CO had one switchboard, though it might have many seats.
</p>

<p>
Connections between Central Offices were handled by trunk lines, because they ran between phone company facilities. You’d have a thick cable with lots of pairs running from CO to CO, basically enough wires to handle something like 35% of the possible calls. If you ever got the message, “All circuits are busy now; please try your call again later”, you’ve heard what happens when the system is “trunking above capacity” or “TAC’d”, as it was called.
</p>

<p>
At the CO, the wires would “branch” and run all over the place: First to junction points (those five-foot-tall boxes you see from time to time on the road), then to interface points (the square cans beside the road every half mile or so, also called “pedestals”) and from there to subscriber homes. When you draw out this network, it looks like a tree, where the bundles of cables between COs look like the trunks of trees.
</p>
</div>
</li>

<li><a id="org576d95a"></a>Multiplexing LAN channels, actually<br />
<div class="outline-text-8" id="text-org576d95a">
<p>
With VLAN trunking, by the way, we’re not just multiplexing packets, we’re actually multiplexing LAN channels, so to speak.
</p>

<p>
In the parlance of networks, especially VLANs, the term “trunking” is used to indicate the sharing of network routes. This sharing is made possible by the Ethernet VLAN tags, which make the VLAN-bound messages less dependent on switches and routers to get the traffic to the right place. Otherwise, you’d have to designate complicated port configurations for switches, which is particularly easy to misconfigure.
</p>

<p>
Note that the MAC sub-layer is responsible for managing CDMA/CD, that is, detecting a clear line, initiating re-transmission if there’s a jam signal, etc. On the way in, the MAC sub-layer verifies the CRC/FCS and removes frame elements before passing the data up to the higher layers. Basically, anything that some other MAC layer did to encapsulate the message for sending, the receiving MAC layer un-does on the way in.
</p>
</div>
</li>

<li><a id="orgcbd6a2d"></a>VLANs, subnets, and fabrics<br />
<div class="outline-text-8" id="text-orgcbd6a2d">
<p>
When working with networks, you will frequently be concerned with VLANs, subnets, and fabrics, which are all network groupings:
</p>

<ul class="org-ul">
<li>Subnets define (group) a range of IP addresses.</li>

<li>VLANs group subnets.</li>

<li>Fabrics group VLANs.</li>
</ul>

<p>
Let’s give each of these terms their due.
</p>
</div>

<ul class="org-ul">
<li><a id="org738384c"></a>Subnets<br />
<div class="outline-text-9" id="text-org738384c">
<p>
A subnet is a range or collection of IP addresses. A subnet just means “sub-network,” and that’s exactly what it is: a subset of IP addresses that can be treated like a single block for some operations.
</p>

<p>
Subnets are defined in CIDR (Classless Inter-Domain Routing) notation. If you want to use the addresses from 192.168.13.0 to 192.168.13.255 in a subnet, you can specify that with 192.168.13.0/24. The “24” refers to the number of bits in the subnet address, with the remainder out of 32 bits free to address hosts. Since 8 bits can represent 256 things, that means /24 gives you the last octet, or 255 host IP addresses.
</p>

<p>
Whatever happened to subnet classes? Subnets used to be defined in terms of subnet classes, like A, B, and C. That got to be a limitation, because those three classes define a fixed number of bits of the IP address that represent the split between subnet addresses and host addresses. In other words, the class defined how many hosts could be in the network, and three classes wasn’t really adequate to address all the possible permutations that network architects needed. The change to CIDR notation made subnets more granular, allowing many more subnets from the same network.
</p>
</div>
</li>

<li><a id="orgca5a327"></a>VLANs<br />
<div class="outline-text-9" id="text-orgca5a327">
<p>
A VLAN used to be a series of IP addresses that could access a given port on a specific switch, generally the switch that gated some protected resource. With the advent of VLAN trunking (see above), VLANs are marked with the 802.1Q (P/Q) bits in the MAC frame. In theory, any set of addresses can be associated with any VLAN.
</p>

<p>
Let me strongly encourage a correspondence of subnets to VLANs. Every IP should be in exactly one subnet, and every subnet should be part of exactly one VLAN. You don’t have to do that: you could, for example, have two different subnets that overlap, like 192.168.43.0/24 and 192.168.43.0/26. The “.26” subnet would use fewer bits for the host addresses, so only some of the addresses would overlap. A decent network designer generally avoids this kind of address overlap.
</p>

<p>
Likewise, putting one subnet in two different VLANs might be possible, but it isn’t practical or easy to debug when conflicts happen. You should endeavour to enforce a clean “fan-out” across the network, with no possibility of conflicting IP addresses.
</p>
</div>
</li>

<li><a id="org10fbbf8"></a>Fabrics<br />
<div class="outline-text-9" id="text-org10fbbf8">
<p>
A fabric just collects VLANs together. If you stick to the clean fan-out, that also means that a fabric collects subnets. A fabric provides a higher level grouping.
</p>

<p>
Consider an example: Suppose you have one VLAN for HR, and one VLAN for payroll, so that nobody else can see HR’s private files, and likewise you’ve got payroll data limited to just those people who should see it.
</p>

<p>
Some executives are entitled to see anything and everything about the corporation. An “executive” fabric would group all VLANs together, so that people admitted to that fabric can access the VLANs without having to be explicitly added to each one. That’s very handy in really large organisations, saving a lot of time and effort.
</p>
</div>
</li>
</ul>
</li>
</ul>
</li>

<li><a id="org58520d5"></a>Visualising the link layer<br />
<div class="outline-text-7" id="text-org58520d5">
<p>
Let’s start with a message coming on Layer 1 from SanDiego to Bangor. When the message comes in, the link layer does the following things:
</p>

<ul class="org-ul">
<li>It synchronises the NIC, so that bits will indeed be recognised as bits and the message can be properly decoded.</li>

<li>It handles the source and destination addresses, using ARP as necessary.</li>

<li>It interprets the length/type bytes and uses them, which means it must judge the length of a frame, and of the data in a frame, or, alternatively, decide whether a frame is IPv4, ARP, or VLAN (“q-tagged”).</li>

<li>It processes VLAN tags, which means, at the very least, dealing with the message priority, deciding whether the VLAN frame is Ethernet or Token Ring, and capturing and using the VLAN ID. The layer handles messages by priority, knows how and when to send Ethernet or Token Ring frames, and knows how to route traffic to a specific VLAN.</li>

<li>It computes the checksum to make sure the message is valid.</li>
</ul>

<p>
Next, we’ll take a look at the network layer, where most of the message transactions take place, and where most of our debugging will be done.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org4d422c0" class="outline-6">
<h6 id="org4d422c0">Interlayer addressing: ARP</h6>
<div class="outline-text-6" id="text-org4d422c0">
<p>
One frequently asked question is this: Is ARP a layer 2 or layer 3 protocol? Actually, it’s both, as you’ll discover later, but it does all of its work at L2. One way to distinguish L2 from L3 is to find out what happens inside the firmware of the Network Interface Card (NIC), and that’s usually where ARP takes place. ARP maps MAC addresses, which is how things are addressed in L2, into other addresses (e.g., IP addresses), which is how L3 finds things.
</p>

<p>
In theory, every NIC card in the world has a unique identifier, called a <i>MAC address</i>. “MAC” stands for “Media Access Control” – you can find a little history of this on Wikipedia, if you’re interested.
</p>

<p>
When you’re assigning MAC addresses with virtual machines, of course, you may be re-using one that’s actually assigned to a network device out there somewhere. Inside your Layer 2 network, that isn’t a problem, because only devices connected to a physical switch – that’s actually connected to the physical Internet – care about unique MAC addresses. Inside your network, the only conflicts you need to worry about are the ones you create by hand-assigning MAC addresses.
</p>

<p>
The shorter answer to that implied question is this: MAC addresses must be unique across the domain where they’re used.
</p>
</div>

<ul class="org-ul">
<li><a id="org8dcaaf8"></a>TCP/IP does not use MAC addresses<br />
<div class="outline-text-7" id="text-org8dcaaf8">
<p>
If we look at the IP datagram again, we see that it doesn’t know about MAC addresses at all:
</p>

<p>
TCP, UDP, and a number of other protocol stacks are written to use IP addresses. Routers depend on IP addresses, as we’ve already seen. This creates a bit of a conundrum: How do we map between MAC and IP addresses, and what does the mapping? Is it a layer 2 or layer 3 operation?
</p>

<p>
The first thing to remember is that the MAC address is “ROM-burned” into the NIC card. IP addresses, on the other hand, are assigned to a NIC by a DHCP server or an administrator. This intentional separation of addressing schemes is what makes the Internet flexible.
</p>
</div>
</li>

<li><a id="org17a3ab3"></a>Fixed versus assigned addressing<br />
<div class="outline-text-7" id="text-org17a3ab3">
<p>
Here’s an analogy. Your postal address doesn’t <i>actually</i> define where your house is located. There are two layers of other addressing schemes that are actually used by government organisations, like your county tax assessor or the local air ambulance company.
</p>

<p>
One is your land survey location. Depending on where you live, this is defined by a series of coordinates that go something like this: county, township, section, plat, lot, etc. If you’ve ever looked at your property tax bill, it will have your postal address on it, but it will not actually use your postal address to define the taxable property. Instead, it uses this unique set of (rather obscure) coordinates to place you exactly on land survey maps.
</p>

<p>
But that’s not good enough for the air ambulance, for two reasons. First, the survey maps are huge, complex, and hard to interpret, and they change somewhat as property is bought or sold. Second, helicopter navigation is intentionally independent of political boundaries. Instead, the air ambulance will use your latitude and longitude, which allows them to uniquely locate you on the earth. Granted, the ambulance company has a tool somewhere that automatically does the maths of translating your postal address to lat/long coordinates, but the principle holds.
</p>

<p>
In terms of your local network, each of these “address levels” applies. Your postal address corresponds to the IP address of a machine. That IP address may or may not be unique, depending on the domain. For example, you can use Google Maps to try and locate something like “20 Main Street”, and you’ll get a really long list of responses that vary by city.
</p>

<p>
Likewise, there are probably hundreds of thousands of local networks using addresses in the “192.168…” subnet, since it’s so common for local IP addressing. As mentioned above, routers at the network layer take care of protecting these unique local addresses when going out on the Internet. On the other hand, your NIC’s MAC address is like the GPS lat/long coordinates; it’s unique across the entire world.
</p>

<p>
What about the analogue of survey maps? Well, it’s not hard to argue that these are more like the MAC addresses that you assign to your VMs. Every county in a state like, say, Mississippi has the coordinates Township 1, Section 1, Parcel 1 – but the outer domain (the county) makes those coordinates unique. Granted, we don’t use a different format for MAC addresses for VMs than we do for Internet-connected NICs, but you get the idea.
</p>
</div>
</li>

<li><a id="org0747602"></a>Address resolution<br />
<div class="outline-text-7" id="text-org0747602">
<p>
Address resolution is what we call the process of mapping between IP addresses and MAC addresses. It’s done with something called ARP, which stands for “Address Resolution Protocol”. Oddly enough, ARP takes on a life of its own, so you may hear it discussed in unusual ways. Some people call it “the ARP”, others speak of “arpd” (the ARP daemon), although if you look at the man page for arpd, you’ll see those characterisations are not precisely correct.
</p>

<p>
A frequent question is, “Where does ARP take place?” Maybe the better question is, “Where is ARP implemented?” As always with Internet-related things, the answer can vary, but normally, ARP is implemented as part of the embedded code in the NIC. Technically, this means that ARP operates at Layer 2. More often, you’ll see vendors hedge their bets on this, with phrases such as “operates below the Network Layer”, as in this explanation.
</p>

<p>
In reality, in order to work correctly, ARP has to map IP and MAC addresses, since the ARP message looks something like this:
</p>

<p>
To better understand, let’s walk an ARP call. It begins in say, a Web browser, when the browser makes a call to parse the URL. In most cases, that URL contains a hostname (not an IP address), so the following sort of dance takes place:
</p>

<p>
We won’t go into this in much detail now, just know that the browser is able to gather an IP address, if it exists. To make the walk-through less confusing, let’s assume that we’re looking for a host with IP 192.168.17.4.
</p>

<p>
Next, the browser requests a connection with 192.168.17.4, using the TCP protocol, which sends a connection request, as an IP packet, to 192.168.17.4. Along the way, there is probably more than one router hop.
</p>

<p>
ARP sends a broadcast request to everything on the relevant subnet. This request looks like the ARP message above, but it’s encoded as a MAC frame, which helps to answer the often-fuzzy question, “Is ARP Layer 2 or Layer 3?” As you see, this is an L2 message. Incidentally, ARP only works as a broadcast, by the way; that is, it only works on a broadcast network.
</p>

<p>
A very important note for some systems like MAAS: ARP requests don’t typically span VLANs.
</p>

<p>
Essentially, this ARP message contains the IP address 192.168.17.4, but no corresponding MAC address in the message. This tells the owner of 192.168.17.4 that it should reply with a similar ARP message, including its MAC address. When the sender receives the ARP reply, it can send the datagram directly to the destination host, embedded in an Ethernet frame, using the MAC address.
</p>

<p>
By the way, for efficiency, the sending host and the intermediate routers are all doing ARP caching. They copy down the mapping between IP and MAC addresses, holding onto it for about twenty minutes. In terms of most network transactions, twenty minutes is an eternity.
</p>
</div>
</li>

<li><a id="org16f9c55"></a>Messages are sent to MAC addresses<br />
<div class="outline-text-7" id="text-org16f9c55">
<p>
We often speak of TCP/IP as if messages are sent from one IP address to another, but that’s actually not strictly true. Messages are sent to MAC addresses. IP addresses are only used to get MAC addresses, so the message can go through.
</p>

<p>
We can return to the air ambulance company to see a practical analogy. A 911 call comes in for “20 Main Street, Yourtown, Yourstate, Yourpostalcode”. The address is sent to the pilot of the helicopter, who punches the address into his GPS. The GPS uses the postal address to retrieve the lat/long coordinates, which are then used to guide the helicopter, via satellite navigation.
</p>

<p>
The same sort of thing happens when you use the GPS navigator in your car. The navigator is translating a logical (postal) address to a physical (lat/long) address on the surface of the earth, calculating a route, and translating that route back to logical landmarks (street names) to let you know how to get there.
</p>

<p>
By the way, You should also note that ARP only works with IPv4. Certain other protocols, like Point-to-Point Protocol (PPP), don’t make use of ARP at all.
</p>
</div>
</li>

<li><a id="orga85fee0"></a>The ARP frame<br />
<div class="outline-text-7" id="text-orga85fee0">
<p>
ARP sends requests as an Ethernet frame, using the MAC address. If you remember the MAC frame from earlier:
</p>

<p>
The ARP frame is just a special case of the MAC frame, replacing everything the DSAP, SSAP, control bits, and data with the ARP message shown above. The resulting ARP frame looks something like this:
</p>

<p>
Based on the above diagram, you can see how the ARP request fits into the Ethernet frame to make an ARP frame.
</p>
</div>
</li>

<li><a id="org0776c3d"></a>The ARP cache<br />
<div class="outline-text-7" id="text-org0776c3d">
<p>
Let’s take a look at the ARP cache on a local system, <code>cloudburst</code>. We can do that like this:
</p>

<p>
<textarea cols="80" rows="37">
stormrider@cloudburst:~$ arp
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.1.24             ether   0c:8b:7d:f1:51:d3   C                     wlo1
10.250.204.17                    (incomplete)                              mpqemubr0
192.168.1.24             ether   0c:8b:7d:f1:51:d3   C                     enx606d3c645a57
192.168.117.16                   (incomplete)                              virbr0
#+END_SRC bash

The columns are mostly obvious, but just in case:

- Address: the IP address that’s been cached.
- HWtype: the Hardware Type field, which is blank when there’s no MAC address (as is the case in a number of these entries).
- HWaddress: the MAC address of the device. The “incomplete” entries are meant to indicate that an ARP request was sent for that address, but no response was received.
- Flags Mask: this field can have three values: “C” indicates that ARP learned this on its own, based on ARP responses; “M” means that the data was manually entered in the ARP table by a user; and “P” means “Publish,” which just tells the host how to respond to incoming ARP packets.
- Iface: the interface name.

In this case, ~virbr0~ and ~mpqemubr0~ are virtual bridges used for different sets of libvirsh VMs that haven’t been used for anything in a while. Also note that something called ~lxdbr0~, which is an LXD bridge, doesn’t even show up.

Let’s see if we can influence that. First, let’s take a look using ~ip a~:

#+ATTR_HTML: :textarea t :width 80
#+BEGIN_SRC bash
stormrider@cloudburst:~$ ip a show up
5: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:d6:70:6c brd ff:ff:ff:ff:ff:ff
    inet 192.168.117.1/24 brd 192.168.117.255 scope global virbr0
       valid_lft forever preferred_lft forever
6: mpqemubr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:84:0a:4c brd ff:ff:ff:ff:ff:ff
    inet 10.250.204.1/24 brd 10.250.204.255 scope global mpqemubr0
       valid_lft forever preferred_lft forever
7: lxdbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 00:16:3e:e4:2b:fe brd ff:ff:ff:ff:ff:ff
    inet 10.90.195.1/24 scope global lxdbr0
       valid_lft forever preferred_lft forever
    inet6 fd42:1fc6:f588:d0b8::1/64 scope global 
       valid_lft forever preferred_lft forever</textarea>
</p>

<p>
You’ll see that all three bridges are in a DOWN state, and again, <code>lxdbr0</code> is so cold that it doesn’t even show up in the ARP table. Let’s bring up a LXD VM connected to <code>lxdbr0</code> and look at the ARP table again:
</p>

<p>
<textarea cols="80" rows="7">
stormrider@cloudburst:~$ arp
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.1.24             ether   0c:8b:7d:f1:51:d3   C                     wlo1
10.250.204.17                    (incomplete)                              mpqemubr0
192.168.1.24             ether   0c:8b:7d:f1:51:d3   C                     enx606d3c645a57
192.168.117.16                   (incomplete)                              virbr0
10.90.195.16             ether   00:16:3e:fc:71:98   C                     lxdbr0</textarea>
</p>

<p>
Note that the <code>lxdbr0</code> bridge now shows up and has a MAC address, too – no incomplete entry here. If we look at the MAC address of <code>lxdbr0</code> in the <code>ip</code> listing, we’ll see it matches up.
</p>

<p>
Those “(incomplete)” entries are old. They’ve been cached, but no traffic has passed through those bridges in a really long time. The cache is just persistent in holding onto the IP addresses, but not the MAC addresses (since they could be stale). We can prove this to ourselves by clearing the cache:
</p>

<p>
<textarea cols="80" rows="5">
stormrider@cloudburst:~$ sudo ip -s neigh flush all
[sudo] password for stormrider: 

*Round 1, deleting 18 entries ***
*Flush is complete after 1 round ***</textarea>
</p>

<p>
…and rebuilding the ARP table:
</p>

<p>
<textarea cols="80" rows="5">
stormrider@cloudburst:~$ arp
Address                  HWtype  HWaddress           Flags Mask            Iface
192.168.1.24             ether   0c:8b:7d:f1:51:d3   C                     wlo1
192.168.1.24             ether   0c:8b:7d:f1:51:d3   C                     enx606d3c645a57
10.90.195.16             ether   00:16:3e:fc:71:98   C                     lxdbr0</textarea>
</p>
</div>
</li>

<li><a id="org2c1d6e4"></a>More about ARP<br />
<div class="outline-text-7" id="text-org2c1d6e4">
<p>
Another form of ARP is promiscuous ARP, in which some proxy host pretends to be the destination host and provides an ARP response on behalf of the actual destination host. You shouldn’t use this form of ARP unless there’s no other choice. You can Google it (and use it at your own risk), but it won’t be described here.
</p>

<p>
There is also gratuitous ARP, when the source and destination IP addresses are the same. This can be used for at least two purposes:
</p>

<ol class="org-ol">
<li>To find out if someone else already has the source machine’s IPv4 address, a technique called Address Conflict Detection by some references.</li>

<li>To update the source machine’s new MAC address (e.g., a new NIC card was installed) in upstream ARP cache entries. This is something akin to pre-caching MAC addresses before they’re actually needed.</li>
</ol>

<p>
You can read more about these (and many more) nuances of ARP, but this introduction should answer most of the immediate questions.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgcbe22b1" class="outline-6">
<h6 id="orgcbe22b1">The network layer</h6>
<div class="outline-text-6" id="text-orgcbe22b1">
<p>
You might have noticed in the original OSI model that “IP” was part of Layer 3, and protocol stacks like UDP and TCP were part of Layer 4. It’s a little bit confusing that we say “TCP/IP” when the “IP” really applies to so many other protocols like UDP and ICMP. There are certainly other protocols and protocol stacks, but for the purposes of these networks, we’re talking almost exclusively about TCP/IP.
</p>

<p>
The network layer does not guarantee delivery. Essentially, it makes every effort to deliver IP datagrams (packets) to the destination, but it’s error-handling is pretty simple: just toss the packet into the bit-bucket.
</p>

<p>
It’s also a connectionless layer, meaning the packets making up a message aren’t part of an ongoing conversation. They can be split up, encoded, and sent separately, by different routes, and arrive completely out of order. And packets can get duplicated or corrupted. Figuring all this out is the job of the protocol stack (e.g., TCP) in layer 4. The network layer, L3, just delivers packets.
</p>

<p>
Network byte order: A rarely needed (but useful) fact is that the network sends bytes in big endian order. That means bytes are transmitted starting with bit 0 and working down to bit 31, usually eight bits at a time. A lot of the computers on the Internet use little endian encoding, which starts at the other end of the word. In those cases, the byte order has to be reversed somewhere between the computer’s memory and Layer 3. For most situations, that fact isn’t particularly useful, but there is the occasional fault that involves failure to reverse byte order along the path from RAM to NIC.
</p>
</div>

<ul class="org-ul">
<li><a id="org26168be"></a>What is this "packets" you speak of, Kimosabe?<br />
<div class="outline-text-7" id="text-org26168be">
<p>
Packets are basic Internet Protocol (IP) message units. A message will probably be split into multiple packets by L4 (the transport layer) so it can be efficiently sent.
</p>

<p>
For example, imagine that you’re sending a very long letter to your friend, and all you have are lots of envelopes and first-class stamps. If you’ve ever done a lot of mailing, you’ll know that mailing a one-ounce letter costs you, say, fifty-eight cents. If you add another ounce of paper to it, that second ounce only costs you, say, twenty cents. But all you have are first class (i.e., fifty-eight-cent) stamps.
</p>

<p>
If you don’t want to waste your money, you can either cram more pages in the envelope, until you’re at three ounces (the most you can get with two stamps), or send two letters, each with one ounce in it. The way envelopes go through the mailing system, you’re better off not over-stuffing an envelope. So what do you do?
</p>

<p>
You sit down and write the letter to your friend, carefully numbering the pages. Then you divide it into piles of pages that are just under one ounce. Finally, you put each pile into an addressed, stamped envelope and mail each letter separately. When your friend gets the letters, it doesn’t matter which one gets there first, because they can reassemble your message, using the page numbers.
</p>
</div>
</li>

<li><a id="orgfa324df"></a>Fixed packet lengths and segmented messaging<br />
<div class="outline-text-7" id="text-orgfa324df">
<p>
We could have designed computer networks to take messages of indeterminate lengths, but that presents some unique challenges when trying to manage network traffic. For example, suppose you send seven overstuffed letters to your friend, and so does everyone else on your block? All these huge letters aren’t going to fit in one letter-carrier’s bag, so they’ll have to either send out two delivery people, or wait until tomorrow to send out someone’s letters.
</p>

<p>
Choosing a fixed (relatively short) length makes it statistically possible for everyone’s letters (everyone’s messages) to be delivered at a fairly constant, reliable rate. That rate will vary with the size of the overall message, not with who threw their message on the Internet first. A larger message takes longer to send.
</p>

<p>
Messages are split into packets of consistent length before they’re passed to L3, so larger messages take longer. It’s statistically more efficient to split messages into equally-sized packets than any other arrangement – the method that gets the highest count of complete messages through the network in a given amount of time. In network terminology, it’s the highest-throughput approach to network traffic. Specifically, this technique is called multiplexing.
</p>
</div>
</li>

<li><a id="orgfdb148e"></a>IP packets<br />
<div class="outline-text-7" id="text-orgfdb148e">
<p>
The IP datagram (packet) is the backbone of most modern networks. The following diagram depicts an IPv4 header, which attaches to the front of data packets up to about 65K long:
</p>


<div id="orgf0a1865" class="figure">
<p><img src="images/ip-packets.jpeg" alt="ip-packets.jpeg" />
</p>
</div>

<p>
Note that IPv6 headers have only the version field in common with IPv4 headers; otherwise, they are completely different. Here are the header fields and what information they carry:
</p>

<ul class="org-ul">
<li>IP Protocol Version: This is “4” for IPv4 and “6” for IPv6. There are lots of others, but they generally don’t touch a typical network.</li>
<li>Internet Header Length: The number of 32-bit words in the header, including the options (but not including the data, since it’s just the header). Most of the time, this will have the value “5”, but options do exist and are sometimes included.</li>
<li>Differentiated Services Code Point: This is used to specify special classes of service. Normally, IP packets are delivered on a “best-effort” basis, that is, Layer 3 will try everything possible to make sure a packet gets delivered. You can cause L3 to deliver packets with higher priority (implying more certainty) by using a different DSCP.</li>
<li>ECN = Explicit Congestion Notification: These bits are both set by an ECN-capable router when that router is above a certain traffic threshold. They are there to alert a sender to slow down (or expect delays) when the network segment in use is particularly congested.</li>
<li>Total Length of IP Packet: This field indicates the length of the entire packet, including the data. This makes it possible to calculate the byte offset of the data within the datagram.</li>
<li>Identification: This is a serial number, generated by the sending NIC, that helps the participants uniquely identify the datagram. In a sense, it works like the little “take-a-number” tickets you get at the hamburger stand: Eventually, the number will repeat, but the repeat cycle is so long that there’s no chance of confusing packets. The sequential nature of this field, when used in concert with the Flags and Fragmentation Offset field, helps the protocol stack correctly reassemble the message.</li>
<li>Flags: This field is basically used to indicate that a packet is a fragment of a longer message.</li>
<li>Fragmentation Offset: Used with the Identification sequence number, this field allows the system to know which packets precede or follow this one when re-assembling the message.</li>
<li>Time to Live (TTL): This indicates the number of routers that a datagram can pass through before it’s discarded. Since routers function by replacing their own destination address with the IP address of the next hop, this essentially limits the number of times a packet’s destination IP can be changed. Most RFC documents suggest keeping this number at 64, it’s more often set to something like 255 without any real bottlenecks.</li>
<li>Protocol: This field indicates the higher level protocol (the protocol stack) that generated this message. Examples are given for TCP and UDP in the figure.</li>
<li>Header Checksum: This calculates a checksum for the header only. It’s only used in IPv4. Doing integrity-checking on the data is the responsibility of Layer 4.</li>
<li>Source Address: This is the IP address of the sender of the packet, for this hop only. As shown in the figure below, routers will change this address so they can get the answer back.</li>
<li>Destination Address: This is the IP address of the destination, for this hop only. As shown below, routers change this address to act as brokers in the IP chain.</li>
</ul>
</div>
</li>

<li><a id="org004793a"></a>Routing<br />
<div class="outline-text-7" id="text-org004793a">
<p>
We now have enough concepts in play to talk about routing. Routing takes place at the network layer, by changing the source and destination addresses (without losing track of the replaced address). The process looks something like this:
</p>


<div id="org277661e" class="figure">
<p><img src="images/routing.jpeg" alt="routing.jpeg" />
</p>
</div>

<p>
The router typically assigns a unique port number to the outbound message, and records the source IP against that port number. When the message comes back to it on that port number, it can look up the IP address of the NIC that sent the packet and route the answer back.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orga2172b7" class="outline-6">
<h6 id="orga2172b7">The transport layer</h6>
<div class="outline-text-6" id="text-orga2172b7">
<p>
Layer 4 brings us to protocols implemented only by the end hosts (i.e., not by the routers or other switching gear that connect the network). This layer handles things like redundancy, confirmed delivery, managing packets on an unreliable network, and so forth. This is the last layer that TCP/IP has anything to say about; layers above this are unique to specific applications. Troubleshooting this level would involve knowing about entire protocol sets, like UDP or TCP.
</p>

<p>
If the Internet Protocol (IP) is connectionless, the transport layer is all about connections. The transport-layer protocol in use – we’ll talk exclusively about Transmission Control Protocol or TCP here – the L4 protocol is the last place in the stack where the entire message exists in one piece. L4 breaks up larger messages into segments. Each segment gets a TCP header, and gets passed on to L3 where it becomes an IP packet.
</p>
</div>
</div>

<div id="outline-container-orgc612ba2" class="outline-6">
<h6 id="orgc612ba2">TCP: Transmission Control Protocol</h6>
<div class="outline-text-6" id="text-orgc612ba2">
<p>
I mentioned above the Layer 4 is all about connections, but the situation's not always that simple.  UDP, for example does not have any mechanisms for delivering data reliably. I have a t-shirt that says, "I'd tell you a joke about UDP, but you might not get it."  The pun turns on the fact that UDP is sort of a <i>fire and forget</i> protocol.
</p>

<p>
The problem of making sure the message got delivered is as old as time.  There are many logic problems that involve an army sending a message between battalions, indicating the time of a planned attack.  But if the messenger has to sneak through enemy lines to deliver it, how do we know it got there?  Error-correcting codes help, but at the end of the day, nothing beats the Automatic Repeat Request, cleverly abbreviated <b>ARQ</b>.
</p>

<p>
ARQ simply means we keep sending the message until we know for sure it got there, intact.  We need two mechanisms in order to make this work: an ACK (I got the message) and a CRC (Cyclic Redundancy Check).  If the message gets there, and it passes the CRC, an ACK is sent.
</p>

<p>
Returning to the sneaky messenger, what if the messenger got there and delivered the message, but didn't get back to tell the sender that the message got through?  That's a more complicated problem.  In the networking world, we deal with that by waiting a set amount of time for an ACK before re-sending: The recipient has to know how to deal with duplicate messages.
</p>

<p>
How long do we want?  That's a really complex topic called "timeout and re-transmission", and I'm going to skip over that here.  You can find a lot of great sources in Google that will help you with that.
</p>

<p>
The most important things to take away from timeouts, though, are that (1) messages may arrive out of order, so the ACK signal needs to be tagged with the ID of the message received, and (2) the recipient has to be able to reassemble the messages in the correct order.
</p>

<p>
Oh, and there has to be a limit on how many unacknowledged messages a sender is willing to leave hanging.  If the sender sends three messages and gets no ACKs, it might not send out sequence number four until the other end catches up.  This number of outstanding, unacknowledged messages is called a "sliding window".  If the sliding window is three messages, and number four hasn't been acknowledged, number 8 won't be sent yet.
</p>

<p>
Sometimes it helps to think of it like jelly beans in a jar with a small opening; only three or four jelly beans can pop through the mouth of the jar at any given time &#x2013; the rest will have to wait.  One falls out, another one gets to the edge of the jar, and the whole muddle of beans moves one bean closer to freedom.  Okay, weird, but it does help sometimes.
</p>

<p>
The simplest way to envision how it works, is, well, to actually look at how it works, hence the next section on the TCP header.
</p>
</div>

<ul class="org-ul">
<li><a id="org90f83a9"></a>The TCP header<br />
<div class="outline-text-7" id="text-org90f83a9">
<p>
Here’s a diagram of the L4-to-L3 hand-off:
</p>


<div id="orgbaeb173" class="figure">
<p><img src="images/tcp-header.jpeg" alt="tcp-header.jpeg" />
</p>
</div>

<p>
We can get a pretty good idea what happens at Layer 4 just by decoding the contents of the TCP header. It contains the following fields:
</p>

<ul class="org-ul">
<li>Source port: the application port number of the host sending the data. For example, if this is an FTP message, the source port would probably be 21.</li>

<li>Destination port: the port number of the application requested on the destination host. If this is FTP, again this port would likely be 21.</li>

<li>Sequence number: the sequence number of this segment of data, to help the other end put the data back together in the correct order, as well as help Level 4 on the receiving end know whether a packet’s been dropped or lost.  This handles the fact that segments don't necessarily arrive in order.</li>

<li>Acknowledgement number: essentially, the next sequence number the destination host is expecting; used to “gate” packets through the connection. This is a smart way to ACK packets so that the recipient knows which messages have been received.</li>

<li>TCP header length: given to know where the data begins.</li>

<li>Reserved: reserved for future use, basically; currently always set to 0.</li>

<li>Code bits: essentially a set of flags; see the list below.</li>

<li>Window: used to negotiate the “window” size, that is, how many bytes the destination host is willing to receive at once; this allows for the most efficient transmission possible, based on the characteristics of the two communicating hosts.  This is the sliding window that defines how many messages can be sent (but not acknowledged) before the sender pauses.  The "negotiable" part is what makes for efficient networks: the sender and receiver can quickly get to know each other and know how many messages they can "trust" to be delivered without an ACK.</li>

<li>Checksum (CRC): used to check the integrity of the segment.</li>

<li>Urgent pointer: data byte count where urgent data ends; used if the urgent flag is set (see below).</li>
</ul>

<p>
The code bits can indicate the following things:
</p>

<ul class="org-ul">
<li>URG: indicates that the urgent pointer field is meaningful, used to prioritise this message over other messages.</li>

<li>ACK: used to acknowledge successful delivery of the previous segment.</li>

<li>PSH: push notification; tells the receiving host the message is complete, you can push the data to the application.</li>

<li>RST: request a connection reset when the error level reaches a certain threshold; basically, “let’s try that again from the top.” This is considered an abnormal termination of the TCP connection.</li>

<li>SYN: used for a three-way TCP handshake; this handshake is how sender and receiver sync up; it serves a purpose similar to the preamble in a MAC frame, but at a different level of synchronisation.</li>

<li>FIN: we’re done, close the connection. This is considered a normal termination of a TCP connection.</li>

<li>NS/CWR/ECE: used to provide Explicit Congestion Notification; note that OSI provides several methods for endpoints to know that the network is congested.</li>
</ul>
</div>
</li>

<li><a id="org3a3e66a"></a>TCP is like a phone call<br />
<div class="outline-text-7" id="text-org3a3e66a">
<p>
As you can see from the bytes above, TCP is all about the state of a connection, which is basically the same as a phone call. When you pick up the receiver, you and the caller exchange information. You say “bye” when the call is over. If it’s a bad connection or one end suddenly gets noisy (think jack-hammers outside), one of you can reset the connection by saying, “Let me call you back in a minute.” Take a minute and try to see how the other header bytes fit this analogy.
</p>

<p>
Also like a telephone call, TCP provides a connection (the call, however long it lasts), flow control (provided by the two parties on the call), multiplexing (handled by the two handsets, basically letting through multiple frequencies and sounds, so that you can get the tone and breath sounds of the other person, not just their raw words). Likewise, the two parties try to handle the reliability of the connection by making sure you understand each other.
</p>

<p>
The analogy spreads a little because some of the items (connection, multiplexing) are handled by the telephone, and some are handled by the people operating the telephone (flow control, reliability). In the network, the Level 4 protocol stack handles it all.
</p>
</div>
</li>

<li><a id="org315936e"></a>There's a lot more here<br />
<div class="outline-text-7" id="text-org315936e">
<p>
There is a lot more to know about TCP, like:
</p>

<ul class="org-ul">
<li>Variable windows</li>
<li>Flow and congestion control</li>
<li>Reliability and the TCP service model</li>
<li>Encapsulation</li>
<li>Connection management</li>
<li>Etc.</li>
</ul>

<p>
You should now have enough basic knowledge to transition to the <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">excellent Wikipedia article about TCP</a>.  A word of warning, though: this rabbit hole is very deep, so weigh what you're learning with what you actually need to know from this point on.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org0e23dc2" class="outline-6">
<h6 id="org0e23dc2">The session layer</h6>
<div class="outline-text-6" id="text-org0e23dc2">
<p>
Layer 5, the session layer, is where ongoing interactions between applications happen. The data is couched in terms of things an application might understand (e.g., cookies for a Web browser). This is also the layer where check-pointing (i.e., saving work finished so far) happens. At this layer, we’d discuss things like RPC, SQL, or NetBIOS.
</p>
</div>
</div>

<div id="outline-container-org0fed121" class="outline-6">
<h6 id="org0fed121">The presentation layer</h6>
<div class="outline-text-6" id="text-org0fed121">
<p>
The presentation layer converts data between formats and ensures standard encodings are used to present the information to the application. This layer is all about file formats: ASCII, EBCDIC, JPEG, GIF, and HTML, to name just a few.
</p>
</div>
</div>

<div id="outline-container-org77b04b6" class="outline-6">
<h6 id="org77b04b6">The application layer</h6>
<div class="outline-text-6" id="text-org77b04b6">
<p>
The top layer, layer 7, is totally the province of the application(s) involved in processing messages. Two techs talking about this layer would be swapping stories about application protocols, like FTP, DNS, SMTP, or NFS. Almost nothing that happens at this layer – except for throughput estimates or fouled daemon code – filters into designing or debugging networks.
</p>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org8e002bb" class="outline-3">
<h3 id="org8e002bb">I build my own electronics</h3>
<div class="outline-text-3" id="text-org8e002bb">
</div>
<div id="outline-container-org6f44cf8" class="outline-4">
<h4 id="org6f44cf8">Altair 8800</h4>
<div class="outline-text-4" id="text-org6f44cf8">
<p>
I bought an Adwater &amp; Stir Altair 8800 kit.  It's the second one I've tried.  I'm trying to build it, very slowly, as a second fiddle to some ongoing home renovations.
</p>
</div>

<div id="outline-container-orgd7cf4f9" class="outline-5">
<h5 id="orgd7cf4f9">The first attempt</h5>
<div class="outline-text-5" id="text-orgd7cf4f9">
<p>
I etched and built my own circuit boards in high school, and built a HeathKit alarm clock which I used all the way through college.  I've also soldered at night, in a factory, for extra money.  And I earned degrees in Electrical and Computer Engineering, which included a lot of circuit work.
</p>

<p>
Given that background, I jumped in a little too deep and attempted to build my own Altair 8800 board.  The first attempt ran into trouble, since I underestimated the need for modern components, which have a different form-factor from the original parts.  My first board was too tight, resulting in components getting cracked trying to squeeze them into a space that was too small.
</p>
</div>
</div>

<div id="outline-container-orgffd73b9" class="outline-5">
<h5 id="orgffd73b9">Lessons learned</h5>
<div class="outline-text-5" id="text-orgffd73b9">
<p>
The Adwater &amp; Stir kit uses a piggyback Arduino Duo board, which is something I didn't initially consider.  Instead of cramming all the components onto one board (matching the case form factor), this kit uses the extra space provided by the depth of the original Altair case to layer the boards.  It's the only way to build out an Altair in the original form-factor with modern components.
</p>
</div>
</div>
<div id="outline-container-org1c3aa57" class="outline-5">
<h5 id="org1c3aa57">Early building steps</h5>
<div class="outline-text-5" id="text-org1c3aa57">
<p>
Here are a few pictures of early board-building on the Adwater &amp; Stir kit.
</p>

<p>
<img src="https://stormrider.io/images/altair-att1-1.jpg" alt="altair-att1-1.jpg" />
<img src="https://stormrider.io/images/altair-att1-2.jpg" alt="altair-att1-2.jpg" />
<img src="https://stormrider.io/images/altair-att1-3.jpg" alt="altair-att1-3.jpg" />
<img src="https://stormrider.io/images/altair-att1-4.jpg" alt="altair-att1-4.jpg" />
<img src="https://stormrider.io/images/altair-att1-5.jpg" alt="altair-att1-5.jpg" />
<img src="https://stormrider.io/images/altair-att1-6.jpg" alt="altair-att1-6.jpg" />
<img src="https://stormrider.io/images/altair-att1-7.jpg" alt="altair-att1-7.jpg" />
<img src="https://stormrider.io/images/altair-att1-8.jpg" alt="altair-att1-8.jpg" />
<img src="https://stormrider.io/images/altair-att1-9.jpg" alt="altair-att1-9.jpg" />
<img src="https://stormrider.io/images/altair-att1-10.jpg" alt="altair-att1-10.jpg" />
<img src="https://stormrider.io/images/altair-att1-11.jpg" alt="altair-att1-11.jpg" />
</p>
</div>
</div>
</div>
<div id="outline-container-org08d4119" class="outline-4">
<h4 id="org08d4119">rPi4</h4>
<div class="outline-text-4" id="text-org08d4119">
<p>
When I have time, and I want a break from the Altair project, I'm noodling with a  Raspberry Pi4 kit that I bought:
</p>


<div id="org4459723" class="figure">
<p><img src="https://stormrider.io/images/canakit-box.jpg" alt="canakit-box.jpg" />
</p>
</div>

<p>
rPi4 units have consistently been very expensive and hard to get, lately, but apparently a lot of these CanaKits either went unsold or the inventory issues haven't rippled yet.  Here are some unboxing photos, <i>kinda</i>, since I already put the Pi together and have it up and running.
</p>

<p>
I didn't spend a lot here &#x2013; less than $200, if that much.  All these things were bought online from bulk suppliers, so they're relatively easy to acquire:
</p>
</div>

<div id="outline-container-org36902b0" class="outline-5">
<h5 id="org36902b0">The rPi4 and a HackRF One SDR receiver</h5>
<div class="outline-text-5" id="text-org36902b0">
<p>
Here are the rPi4 and the HackRF One SDR receiver I bought separately.  They're  both built out and mounted on a yoga block (it's the cheapest form of non-conductive foam I can buy):
</p>


<div id="orgc712fc8" class="figure">
<p><img src="https://stormrider.io/images/pi4-assy+sdr-kit.jpg" alt="pi4-assy+sdr-kit.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgcc6845d" class="outline-5">
<h5 id="orgcc6845d">Breakout board and ribbon cable</h5>
<div class="outline-text-5" id="text-orgcc6845d">
<p>
This is a cool little starter board for pi projects that comes with the kit:
</p>


<div id="orgb8504f6" class="figure">
<p><img src="https://stormrider.io/images/breakout-board.jpg" alt="breakout-board.jpg" />
</p>
</div>

<p>
and it comes with a ribbon cable to match:
</p>


<div id="org583cb79" class="figure">
<p><img src="https://stormrider.io/images/breakout-cable.jpg" alt="breakout-cable.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org7ca19f5" class="outline-5">
<h5 id="org7ca19f5">Companion SDR kit</h5>
<div class="outline-text-5" id="text-org7ca19f5">
<p>
My first thing to attempt with my new rPi4 is kinda ambitious: SDR, or "software defined radio".  I bought this cool <a href="https://greatscottgadgets.com/hackrf/one/">HackRF One SDR board</a>, in my case, with just top and bottom plastic covers (instead of a metal case) so I could see &#x2013; and potentially mess around with &#x2013; the circuit board.  The board is already co-mounted with the rPi4 and connected to it:
</p>


<div id="org6c88ac6" class="figure">
<p><img src="https://stormrider.io/images/pi4-assy+sdr-kit.jpg" alt="pi4-assy+sdr-kit.jpg" />
</p>
</div>

<p>
I'm now in the process of learning how to use it, since it has a <a href="https://hackrf.readthedocs.io/en/latest/index.html">full suite of doc</a> and a <a href="https://github.com/greatscottgadgets/hackrf">robust github repository</a>, along with a forum and mailing list.  Now it's just up to me to get my head in there and take a look.
</p>

<p>
It also has some cool SDR antennas:
</p>


<div id="org5b800de" class="figure">
<p><img src="https://stormrider.io/images/sdr-antennas.jpg" alt="sdr-antennas.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org2335a73" class="outline-5">
<h5 id="org2335a73">Other useful project parts</h5>
<div class="outline-text-5" id="text-org2335a73">
<p>
There are a few additional project parts that come with the CanaKit.
</p>
</div>

<div id="outline-container-org03d2eb2" class="outline-6">
<h6 id="org03d2eb2">Boot media for the rPi:</h6>
<div class="outline-text-6" id="text-org03d2eb2">

<div id="org86f320d" class="figure">
<p><img src="https://stormrider.io/images/boot-media.jpg" alt="boot-media.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgd088ddc" class="outline-6">
<h6 id="orgd088ddc">Jumper wires for the rPi4:</h6>
<div class="outline-text-6" id="text-orgd088ddc">

<div id="org00088e6" class="figure">
<p><img src="https://stormrider.io/images/jumper-wires.jpg" alt="jumper-wires.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org1825cf3" class="outline-6">
<h6 id="org1825cf3">An on-off switch for the rPi4</h6>
<div class="outline-text-6" id="text-org1825cf3">

<div id="orgd3fde92" class="figure">
<p><img src="https://stormrider.io/images/pi-switch.jpg" alt="pi-switch.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgef11f0e" class="outline-6">
<h6 id="orgef11f0e">A small set of electronic components</h6>
<div class="outline-text-6" id="text-orgef11f0e">

<div id="org5e180cc" class="figure">
<p><img src="https://stormrider.io/images/boxed-components.jpg" alt="boxed-components.jpg" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org1033bd4" class="outline-5">
<h5 id="org1033bd4">Extra components</h5>
<div class="outline-text-5" id="text-org1033bd4">
<p>
And I also bought some extra components through a bulk supplier.
</p>
</div>

<div id="outline-container-orgbae3bc8" class="outline-6">
<h6 id="orgbae3bc8">Some small circuit boards</h6>
<div class="outline-text-6" id="text-orgbae3bc8">

<div id="org12405cc" class="figure">
<p><img src="https://stormrider.io/images/boards.jpg" alt="boards.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgacf70ec" class="outline-6">
<h6 id="orgacf70ec">Some assorted standard capacitors</h6>
<div class="outline-text-6" id="text-orgacf70ec">

<div id="org71d3418" class="figure">
<p><img src="https://stormrider.io/images/capacitors.jpg" alt="capacitors.jpg" />
</p>
</div>

<p>
<i>I bought some assorted electrolytics as part of the same buy, but don't think I nabbed a pic.</i>
</p>
</div>
</div>

<div id="outline-container-org3cc5240" class="outline-6">
<h6 id="org3cc5240">Some assorted diodes</h6>
<div class="outline-text-6" id="text-org3cc5240">

<div id="orgab8d52c" class="figure">
<p><img src="https://stormrider.io/images/diodes.jpg" alt="diodes.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org793722a" class="outline-6">
<h6 id="org793722a">A whole bunch of assorted LED in various sizes</h6>
<div class="outline-text-6" id="text-org793722a">

<div id="orgce811e9" class="figure">
<p><img src="https://stormrider.io/images/leds.jpg" alt="leds.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org3655b9b" class="outline-6">
<h6 id="org3655b9b">Assorted rheostats</h6>
<div class="outline-text-6" id="text-org3655b9b">

<div id="org7aecf22" class="figure">
<p><img src="https://stormrider.io/images/rheostats.jpg" alt="rheostats.jpg" />
</p>
</div>

<p>
AKA potentiometers, or variable resistors.
</p>
</div>
</div>

<div id="outline-container-orgb194ad8" class="outline-6">
<h6 id="orgb194ad8">A ton of assorted resistors</h6>
<div class="outline-text-6" id="text-orgb194ad8">

<div id="orgd37ac04" class="figure">
<p><img src="https://stormrider.io/images/std-resistors.jpg" alt="std-resistors.jpg" />
</p>
</div>

<p>
I was surprised by how many came in this bulk kit, on trees, no less.
</p>
</div>
</div>

<div id="outline-container-org259173e" class="outline-6">
<h6 id="org259173e">Various assorted transistors</h6>
<div class="outline-text-6" id="text-org259173e">

<div id="org997aef0" class="figure">
<p><img src="https://stormrider.io/images/transistors.jpg" alt="transistors.jpg" />
</p>
</div>
</div>
</div>

<div id="outline-container-org49f9545" class="outline-6">
<h6 id="org49f9545">And lastly, a metric ton of variable length wires</h6>
<div class="outline-text-6" id="text-org49f9545">

<div id="org57347a0" class="figure">
<p><img src="https://stormrider.io/images/wires.jpg" alt="wires.jpg" />
</p>
</div>

<p>
These are bent into U shapes for easy soldering, and insulated on the bridge of the "U".
</p>
</div>
</div>
</div>

<div id="outline-container-org1c32aec" class="outline-5">
<h5 id="org1c32aec">A lot can be had for a little</h5>
<div class="outline-text-5" id="text-org1c32aec">
<p>
I suppose since fewer people work directly with discrete components, the prices have dropped.  Anyway, now I have to actually <i>do</i> something with these!
</p>
</div>
</div>

<div id="outline-container-orgd34c535" class="outline-5">
<h5 id="orgd34c535">How I put the Pi together initially</h5>
<div class="outline-text-5" id="text-orgd34c535">
<p>
There was almost nothing to it; I had to:
</p>

<ol class="org-ol">
<li>Put the Pi board in the case (apparently important to do that first &#x2013; static?).</li>

<li>Peel and stick the heat sinks onto the chips that have a place for them.  I think there were two of them, but I forget.  It's obvious where they go.</li>

<li>I went ahead and hooked up the cooling fan.  If you do it wrong, the system won't come up in bootable configuration, but nothing will break.  I think I got it wrong the first time.</li>

<li>I had to insert the SD card (whatever it's called) to give it a system to boot.</li>
</ol>

<p>
That's it for the quick setup.  Of course I had to hook up a keyboard, mouse, HD monitor, and power.  I use a little 7-inch monitor that I share with the door-cam I use to know when my cat wants in and out of the house.  For a keyboard, I use one of those little roll-up silicon USB keyboards, and a wireless mouse.  Not too hard to set up, nor too shabby.  
</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
Copyright (C) 2020-2024 by stormrider.
All Rights Reserved
</div>
</body>
</html>